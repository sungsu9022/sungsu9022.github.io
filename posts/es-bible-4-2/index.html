<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="4. 데이터 다루기 -2" /><meta property="og:description" content="4. 데이터 다루기 -2" /><link rel="canonical" href="https://sungsu9022.github.io/posts/es-bible-4-2/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/es-bible-4-2/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-24T21:19:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2023-12-30T16:42:33+09:00","datePublished":"2023-12-24T21:19:00+09:00","description":"4. 데이터 다루기 -2","headline":"[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/es-bible-4-2/"},"url":"https://sungsu9022.github.io/posts/es-bible-4-2/"}</script><title>[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계) | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1703420340" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 24, 2023 </em> </span> <span> Updated <em class="" data-ts="1703922153" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 30, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4646 words"> <em>25 min</em> read</span></div></div></div><div class="post-content"><h1 id="4-데이터-다루기--2">4. 데이터 다루기 -2</h1><h2 id="44-집계"><span class="mr-2">4.4 집계</span><a href="#44-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>ES는 검색을 수행한 뒤에 그 결과를 집계(aggregation)하는 다양한 방법을 제공한다.</ul><h3 id="441-집계-기본"><span class="mr-2">4.4.1 집계 기본</span><a href="#441-집계-기본" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>집계는 검색의 연장선<li>집계의 대상을 추려낼 검색 조건을 검색 API에 담은 뒤 집계 조건을 추가해서 호출한다.</ul><h4 id="sum"><span class="mr-2">sum</span><a href="#sum" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>### sum
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "term": {
      "currency" : {
        "value": "EUR"
      }
    }
  },
  "aggs": {
    "my-sum-aggregation-name": {
      "sum" : {
        "field":"taxless_total_price"
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">4675</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"my-sum-aggregation-name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">350884.12890625</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>search API 요청 body에 “aggs”만 추가하고, size을 0으로 지정한 것을 확인할 수 있다.</ul><h4 id="집계-요청시-주의사항"><span class="mr-2">집계 요청시 주의사항</span><a href="#집계-요청시-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>size을 0으로 지정하면 검색에 상위 매칭된 문서가 무엇인지 받아볼 수 없다.<ul><li>매칭된 문서와 관계 없이 조건에 매치되는 모든 문서에 대한 집계 작업을 할 수 있다.<li>집계 요청에서는 매칭 문서를 볼 니즈가 없으므로 대부분 집계 요청에서는 size를 0으로 지정하는 것이 이득이다.</ul><li>요청 한번에 여러 집계를 요청할 수 있다.<ul><li>집계를 구분할 수 있는 이름을 붙여준다.(<code class="language-plaintext highlighter-rouge">my-sum-aggregation-name</code>)</ul><li>집계 작업은 검색 쿼리에 매칭된 모든 문서에 대해 수행하므로 과도한 양을 대상으로 집계를 수행할 경우 전체 클러스터 성능에 영향을 줄수 있다.<ul><li>키바나 대시보드같은 시각화도구에서도 발생할 수 있음.<li>통제되지 않은 사용자가 집계를 할 수 없도록 해야 한다.</ul></ul><h3 id="442-메트릭-집계"><span class="mr-2">4.4.2 메트릭 집계</span><a href="#442-메트릭-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>문서에 대한 산술적인 연산을 수행한다.</ul><h4 id="avg-max-min-sum-집계"><span class="mr-2">avg, max, min, sum 집계</span><a href="#avg-max-min-sum-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>평균, 최대값, 최소값, 합계 등을 집계할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>### avg
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "term": {
      "currency" : {
        "value": "EUR"
      }
    }
  },
  "aggs": {
    "my-avg-aggregation-name": {
      "avg" : {
        "field":"taxless_total_price"
      }
    }
  }
}
</pre></table></code></div></div><h4 id="stats-집계"><span class="mr-2">stats 집계</span><a href="#stats-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>지정한 필드의 평균, 최댓값, 최솟값, 합, 개수를 모두 계산해서 반환한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>### stats
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "term": {
      "currency" : {
        "value": "EUR"
      }
    }
  },
  "aggs": {
    "my-stats-aggregation-name": {
      "stats" : {
        "field":"taxless_total_price"
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">4675</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"my-stats-aggregation-name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">4675</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"min"</span><span class="p">:</span><span class="w"> </span><span class="mf">6.98828125</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"max"</span><span class="p">:</span><span class="w"> </span><span class="mf">2250.0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"avg"</span><span class="p">:</span><span class="w"> </span><span class="mf">75.05542864304813</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"sum"</span><span class="p">:</span><span class="w"> </span><span class="mf">350884.12890625</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>위와 같이 여러 숫자 값을 한꺼번에 반환하는 메트릭 집계를 다중 값 숫자 메트릭 집계(multi-value numeric metric aggregation)이라 한다.</ul><h4 id="cardinality-집계"><span class="mr-2">cardinality 집계</span><a href="#cardinality-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>cardinality 집계는 지정한 필드가 가진 고유한 값의 개수를 계산해 반환한다.<ul><li>이 값은 HyperLogLog++ 알고리즘을 사용해 추정한 근사값이다.</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>### cardinality
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "term": {
      "currency" : {
        "value": "EUR"
      }
    }
  },
  "aggs": {
    "my-cardinality-aggregation-name": {
      "cardinality" : {
        "field":"customer_id",
        "precision_threshold": 3000
      }
    }
  }
}
</pre></table></code></div></div><ul><li>precision_threshold 옵션은 정확도를 조절하기 위해 사용된다.<ul><li>정확도와 메모리 사용량에 비례한다.<li>정확도를 올리기 위해 무작정 많이 높힐 필요가 없고, 최종 cardinality보다 높다면 정확도는 충분하다.<li>기본값은 3000이고, 최댓값은 40000이다.</ul></ul><h4 id="hyperloglog-알고리즘"><span class="mr-2">HyperLogLog++ 알고리즘</span><a href="#hyperloglog-알고리즘" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><a href="https://d2.naver.com/helloworld/711301">HyperLogLog Naver D2 레퍼런스</a></p></blockquote><ul><li>HyperLogLog의 핵심 아이디어는 정수의 상위 비트에 대한 확률적인 접근에서부터 시작한다.<li>어떤 정수가 있을 때 상위 첫 번째 비트가 0인 정수 또는 상위 첫 번째 비트가 1인 정수는 각각 전체 표현 가능한 정수 중 50%를 차지한다.<li>마찬가지로 상위 비트가 00, 01, 10, 11로 시작하는 정수 각각에 대한 최대 cardinality는 전체 표현 가능한 정수의 25%가 된다.<li>HyperLogLog에서는 이렇게 상위 몇 비트(b)를 사용할 것인지에 따라 레지스터의 개수(m=2b)가 결정된다.<li>그리고 레지스터별 최대 cardinality는 ‘전체 표현 가능 정수 개수’ ×개이다.(레지스터 개수를 늘이면 좀 더 정해에 가까운 추정 값을 계산할 수 있음)<li>hashSet 대비 오차는 있으나 매우 효율적으로 근사값을 구할수 있음.</ul><p><a href="https://github.com/sungsu9022/study/assets/6982740/5c432f30-3a23-4ae1-98a1-b9b0186d3975" class="popup img-link "><img width="878" alt="" data-src="https://github.com/sungsu9022/study/assets/6982740/5c432f30-3a23-4ae1-98a1-b9b0186d3975" class="lazyload" data-proofer-ignore></a></p><h3 id="443-버킷-집계"><span class="mr-2">4.4.3 버킷 집계</span><a href="#443-버킷-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>버킷 집계는 문서를 특정 기준으로 쪼개어 여러 부분 집합으로 나눈다.<li>이 부분 집합을 버킷이라고 하고, 각 버킷에 포함된 문서를 대상으로 별도의 하위 집계(sub-aggregation)을 수행하여 집계하는 방식이다.</ul><h4 id="range-집계"><span class="mr-2">range 집계</span><a href="#range-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>지정된 필드값을 기준으,로 문서를 원하는 버킷 구간으로 쪼개서 집계한다.<li>버킷 구간을 나눌 기준이 될 필드와 기준값을 지정해 요청한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre>### range
GET /kibana_sample_data_flights/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "distnace-kilometers-range": {
      "range" : {
        "field":"DistanceKilometers",
        "ranges": [
          {
            "to": 5000
          },
          {
            "from": 5000,
            "to": 10000
          },
          {
            "to": 10000
          }
        ]
      },
      "aggs": {
        "average-ticket-price": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">86</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gte"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"distnace-kilometers-range"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*-5000.0"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"to"</span><span class="p">:</span><span class="w"> </span><span class="mf">5000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">4039</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"average-ticket-price"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">513.3039915741715</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*-10000.0"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"to"</span><span class="p">:</span><span class="w"> </span><span class="mf">10000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">10060</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"average-ticket-price"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">611.5759058298221</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5000.0-10000.0"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"from"</span><span class="p">:</span><span class="w"> </span><span class="mf">5000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"to"</span><span class="p">:</span><span class="w"> </span><span class="mf">10000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">6021</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"average-ticket-price"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">677.4985535093724</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>요청 body을 보면 range 밑에 “aggs”가 하나 더 있는데, 이 부분이 하위 집계이다.<li>위 요청 내용을 보면 DistanceKilometers 값을 기준으로 3개의 버킷을 쪼개고 아 내부에서 AvgTicketPrice avg 값을 집계한것을 알 수 있다.<li>하위 집계에 또 버킷 집계를 넣으면 다시 그 하위 집계를 지정하는 것도 가능하다.<ul><li>다만, 하위 집계의 깊이가 너무 깊어지면 성능에 심각한 문제가 생길수 있으니 지양해야 한다.</ul></ul><h4 id="data_range-집계"><span class="mr-2">data_range 집계</span><a href="#data_range-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>range 집계와 유사하나 date 타입 필드를 대상으로 사용하는 점과 from, to에 간단한 날짜 시간 계산식을 사용할수 있다는 차이가 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>### date_range
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "distnace-kilometers-range": {
      "date_range" : {
        "field":"order_date",
        "ranges": [
          {
            "to": "now-10d/d"
          },
          {
            "from": "now-10d/d",
            "to": "now"
          },
          {
            "to": "now"
          }
        ]
      }
    }
  }
}
</pre></table></code></div></div><ul><li>위 요청에서 주목할 부분은 now를 사용한 점인데, now가 포함된 집계 요청은 캐시되지 않는다.(호출 시점마다 now 값이 다르기 떄문)<li>새로운 데이터가 들어와서 인덱스의 상태가 달라져도 샤드 요청 캐시는 무효화된다.</ul><h4 id="histogram-집계"><span class="mr-2">histogram 집계</span><a href="#histogram-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>지정한 필드의 값을 기준으로 버킷을 나눈다는 점에서 range 집계와 유사하다.<li>다른 점은 버킷 구분의 경계 기준값을 직접 지정하는 것이 아니라 버킷의 간격을 지정해서 집계를 나눈다는 점이다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>GET /kibana_sample_data_flights/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "my-histogram": {
      "histogram" : {
        "field":"DistanceKilometers",
        "interval": 1000
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gte"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"my-histogram"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1799</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1148</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">2000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">529</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">3000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">241</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">4000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">322</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">5000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">411</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">6000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1062</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">7000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1718</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">8000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1343</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">9000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1487</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">10000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">647</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">11000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">653</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">12000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">323</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">13000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">302</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">14000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">278</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">15000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">282</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">16000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">327</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">17000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">41</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">18000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">69</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mf">19000.0</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>위처럼 <code class="language-plaintext highlighter-rouge">interval</code>을 지정하면 해당 필드의 최솟값과 최댓값을 확인한 후 그 사이를 지정한 <code class="language-plaintext highlighter-rouge">interval</code>에 지정한 간격으로 쪼개서 버킷을 나눈다.<li>위치를 조정하고 싶은 경우 <code class="language-plaintext highlighter-rouge">offset</code>을 지정하여 사용할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>### histogram + offset
GET /kibana_sample_data_flights/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "my-histogram": {
      "histogram" : {
        "field":"DistanceKilometers",
        "interval": 1000,
        "offset": 50
      }
    }
  }
}
</pre></table></code></div></div><ul><li>offset을 지정하지 않는 경우 <code class="language-plaintext highlighter-rouge">[0, 1000], [1000-2000], ...</code>로 구간이 생성되고, offset 50으로 지정한 경우 <code class="language-plaintext highlighter-rouge">[50 1050], [1050, 2050], ...</code>으로 구간이 생성되었다.<li>이 밖에도 min_doc_coun를 지정해서 버킷 내 문서 개수가 일정 이하인 버킷은 결과에서 제외할 수 있다.</ul><h4 id="data_histogram-집계"><span class="mr-2">data_histogram 집계</span><a href="#data_histogram-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>### date_histogram
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "my-date-histogram": {
      "date_histogram" : {
        "field":"order_date",
        "calendar_interval": "month"
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">4675</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"my-date-histogram"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-12-01T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1701388800000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">3751</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-01T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1704067200000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">924</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>위처럼 날짜 기준으로 집계를 할수 있다.</ul><h4 id="calendar_interval"><span class="mr-2">calendar_interval</span><a href="#calendar_interval" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>12h 같은 단위값은 지정할 수 없음.</p></blockquote><ul><li>minute 또는 1m : 분단위<li>hour 또는 1h : 시간 단위<li>day 또는 1d : 일 단위<li>month 또는 1M : 월 단위<li>quarter 또는 1q : 분기 단위<li>year 또는 1y : 연 단위</ul><h4 id="fixed_interval"><span class="mr-2">fixed_interval</span><a href="#fixed_interval" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>calendar_interval에서는 12h 같은 값을 지정할 수 없으나 fixed_interval에서는 지정이 가능하다.<li>ex. <code class="language-plaintext highlighter-rouge">"fixed_interval": "3h"</code>로 지정하면 3시간 간격으로 버킷 구간을 쪼갤 수 있다.</ul><h4 id="terms-집계"><span class="mr-2">terms 집계</span><a href="#terms-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>필드에 대해 가장 빈도수가 높은 term 순서대로 버킷을 생성한다.<li>최대 몇개의 버킷을 생성할것인지 size로 지정한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>### terms 집계
GET /kibana_sample_data_logs/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "my-terms-aggs": {
      "terms" : {
        "field":"host.keyword",
        "size": "10"
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gte"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"my-terms-aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"doc_count_error_upper_bound"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"sum_other_doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"artifacts.elastic.co"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">6488</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"www.elastic.co"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">4779</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cdn.elastic-elastic-elastic.org"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">2255</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"elastic-elastic-elastic.org"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">552</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>각 샤드에서 size 개수만큼 term을 뽑아 빈도수를 센다.<li>각 샤드에서 수행된 계산을 한곳으로 모아 합산한 후 size개수만큼 버킷을 뽑는다.<ul><li>size 개수와 각 문서의 분포에 따라 결과가 정확하지 않을 수 있음.( term의 개수가 2개인데 size를 10개로 한다고한들 10개를 만들수 없다.)</ul></ul><h4 id="doc_count_error_upper_bound"><span class="mr-2">doc_count_error_upper_bound</span><a href="#doc_count_error_upper_bound" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>doc_count의 오차 상한선을 나타낸다.<li>이 값이 크다면 size를 높이는 것을 고려할 수 있다.<li>정확도가 올라가는 만큼 성능은 하락할 수 있다.</ul><h4 id="sum_other_doc_count"><span class="mr-2">sum_other_doc_count</span><a href="#sum_other_doc_count" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>최종적으로 버킷에 포함되지 않은 문서 수<li>상위 term에 들지 못한 문서 개수의 총합이다.</ul><h4 id="composite-집계"><span class="mr-2">composite 집계</span><a href="#composite-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>모든 term에 대해서 페이지네이션으로 전부 순회하면서 집계하려는 경우 사용(term에서는 정확하지 않을수 있기에)<li>sources로 지정된 하위 집계의 버킷 전부를 페이지네이션을 이용해서 효율적으로 순회하는 집계다.<li>또한 soruces에 하위 집계를 여러 개 지정한 뒤 조합된 버킷을 생성할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre>### composite 집계
GET /kibana_sample_data_logs/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "composite-aggs": {
      "composite" : {
        "size": 100,
        "sources": [
          {
            "terms-aggs": {
              "terms": {
                "field": "host.keyword"
              }
            }
          },
          {
            "date-histogram-aggs": {
              "date_histogram": {
                "field": "@timestamp",
                "calendar_interval": "day"
              }
            }
          }
        ]
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gte"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"composite-aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"after_key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"terms-aggs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cdn.elastic-elastic-elastic.org"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"date-histogram-aggs"</span><span class="p">:</span><span class="w"> </span><span class="mi">1706054400000</span><span class="w">
	  </span><span class="p">},</span><span class="w">
	  </span><span class="nl">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"terms-aggs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"artifacts.elastic.co"</span><span class="p">,</span><span class="w">
			</span><span class="nl">"date-histogram-aggs"</span><span class="p">:</span><span class="w"> </span><span class="mi">1702771200000</span><span class="w">
		  </span><span class="p">},</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">124</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"terms-aggs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"artifacts.elastic.co"</span><span class="p">,</span><span class="w">
			</span><span class="nl">"date-histogram-aggs"</span><span class="p">:</span><span class="w"> </span><span class="mi">1702857600000</span><span class="w">
		  </span><span class="p">},</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="w">
		</span><span class="p">},</span><span class="w">
                </span><span class="err">....</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>composite 아래의 size는 페이지네이션 한 번에 몇 개의 버킷을 반환할 것인가를 지정한다.<li>sources에는 버킷을 조합하여 순회할 하위 집계를 지정한다.<li>하위 집계는 terms, histogram, date_histogratm 집계 등 일부 집계만 지정할 수 있다.<ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html">ES Composite Aggregation Doc</a></ul><li>응답의 버킷 key가 여러 집계의 결과로 조합된 것을 확인할 수 있다.<ul><li>terms-aggs, date-histogram-aggs의 조합을 기준으로 집계됨.</ul></ul><h4 id="compositeafter"><span class="mr-2">composite.after</span><a href="#compositeafter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>집계 결과의 다음 페이지를 보고싶다면 composite 하위에 after을 추가하여 조회할수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre>### composite 집계 after
GET /kibana_sample_data_logs/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "composite-aggs": {
      "composite" : {
        "size": 100,
        "sources": [
          {
            "terms-aggs": {
              "terms": {
                "field": "host.keyword"
              }
            }
          },
          {
            "date-histogram-aggs": {
              "date_histogram": {
                "field": "@timestamp",
                "calendar_interval": "day"
              }
            }
          }
        ],
        "after": {
          "terms-aggs": "cdn.elastic-elastic-elastic.org",
          "date-histogram-aggs": 1675209600000
        }
      }
    }
  }
}
</pre></table></code></div></div><h3 id="444-파이프라인-집계"><span class="mr-2">4.4.4 파이프라인 집계</span><a href="#444-파이프라인-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>파이프라인 집계는 문서나 필드의 내용이 아니라 다른 집계 결과를 집계 대상으로 한다.<li>주로 buckets_path라는 인자를 통해 다른 집계의 결과를 가져오고, 이 buckets_path는 상대 경로로 지정한다.</ul><h4 id="buckets_path-지정-구문"><span class="mr-2">buckets_path 지정 구문</span><a href="#buckets_path-지정-구문" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">&gt;</code> : 하위 집계로 이동하는 구분자<li><code class="language-plaintext highlighter-rouge">.</code> : 하위 메트릭으로 이동하는 구분자<li>집계 이름<li>메트릭 이름</ul><h4 id="cumulative_sum-집계"><span class="mr-2">cumulative_sum 집계</span><a href="#cumulative_sum-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>다른 집계 값을 누적하여 합산한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>### cumulative_sum 집계
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "daily-timestamp-bucket": {
      "date_histogram" : {
      "field": "order_date",
      "calendar_interval": "day"
      },
      "aggs": {
        "daily-total-quantity-average": {
          "avg": {
            "field": "total_quantity"
          }
        },
        "pipeline-sum": {
          "cumulative_sum": {
            "buckets_path": "daily-total-quantity-average"
          }
        }
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">4675</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"daily-timestamp-bucket"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-12-07T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1701907200000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">146</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"daily-total-quantity-average"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.1780821917808217</span><span class="w">
		  </span><span class="p">},</span><span class="w">
		  </span><span class="nl">"pipeline-sum"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.1780821917808217</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w">
                </span><span class="err">....</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-05T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1704412800000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"daily-total-quantity-average"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.289473684210526</span><span class="w">
		  </span><span class="p">},</span><span class="w">
		  </span><span class="nl">"pipeline-sum"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">64.71700410498919</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-06T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1704499200000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"daily-total-quantity-average"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.183098591549296</span><span class="w">
		  </span><span class="p">},</span><span class="w">
		  </span><span class="nl">"pipeline-sum"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">66.90010269653848</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>일 단위로 total_quantity의 평균을 구하기 위해 date_histogram으로 버킷을 나눈 뒤 하위 집계로 avg 집계를 지정했다.<li>그리고 date_histogram의 하위 집계로 cumulative_sum 집계를 추가 지정했다.</ul><h4 id="max_bucket-집계"><span class="mr-2">max_bucket 집계</span><a href="#max_bucket-집계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>다른 집계의 결과를 받아서 그 결과가 가장 큰 버킷의 key와 결과값을 구하는 집계이다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>### max_bucket 집계
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "daily-timestamp-bucket": {
      "date_histogram" : {
        "field": "order_date",
        "calendar_interval": "day"
      },
      "aggs": {
        "daily-total-quantity-average": {
          "avg": {
          "field": "total_quantity"
          }
        }
      }
    },
    "max-total-quantity": {
      "max_bucket": {
        "buckets_path": "daily-timestamp-bucket&gt;daily-total-quantity-average"
      }
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">4675</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"daily-timestamp-bucket"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-12-07T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1701907200000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">146</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"daily-total-quantity-average"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.1780821917808217</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w">
                </span><span class="err">....</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-05T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1704412800000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"daily-total-quantity-average"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.289473684210526</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w">
		  </span><span class="nl">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-06T00:00:00.000Z"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1704499200000</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"daily-total-quantity-average"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.183098591549296</span><span class="w">
		  </span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max-total-quantity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.289473684210526</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"keys"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="s2">"2024-01-05T00:00:00.000Z"</span><span class="w">
	  </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>buckets_path가 절대경로가 아니라 상대경로 이므로 daily-timestamp-bucket에서 하위 집계인 daily-total-quantity-average로 이동하는 구분자를 사용했다.<ul><li><code class="language-plaintext highlighter-rouge">"buckets_path": "daily-timestamp-bucket&gt;daily-total-quantity-average"</code></ul></ul><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://d2.naver.com/helloworld/711301">HyperLogLog Naver D2 레퍼런스</a><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html">ES Composite Aggregation Doc</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/elasticsearch/'>Elasticsearch</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >Elasticsearch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-2(%EC%A7%91%EA%B3%84)%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-2%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-2(%EC%A7%91%EA%B3%84)%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-2%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-2%2F&text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-2(%EC%A7%91%EA%B3%84)%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/es-bible-1/"><div class="card-body"> <em class="small" data-ts="1700127840" data-df="ll" > Nov 16, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 1. 엘라스틱 서치 소개</h3><div class="text-muted small"><p> 1. 엘라스틱 서치 소개 Elasticsearch는 2010년 2월 샤이 베논이 아파치의 루씬 라이브러리를 기반으로 만든 분산 검색 엔진 2013년에 데이터를 손쉽게 시각화하는 Kibana와 색인 데이터 수집&amp;amp;변환을 하는 Logstash 프로젝트에 엘라스틱에 합류 엘라스틱서치는 현재 검색 엔진 분야에서 가장 각광받고 있는 시스템이다...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-2/"><div class="card-body"> <em class="small" data-ts="1700218920" data-df="ll" > Nov 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</h3><div class="text-muted small"><p> 2. 엘라스틱 서치 기본 동작과 구조 엘라스틱서치의 구조를 어느정도 먼저 이해한 상태에서 상세 내용을 학습해야 전체 학습에 깊이가 생긴다. 이번 장을 마치고 나면 엘라스틱서치가 어떻게 동작하는지 큰 그림을 머릿속에 그릴수 있을것이다. 2.1 엘라스틱서치 기본 동작 빠르게 둘러보기 실습 과정에서는 기본적으로 REST API를 호출해 진...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-3-1/"><div class="card-body"> <em class="small" data-ts="1700301000" data-df="ll" > Nov 18, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</h3><div class="text-muted small"><p> 3. 인덱스 설계 - 1 ES의 인덱스는 아주 세부적인 부분까지 설정으로 제어할 수 있다. 이 설정에 따라 동작과 특성이 매우 달라지므로 인덱스 설계에 신경써야 한다. 맵핑, 필드 타입, 애널라이저 등 핵심적인 설정을 학습해 ES 인덱스에 대한 이해도를 높여보자. 3.1 인덱스 설정 인덱스 생성시 동작에 관한 설정을 지정할 수 있...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/es-bible-4-1/" class="btn btn-outline-primary" prompt="Older"><p>[엘라스틱서치 바이블] 4. 데이터 다루기 -1</p></a> <a href="/posts/es-bible-4-3/" class="btn btn-outline-primary" prompt="Newer"><p>[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/es-bible-4-2/'; this.page.identifier = '/posts/es-bible-4-2/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>

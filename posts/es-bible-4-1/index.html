<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="[엘라스틱서치 바이블] 4. 데이터 다루기 -1" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="4. 데이터 다루기 -1" /><meta property="og:description" content="4. 데이터 다루기 -1" /><link rel="canonical" href="https://sungsu9022.github.io/posts/es-bible-4-1/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/es-bible-4-1/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-16T19:49:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[엘라스틱서치 바이블] 4. 데이터 다루기 -1" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2023-12-16T19:49:00+09:00","datePublished":"2023-12-16T19:49:00+09:00","description":"4. 데이터 다루기 -1","headline":"[엘라스틱서치 바이블] 4. 데이터 다루기 -1","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/es-bible-4-1/"},"url":"https://sungsu9022.github.io/posts/es-bible-4-1/"}</script><title>[엘라스틱서치 바이블] 4. 데이터 다루기 -1 | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[엘라스틱서치 바이블] 4. 데이터 다루기 -1</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>[엘라스틱서치 바이블] 4. 데이터 다루기 -1</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1702723740" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 16, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="13862 words"> <em>77 min</em> read</span></div></div></div><div class="post-content"><h1 id="4-데이터-다루기--1">4. 데이터 다루기 -1</h1><h2 id="41-단건-문서-api"><span class="mr-2">4.1 단건 문서 API</span><a href="#41-단건-문서-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>문서(document) API는 인덱스에 문서를 색인, 조회, 업데이트, 삭제하는 API이다. 상세한 내용을 알아보도록 하자.</ul><h3 id="411-색인-api"><span class="mr-2">4.1.1 색인 API</span><a href="#411-색인-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>색인 API는 문서 단건을 색인한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>PUT [인덱스 이름]/_doc/[_id값]
POST [인덱스 이름]/_doc
PUT [인덱스 이름]/_create/[_id값]
POST [인덱스 이름]/_create/[_id값]
</pre></table></code></div></div><h4 id="각--api의-차이"><span class="mr-2">각 API의 차이</span><a href="#각--api의-차이" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>기본 API 는 <code class="language-plaintext highlighter-rouge">PUT [인덱스 이름]/_doc/[_id값]</code> 이다.<ul><li>_id값에 일치하는 문서가 이미 있다면 새 문서로 덮어 씌움</ul><li>POST 메서드는 _id 값을 지정하지 않고 색인을 요청할 경우에 사용한다.(es에서 random한 _id 생성)<li><code class="language-plaintext highlighter-rouge">_create</code> 메서드의 경우에는 항상 새 문서를 생성하는 경우에만 허용하고, 기존 문서를 덮어쓰면서 색인하는것을 금지한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>### 4.1.1 색인 API
PUT /my_index2/_create/2
Host: localhost:9200
Content-Type: application/json

{
  "hello": "world2"
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"root_cause"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	  </span><span class="p">{</span><span class="w">
		</span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"version_conflict_engine_exception"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[2]: version conflict, document already exists (current version [1])"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"index_uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zV7gpn5XQ4aHoQ9Bw36ygA"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"shard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="w">
	  </span><span class="p">}</span><span class="w">
	</span><span class="p">],</span><span class="w">
	</span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"version_conflict_engine_exception"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[2]: version conflict, document already exists (current version [1])"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"index_uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zV7gpn5XQ4aHoQ9Bw36ygA"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"shard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">409</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>한번 생성된 _id로 다시 한번 create 하면 error 응답을 주는것을 확인할 수 있다.</ul><h4 id="라우팅"><span class="mr-2">라우팅</span><a href="#라우팅" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>라우팅을 지정하지 않는 경우 _id 값의 해시값을 기반으로 샤드가 배정된다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>### routing
PUT /routing_test/_doc/2?routing=myid2
Host: localhost:9200
Content-Type: application/json

{
  "login_id": "myid",
  "comment": "hello elasticsearch",
  "created_at" : "2022-12-01T00:08:12.378Z"
}
</pre></table></code></div></div><h4 id="refresh"><span class="mr-2">refresh</span><a href="#refresh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>색인시 refresh 매개변수를 지정하면 문서를 색인한 직후에 해당 샤드를 refresh해서 즉시 검색 가능하게 만들 것인지 여부를 지정할 수 있다.<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.11/docs-refresh.html">refresh 공식 문서</a><ul><li>true : 색인 직후 문서가 색인된 샤드를 refresh 하고 응답<li>wait_for : 색인 이후 문서가 refresh될 때까지 기다린 후 응답을 반환. true로 지정했을때와 다르게 refresh를 직접 유발하지는 않음. <code class="language-plaintext highlighter-rouge">index.refresh_interval</code> 에 지정된 시간까지 대기하다가 refresh가 완료되면 응답함<li>false : 기본값으로 refresh와 관련된 동작을 수행하지 않음.</ul></ul><h4 id="refresh-관련-주의사항"><span class="mr-2">refresh 관련 주의사항</span><a href="#refresh-관련-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>실제 서비스를 만들다보면 색인 직후 검색 API를 사용해야 하고, 그 검새 결과에 최신 변경 내용이 포함되어야하는 경우가 있고 그경우 refresh 옵션을 고려할 수 있다.<li>다만, true 또는 wait_for 옵션을 사용할 경우 반드시 성능에 대한 고려가 필요하다.<ul><li>호출량이 많은 서비스가 매번 refresh를 지정해 호출하면 전체 클러스터 성능이 크게 저하될 수 있다.<li>이러한 사용방식은 너무 많은 작은 세그먼트를 생성하여 장기적으로 검색 성능이 떨어지고, 추후 세그먼트 병합 비용도 발생함.</ul><li>wait_for을 하는 경우에도 너무 많은 대기 요청이 있는 경우 강제로 refresh가 수행될 수 있음.<ul><li>index.max_refresh_listeners 설정 기본값 : 1000(이 이상 wait_for하는 경우 강제 refresh)</ul></ul><h4 id="추가-인덱스-설계-코멘트"><span class="mr-2">추가 인덱스 설계 코멘트</span><a href="#추가-인덱스-설계-코멘트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>기본적으로 문서 색인 요청의 결과가 검색 역색인에 즉시 동기 반영되어야 하는 케이스는 많지 않도록 서비스 설계해야 함.<li>대량 색인의 경우 단건 색인 API 대신 bulk API를 사용해야 한다.</ul><h3 id="412-조회-api"><span class="mr-2">4.1.2 조회 API</span><a href="#412-조회-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>문서 단건을 조회하는 API, es refresh 되지 않아도 변경 내용을 확인할 수 있다.<li>고유 식별자를 지정하여 조회하는것이므로 역색인이 필요없고, translog에서도 데이터를 읽어올수 있음.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_doc/[_id값]
GET [인덱스 이름]/_source/[_id값]
</pre></table></code></div></div><h4 id="_doc과-_soruce의-차이"><span class="mr-2">_doc과 _soruce의 차이</span><a href="#_doc과-_soruce의-차이" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>_doc을 이용하면 인덱스, _id를 포함한 기본적인 메타 데이터도 함꼐 조회할 수 있음.<li>_soruce를 이용하면 메타데이터 없이 문서 정보만 조회할 수 있음.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>### _doc
GET /my_index2/_doc/2
Host: localhost:9200
Content-Type: application/json

{
  "_index": "my_index2",
  "_id": "2",
  "_version": 1,
  "_seq_no": 1,
  "_primary_term": 2,
  "found": true,
  "_source": {
	"hello": "world2"
  }
}

### _source
GET /my_index2/_source/2
Host: localhost:9200
Content-Type: application/json

{
  "hello": "world2"
}
</pre></table></code></div></div><h4 id="필드-필터링"><span class="mr-2">필드 필터링</span><a href="#필드-필터링" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">_source_includes</code>와 <code class="language-plaintext highlighter-rouge">_source_excludes</code> 옵션을 사용하면 결과에 원하는 필드만 필터링해 포함시킬 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>### create
PUT /my_index2/_create/3
Host: localhost:9200
Content-Type: application/json

{
  "title": "hello world",
  "view": 1234,
  "public": true,
  "point": 4.5,
  "created_at" : "2019-01-17T14:05:01.234Z"
}

### 필드 필터링(_source_includes)
GET /my_index2/_doc/3?_source_includes=p*,views,
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"public"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	</span><span class="nl">"point"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.5</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>### 필드 필터링(_source_includes &amp; _source_excludes)
GET /my_index2/_doc/3?_source_includes=p*,views&amp;_source_excludes=public
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"views"</span><span class="p">:</span><span class="w"> </span><span class="mi">1234</span><span class="p">,</span><span class="w">
	</span><span class="nl">"point"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.5</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>includes, excludes를 꼭 같이 사용할 필요는 없고, excludes에 명시적으로 지정한 경우는 무조건 처리됨.<li>includes만 사용하고자 하는 경우 <code class="language-plaintext highlighter-rouge">_source</code> 매개변수로 사용할수 있다.<ul><li>_source는 true/false를 지정해 문서의 소스를 가져올지 말지에 대해서도 지정할수 있는데 필드명이 <code class="language-plaintext highlighter-rouge">false</code> 인 경우 충돌이 있을수 있음.</ul><li>includes, excludes에 명시한 내용이 적절히 조회되는 것을 알 수 있다.</ul><h4 id="라우팅-1"><span class="mr-2">라우팅</span><a href="#라우팅-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>조회 API도 색인과 마찬가지로 라우팅을 반드시 제대로 지정해야 한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>GET /routing_test/_doc/2?routing=myid2
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><h4 id="추가-검색-옵션들"><span class="mr-2">추가 검색 옵션들</span><a href="#추가-검색-옵션들" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>https://www.elastic.co/guide/en/elasticsearch/reference/8.11/search-your-data.html</ul><h3 id="413-업데이트-api"><span class="mr-2">4.1.3 업데이트 API</span><a href="#413-업데이트-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>지정한 문서 하나를 업데이트한다.<li>기본적으로 부분 업데이트(partial updarte)로 동작한다.(문서 전체를 교체하려면 색인 API를 사용하라)</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>POST [인덱스 이름]/_update/[_id값]
</pre></table></code></div></div><ul><li>API 자체는 부분 업데이트이지만, 루씬 세그먼트가 불변이라서 실제 ES의 업데이트 작업은 기존 문서의 내용을 조회한 뒤 부분 업데이트될 내용을 합쳐 새 문서를 만들어 색인하는 형태로 진행된다.<li>업데이트 API에는 doc을 이용하는 방법과 script를 이용하는 방법이 있다.</ul><h4 id="doc에-내용을-직접-기술하여-업데이트"><span class="mr-2">doc에 내용을 직접 기술하여 업데이트</span><a href="#doc에-내용을-직접-기술하여-업데이트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>POST [인덱스 이름]/_update/[_id값]
{
   "doc": {
      [업데이트할 내용]
   }
}
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>### create
PUT /update_test/_doc/1
Host: localhost:9200
Content-Type: application/json

{
  "title": "hello world",
  "views": 35,
  "created_at" : "2019-01-17T14:05:01.234Z"
}

### update
POST /update_test/_update/1
Host: localhost:9200
Content-Type: application/json

{
  "doc": {
    "views": 36,
    "updated_at" : "2019-01-23T17:00:01.567Z"
  }
}

### get
GET /update_test/_doc/1
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"update_test"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"updated"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>update 응답에 result : updated로 나오는것을 알 수 있다. 이후에 다시 조회하면 부분 업데이트가 적용된 결과를 확인할 수 있다.</ul><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"update_test"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello world"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"views"</span><span class="p">:</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w">
	</span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-01-17T14:05:01.234Z"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-01-23T17:00:01.567Z"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h4 id="detect_noop"><span class="mr-2">detect_noop</span><a href="#detect_noop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>업데이트 API를 호출하면 ES는 그 작업을 수행하기 전에 업데이트 내용이 기존문서 내용을 실질적으로 변경하는지 여부를 확인한다.<li>실제 데이터 변경사항이 없으면 요청(noop 요청, no operation)이라면 쓰기 작업을 수행하지 않는다.<li>noop 검사를 통해 불필요한 디스크 I/O를 줄일 수 있고, 이 기본값은 true이다.<li>detect_noop을 명시적으로 false로 지정하여 비활성화할수 있는데, 이 경우에는 업데이트가 일어난다.</ul><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"update_test"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"noop"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h4 id="detect_noop-옵션을-비활성화하는-상황"><span class="mr-2">detect_noop 옵션을 비활성화하는 상황</span><a href="#detect_noop-옵션을-비활성화하는-상황" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>일반적인 상황에서는 활성화하는 것이 좋다.<li>데이터 특성상 noop 업데이트가 발생할 가능성이 아예 0%인 경우에는 detect_noop을 비활성화하는 것이 성능을 약간 향상시켜줄 수 있다.</ul><h4 id="detect_noop--custom-plugin-작성시-유의사항"><span class="mr-2">detect_noop + custom plugin 작성시 유의사항</span><a href="#detect_noop--custom-plugin-작성시-유의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>custom plugin 등 ES를 커스터마이징한다면, 이 옵션을 주의 깊게 살펴봐야 한다.<li>플러그인에서 IndexingOperationListener 같은 리스너를 달 경우 색인 전후에 원하는 작업을 끼워넣을 수 있다.<li>업데이트 요청이 noop로 처리된다면 ES입장에서는 실제 색인이 수행되지 않으므로 IndexingOperationListener의 preIndex, postIndex 핸들러쪽이 수행되지 않게 된다.</ul><h4 id="doc_as_upsert"><span class="mr-2">doc_as_upsert</span><a href="#doc_as_upsert" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>업데이트 API는 기본적으로 기존문서의 내용을 먼저 읽어들인 뒤 업데이트를 수행한다.(기존 문서가 없으면 요청 실패)<li>doc_as_upsert 옵션을 통해 기존문서가 없는 경우 새로 문서를 추가하는 방법을 제공한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>### doc_as_upsert
POST /update_test/_update/2
Host: localhost:9200
Content-Type: application/json

{
  "doc": {
    "views": 36,
    "updated_at" : "2019-01-23T17:00:01.567Z"
  },
  "doc_as_upsert": true
}
</pre></table></code></div></div><h4 id="script를-이용한-업데이트"><span class="mr-2">script를 이용한 업데이트</span><a href="#script를-이용한-업데이트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>별도의 스크립트 언어를 넣어서 문서를 업데이트 하는 방법이 있따.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>### script를 이용하여 업데이트
POST /update_test/_update/1
Host: localhost:9200
Content-Type: application/json

{
  "script": {
    "source": "ctx._source.views += params.amount",
    "lang": "painless",
    "params": {
      "amount": 1
    }
  },
  "scripted_upsert": false
}
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">script</code> : 스크립트를 이용해서 업데이트를 수행할 때는 그 내용을 위와 같이 script 필드 안에 기술한다.<li><code class="language-plaintext highlighter-rouge">source</code> : 소스는 스키릅트 본문 기술<li><code class="language-plaintext highlighter-rouge">lang</code> : 스크립트 언어 종류 지정(기본값 : painless)<li><code class="language-plaintext highlighter-rouge">params</code> : 스크립트 본문에서 사용할 매개변수 값들을 넣어둘수 있다.<li><code class="language-plaintext highlighter-rouge">scripted_upsert</code> : 스크립트를 사용한 업데이트가 upsert로 동작하도록 할지를 지정(기본값 false)</ul><h4 id="제공하는-스크립트-langauge"><span class="mr-2">제공하는 스크립트 langauge</span><a href="#제공하는-스크립트-langauge" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/sungsu9022/study/assets/6982740/620fc674-91ed-4d1d-8a28-8b5c69fcf279" class="popup img-link "><img width="831" alt="스크린샷 2023-12-16 오후 7 05 36" data-src="https://github.com/sungsu9022/study/assets/6982740/620fc674-91ed-4d1d-8a28-8b5c69fcf279" class="lazyload" data-proofer-ignore></a></p><h4 id="라우팅과-refresh"><span class="mr-2">라우팅과 refresh</span><a href="#라우팅과-refresh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>업데이트 API에도 색인 API와 마찬가지로 routing과 refresh 옵션을 지정할 수 있다.<li>색인시 routing을 지정했다면 업데이트시에도 동일한 값으로 라우팅을 지정해 업데이트해야 의도한 대로 동작한다.<li>refresh 션 또한 조회 API와 동일하게 동작한다.</ul><h3 id="414-삭제-api"><span class="mr-2">4.1.4 삭제 API</span><a href="#414-삭제-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>지정한 문서 하나를 삭제한다.<li>한번 삭제한 문서는 되돌릴 수 없기 때문에 삭제 작업을 항상 신중해야 한다.<li>삭제 API에도 색인이나 업데이트와 마찬가지로 routing과 refresh 옵션을 지정할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>DELETE [인덱스 이름]/_doc/[_id값]
</pre></table></code></div></div><h4 id="삭제시-주의사항"><span class="mr-2">삭제시 주의사항</span><a href="#삭제시-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">DELETE [인덱스 이름]</code>을 하는 경우 인덱스 전체가 삭제될 수 있다.</ul><h2 id="42-복수-문서-api"><span class="mr-2">4.2 복수 문서 API</span><a href="#42-복수-문서-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>서비스 환경에서 단건 문서 API보다는 복수 문서 API를 활용해야 한다.</ul><h3 id="421--bulk-api"><span class="mr-2">4.2.1 bulk API</span><a href="#421--bulk-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>bulk API는 여러 색인, 업데이트, 삭제 작업을 한 번의 요청에 담아서 보내는 API이다.<li>bulk API는 ES의 다른 API와는 다르게 요청 본문을 JSON이 아니라 NSJSON 형태로 만들어서 보낸다.<li>요청 Content-Type 헤더에 <code class="language-plaintext highlighter-rouge">application/x-ndjson</code> 을 사용해야 한다.<ul><li>여러 줄의 JSON을 줄바꿈 문자(<code class="language-plaintext highlighter-rouge">\n</code>)로 구분하여 요청</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>### _bulk
### intellij version에 따라 body parse가 안되는 이슈가 있는듯
POST /_bulk
Host: localhost:9200
Content-Type: application/x-ndjson

{"index":{"_index":"bulk_test","_id":"1"}}\n
{"field1":"value1"}\n
{"delete":{"_index":"bulk_test","_id":"2"}}\n
{"create":{"_index":"bulk_test","_id":"3"}}\n
{"field1":"value3"}\n
{"update":{"_index":"bulk_test","_id":"1"}}\n
{"doc":{"field2":"value2"}}\n
{"index":{"_index":"bulk_test","_id":"4","routing":"a"}}\n
{"field1":"value4"}\n
\n
</pre></table></code></div></div><ul><li>위 요청은 5개의 세부 요청으로 이루어져 있고, 아래의 요청이 포함되어 있다.<ul><li>index, create : 색인 요청<li>create는 문서 생성하는것만 허용하고, 기존 문서를 덮어쓰지 않는다.<li>index는 기존에 동일한 _id로 문서가 존재하지는 여부와 상관 없이 항상 색인을 수행한다.<li>update : 업데이트 요청<ul><li>다음 라인에서 doc 또는 script 사용 가능.</ul><li>delete : 삭제 요청</ul></ul><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">2180</span><span class="p">,</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bulk_test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"created"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">201</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"delete"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bulk_test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"not_found"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">404</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"create"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bulk_test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"created"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">201</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"update"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bulk_test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"updated"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bulk_test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"created"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">201</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>bulk API의 응답은 각 세부 요청을 수행하고 난 결과를 모아 하나의 응답으로 돌아온다.<li>전체 응답 내 각 세부 응답은 요청의 순서와 동일하다.<li>각 요청별 세부 응답의 상태코드를 통해 처리결과를 각각 전달받을 수 있다.</ul><h4 id="특정-index의-bulk-처리"><span class="mr-2">특정 index의 bulk 처리</span><a href="#특정-index의-bulk-처리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>POST [인덱스이름]/_bulk
</pre></table></code></div></div><ul><li>위처럼 _bulk 앞에 인덱스 이름을 넣으면 기본 대상이 해당 인덱스로 지정된다.</ul><h4 id="bulk-api의-작업-순서"><span class="mr-2">bulk API의 작업 순서</span><a href="#bulk-api의-작업-순서" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>bulk API에 기술된 작업은 반드시 그 순서대로 수행된다는 보장이 없다.<li>조정 역할을 하는 노드가 요청을 수신하면 각 요청 내용을 보고 적절한 주 샤드로 요청을 넘겨준다.<ul><li>이 때 주 샤드로 넘어간 각 요청은 각자 독자적으로 수행하므로 요청간 순서를 100% 보장하지 않는다.<li>완전히 동일한 인덱스, _id, 라우팅 조합을 가진 요청은 반드시 동일한 주 샤드로 요청이 가므로 이때는 순서를 보장할수 있다.</ul></ul><h4 id="bulk-api의-성능"><span class="mr-2">bulk API의 성능</span><a href="#bulk-api의-성능" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>네트워크를 통해 요청을 여러 번 반복해서 호출해야 한다면 이를 묶어 한꺼번에 전송하는것이 일반적으로 성능상 이득이다.<li>ES도 마찬가지로 단건 문서 API를 여러번 하는것보다 bulk API를 사용하는 편이 성능이 월등히 빠르다.<li>bulk API 요청 1번에 몇개의 요청을 모아서 보내는 것이 성능상 적절한지는 정해져있지 않고, 각 요청의 크기나 데이터 특성 등을 보고 적절히 조절해야 한다.<li>HTTP 요청을 chunked로 보내는 것은 성능을 떨어지게 만들기 떄문에 피해야 한다. ( <a href="https://mutpp.tistory.com/10">HTTP Chunk 참고</a> )</ul><h3 id="422-multi-get-api"><span class="mr-2">4.2.2 multi get API</span><a href="#422-multi-get-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>multi get API는 _id를 여럿 지정하여 해당 문서를 한 번에 조회하는 API이다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>GET _mget
GET [인덱스 이름]/_mget
</pre></table></code></div></div><ul><li>_bulk API와 마찬가지로 _mget 앞에 인덱스 이름을 명시했다면 이 인덱스를 기본 인덱스로 지정한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>### _mget
POST /_mget
Host: localhost:9200
Content-Type: application/json

{
  "docs": [
    {
      "_index": "bulk_test",
      "_id": 1
    },
    {
      "_index": "bulk_test",
      "_id": 4,
      "routing": "a"
    },
    {
      "_index": "my_index2",
      "_id": 1,
      "_source": {
        "include": ["p*"],
        "exclude": ["point"]
	    }
    }
  ]
}
</pre></table></code></div></div><ul><li>요청했던 순서대로 문서의 내용을 모아 단일 응답으로 돌아온다.</ul><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"docs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	</span><span class="p">{</span><span class="w">
	  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bulk_test"</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"field1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value1"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"field2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value2"</span><span class="w">
	  </span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="p">{</span><span class="w">
	  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bulk_test"</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4"</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_routing"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"field1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value4"</span><span class="w">
	  </span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="p">{</span><span class="w">
	  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
	</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="423-update-by-query"><span class="mr-2">4.2.3 update by query</span><a href="#423-update-by-query" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><code class="language-plaintext highlighter-rouge">update by query</code> 는 앞서 명한 bulk API, multi get API와는 성격이 좀 다른 복수 문서 API이다.<li>검색 쿼리를 통해 주어진 조건에 만족하는 문서를 찾은 뒤 그 문서를 대상으로 업데이트나 삭제 작업을 실시하는 API이다.<li>보통은 서비스에서 일상적으로 사용하기보다는 관리적인 목적으로 호출하는 것이 일반적이다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>POST [인덱스 이름]/_update_by_query

{
   "script": {
      "source": " // ... ",
   },
   "query": {
      // ...
   }
}
</pre></table></code></div></div><h4 id="update-by-query-업데이트-지원-관련"><span class="mr-2">update by query 업데이트 지원 관련</span><a href="#update-by-query-업데이트-지원-관련" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>doc을 이용한 업데이트를 지원하지 않고, script를 통한 업데이트만 지원한다.<li>painless 스크립트를 사용하는 경우 문맥 정보 중에서 ctx._now를 사용할 수 없다.(현재 타임스탬프값을 밀리세컨드로 반환한 값)</ul><h4 id="update-by-query-동작-방식"><span class="mr-2">update by query 동작 방식</span><a href="#update-by-query-동작-방식" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES는 query 절의 검색 조건에 맞는 문서를 찾아 일종의 스냅샷을 찍는다.<li>이후 각 문서마다 지정된 스크립트에 맞게 업데이트 실시<ul><li>순차적으로 실행하는 과정중에 스냅샷을 찍어뒀던 문서에서 변화가 생긴 문서가 발견되면 이를 업데이트 하지 않는다.<li>버전 충돌 문제시 전체 작업을 그만두거나 다음 작업으로 넘어가는 방식을 사용자가 선택할 수 있다. ( conflicts 매개변수 지정, 기본값 abort)<li>도중에 충돌로 인해 중간에 작업이 중단된 경우 그 이전까지 업데이트된 내용이 롤백되거나 하지는 않는다(이를 염두해두고 작업을 수행해야 한다.)</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>### _update_by_query
POST /bulk_test/_update_by_query
Host: localhost:9200
Content-Type: application/json

{
  "script": {
    "source": "ctx._source.field1 = ctx._source.field1 + '_' + ctx._id",
    "lang": "painless"
  },
  "query": {
    "exists": {
      "field": "field1"
    }
  }
}
</pre></table></code></div></div><ul><li>bulk_test 인덱스 내에 field1이라는 이름의 필드가 존재하는 문서를 대상으로 업데이트를 수행했다.</ul><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">242</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="nl">"updated"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="nl">"deleted"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"batches"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version_conflicts"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"noops"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"bulk"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"search"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"throttled_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"requests_per_second"</span><span class="p">:</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"throttled_until_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"failures"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>응답을 보면 작업된 문서 개수, 버전 충돌, 재시도 횟수 등을 확인할 수 있다.</ul><h4 id="스로틀링"><span class="mr-2">스로틀링</span><a href="#스로틀링" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>위 예시 응답 내용 중 throttled_millis, requests_per_second, throttled_until_millis 들을 볼 수 있는데 이는 스로틀링과 관련된 필드이다.<li>update by query API는 문제가 생긴 데이터를 일괄적으로 처리하거나 변경된 비즈니스 요건에 맞게 데이터를 일괄 수정하는 작업 등에 많이사용되는데, 대량 작업을 수행하면 운영 중인 기존 서비스에도 영향을 줄수 있으므로 이런 상황을 피하기 위해 스로틀링 기능을 제공한다.<li>스로틀링 적용을 통해 작업의 속도를 조정하고 클러스터 부하와 서비스 영향을 최소화할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>### throttling
POST /bulk_test/_update_by_query?scroll_size=1000&amp;scroll=1m&amp;requests_per_seconds=500
Host: localhost:9200
Content-Type: application/json

{
  // ...
}
</pre></table></code></div></div><h4 id="스로틀링-설정시-고려-사항"><span class="mr-2">스로틀링 설정시 고려 사항</span><a href="#스로틀링-설정시-고려-사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">scroll_size</code>는 문서 검색/업데이트를 수행하는 단위 개수이다.<ul><li>1000개로 지정한다면 1000개의 문서를 가져온뒤 1000개 문서에 대한 업데이트를 수행하고, 그 이후에 다시 1000개를 가져오는 방식으로 동작한다.<li>서비스와 작업 환경에 맞는 적절한 scroll_size를 지정하는것이 필요하다.</ul><li><code class="language-plaintext highlighter-rouge">scroll</code> 은 검색 조건에 만족하는 모든 문서를 대상으로 검색이 처음 수행됐을 당시 상태를 검색 문맥(search context)에 저정하는데, 이 search context를 얼마나 보존할지에 대한 설정이다.<ul><li>1m으로 설정할 경우 1분 동안 검색 문맥이 유지된다.<li>모든 작업이 종료될 때까지 필요한 시간을 지정하는것은 아니고, 한 배치 작업에 필요한 시간을 지정하면 된다.(scroll_size만큼의 작업 처리)<li>scroll_size만큼의 작업을 수행할 수 없을만큼 짧게 지정해서는 안된다.<li>너무 큰 값을 지정하면 힙이나 디스크 공간, file descriptor 등 많은 자원 소비가 필요하니 적절한 값을 지정해야 한다.</ul><li><code class="language-plaintext highlighter-rouge">requests_per_secoond</code> 은 이름 그대로 평균적으로 초당 몇 개까지의 작업을 수행할것인지에 대한 지정이다.<ul><li>scroll_size 단위로 업데이트 작업을 수행한 뒤 <code class="language-plaintext highlighter-rouge">requests_per_secoond</code> 값에 맞도록 일정 시간을 대기하는 방식으로 진행되낟.<li>scroll_size 1000, requests_per_second를 500으로 설정했다면 ES는 2초마다 스크롤 한번 분량만큼을 업데이트한다.<li>requests_per_secoond를 <code class="language-plaintext highlighter-rouge">-1</code>로 설정하면 스로틀링을 적용하지 않는다.</ul></ul><h4 id="비동기적-요청과-tasks-api"><span class="mr-2">비동기적 요청과 tasks API</span><a href="#비동기적-요청과-tasks-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>update 처리에 따라서 작업시간이 수십시간이 될수도 있는데, 이를 HTTP blocking 방식으로 응답을 무한정 대기할수는 없다.<li>이런 문제를 위해 update by query 요청시 <code class="language-plaintext highlighter-rouge">wait_for_completion</code> 매개변수를 false로 지정하여 비동기적 처리를 할 수 있다.<ul><li>이떄 응답으로 task id를 반환한다.</ul><li>task API는 비동기 처리시 반환받은 task_id를 가지고 현재 진행중인 task의 상태를 확인할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>POST [인덱스 이름]/_update_by_query?wait_for_completion=false
{
   // ...
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
   </span><span class="nl">"task"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"f8Aa9sj-RbaOebr3acDcxQ:120896"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h4 id="tasks-api"><span class="mr-2">tasks API</span><a href="#tasks-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>GET .tasks/_doc/[task id]
GET _tasks/[task id]
</pre></table></code></div></div><h4 id="2개-api의-차이점"><span class="mr-2">2개 API의 차이점</span><a href="#2개-api의-차이점" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">.tasks</code> API는 ES 내부 인덱스인 <code class="language-plaintext highlighter-rouge">.tasks</code>의 문서 정보를 단건으로 조회하는 방식이다.<ul><li>비동기로 등록되지 않은 작업도 확인할 수 있다.</ul><li><code class="language-plaintext highlighter-rouge">_tasks</code> API는 tasks 관리 APAI인데 ES 8.11 기준으로도 beta 기능이라 변경될 가능성이 있다.</ul><h4 id="task-api-호출"><span class="mr-2">task API 호출</span><a href="#task-api-호출" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>### task api
GET /_tasks/f8Aa9sj-RbaOebr3acDcxQ:120896
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"completed"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"task"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"node"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f8Aa9sj-RbaOebr3acDcxQ"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">120896</span><span class="p">,</span><span class="w">
	</span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"transport"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"indices:data/write/update/byquery"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"updated"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"created"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"deleted"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"batches"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"version_conflicts"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"noops"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"bulk"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
		</span><span class="nl">"search"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
	  </span><span class="p">},</span><span class="w">
	  </span><span class="nl">"throttled_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"requests_per_second"</span><span class="p">:</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"throttled_until_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"update-by-query [bulk_test] updated with Script{type=inline, lang='painless', idOrCode='ctx._source.field1 = ctx._source.field1 + '_' + ctx._id', options={}, params={}}"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"start_time_in_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">1702726259365</span><span class="p">,</span><span class="w">
	</span><span class="nl">"running_time_in_nanos"</span><span class="p">:</span><span class="w"> </span><span class="mi">110659458</span><span class="p">,</span><span class="w">
	</span><span class="nl">"cancellable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
	</span><span class="nl">"cancelled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"response"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">104</span><span class="p">,</span><span class="w">
	</span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	</span><span class="nl">"updated"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	</span><span class="nl">"created"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"deleted"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"batches"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"version_conflicts"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"noops"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"bulk"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"search"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"throttled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0s"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"throttled_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"requests_per_second"</span><span class="p">:</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"throttled_until"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0s"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"throttled_until_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failures"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h4 id="task-작업-취소"><span class="mr-2">task 작업 취소</span><a href="#task-작업-취소" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>작업 진행 중 문제가 발생했다면 다음과 같이 작업을 취소할 수 있다.<li>어떤 노드에서 작업이 취소되었는지, 어떤 task 작업이 취소됐는지 등을 확인할 수 있다.<li><code class="language-plaintext highlighter-rouge">wait_for_completion=true</code>로 지정해 호출한 작업이더라도 task id를 알아내서 작업취소할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>POST _tasks/[task id]/_cancel
</pre></table></code></div></div><h4 id="스로틀링-동적-변경"><span class="mr-2">스로틀링 동적 변경</span><a href="#스로틀링-동적-변경" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>대량 작업을 수행하다 외부적인 이슈로 클러스터 전체에 문제가 발생하는 경우 스로틀링 동적 변경을 통해 대응할 수 있다.<li>ES update_by_query 특성상 이미 처리 완료된 데이터에 대한 트랜잭션 롤백이 없으므로 중간에 task를 중단시키는것이 능사가 아닐수 있다.<ul><li>72시간동안 수행되어야할 작업 중 일부만 남겨두고 있었다면 중간에 task를 취소하는것도 리스크일수 있음.</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>POST _update_by_query/[task id]/_rethrottle?request_per_second=[변경할 값]
</pre></table></code></div></div><ul><li>위와 같이 <code class="language-plaintext highlighter-rouge">_rethrottle</code>을 이용하면 작업의 스로틀링을 동적으로 변경할 수 있어 문제 상황을 유연하게 대응할 수 있다.</ul><h4 id="task-결과-삭제"><span class="mr-2">task 결과 삭제</span><a href="#task-결과-삭제" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">wait_for_completion=false</code>을 통해 <code class="language-plaintext highlighter-rouge">.tasks</code> 인덱스에 등록된 작업이 성공하거나 취소됐는지의 여부와 상관없이 등록된 작업 결과는 ES에 계속 남는다.<li>작업의 상황을 충분히 확인했다면 인덱스의 문서를 삭제하면 좋다</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>DELETE .tasks/_doc/[task id]
</pre></table></code></div></div><h4 id="슬라이싱"><span class="mr-2">슬라이싱</span><a href="#슬라이싱" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>관리적 목적의 대량 업데이트를 수행하는 경우, 스로틀링을 적용해 부하를 줄이는 선택도 있겠지만, 반대로 업데이트 성능을 최대로 끌어내 빠른 시간 안에 끝내고자 하는 선택도 있다.(ex. 서비스 요청 차단 후 정기점검)<li><code class="language-plaintext highlighter-rouge">slices</code> 매개변수를 지정하면 검색과 업데이트를 지정한 개수로 쪼개 병렬적으로 수행한다.<ul><li>기본값은 1이고, auto로 지정하는 경우 ES가 적절한 개수를 지정해서 작업을 병렬 수행한다.</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>POST [인덱스 이름]/_update_by_query?slice=auto
{
   // ...
}
</pre></table></code></div></div><h4 id="슬라이싱-관련-주의사항"><span class="mr-2">슬라이싱 관련 주의사항</span><a href="#슬라이싱-관련-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">slices=auto</code>인 경우 보통은 지정한 인덱스의 주 샤드 수가 슬라이스의 수로 지정된다.<li>주 샤드 수보다 높은 slices 수를 지정하는 경우 오히려 성능이 급감할수 있음을 유의해야 한다.<ul><li>샤드 내 slices 분배가 필요해지는데 슬라이스 수가 주 샤드 이내인 경우에는 필요 없었던 과정임.</ul><li>슬라이싱은 기본적으로 샤드를 기준으로 작업을 쪼개는 것이기 때문에 각 요청 슬라이스가 동일한 작업량을 분배받는것은 아니다<li>requests_per_second 옵션은 각 슬라이스에 쪼개져서 적용됨을 알아야 한다.<ul><li>requests_per_second=1000 + slices=5라면, 각 슬라이스는 200씩을 분배 받게 된다.</ul></ul><h3 id="424-delete-by-query"><span class="mr-2">4.2.4 delete by query</span><a href="#424-delete-by-query" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>delete by query는 update by query처럼 먼저 지정한 검색 쿼리로 삭제할 대상을 지정한 뒤에 삭제를 수행하는 작업이다.<li>보통은 주기적인 배치성 작업으로 오래된 데이터 등 더이상 사용하지 않는 데이터를 삭제하는 경우에 사용된다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>POST [인덱스 이름]/_delete_by_query

{
   "query": {
      // ...
   }
}
</pre></table></code></div></div><h4 id="delete-by-query-동작-방식"><span class="mr-2">delete by query 동작 방식</span><a href="#delete-by-query-동작-방식" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>update by query와 마찬가지로 검색 조건에 맞는 문서를 찾아 스냅샷을 찍는다.<li>삭제 작업이 진행되는 동안 문서의 내용이 변경됐다면 버전 충돌이 일어날떄의 처리 등 update와 동일하다.<li>이 외에 tasks API를 통한 관리, 스로틀링 적용, 슬라이싱 적용 등 모두 update와 동일하다.</ul><h2 id="43-검색-api"><span class="mr-2">4.3 검색 API</span><a href="#43-검색-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>ES의 기본이자 핵심은 검색엔진이다.<li>자주 사용되는 검색 쿼리, 쿼리 문맥과 필터 문맥, 검색 결과 정렬, 페이지네이션을 학습해보자.</ul><h3 id="431-검색-대상-지정"><span class="mr-2">4.3.1 검색 대상 지정</span><a href="#431-검색-대상-지정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>ES는 다양한 종류의 검색 쿼리를 제공한다.<li>GET/POST 중 무엇을 사용하더라도 동작은 동일하다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search
POST [인덱스 이름]/_search
GET _search
POST _search
</pre></table></code></div></div><h4 id="검색-관련"><span class="mr-2">검색 관련</span><a href="#검색-관련" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>인덱스 이름을 지정하지 않으면 전체 인덱스에 대해 검색한다.<li>인덱스 범위를 최대한 좁혀서 검색해야 성능 부담이 적으므로 일반적으로는 인덱스 이름을 명시적으로 지정한다.<li>인덱스 이름을 지정할 떄는 와일드카드 문자(*)와 콤마로 구분하여 검색 대상을 여럿 지정하는것도 가능하다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>### _search
GET /my_index*,analyzer_test*,mapping_test/_search
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">76</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	  </span><span class="p">{</span><span class="w">
		</span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello world"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"views"</span><span class="p">:</span><span class="w"> </span><span class="mi">1234</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"public"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"point"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.5</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-01-17T14:05:01.234Z"</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">},</span><span class="w">
	  </span><span class="p">{</span><span class="w">
		</span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		  </span><span class="nl">"hello"</span><span class="p">:</span><span class="w"> </span><span class="s2">"world2"</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">},</span><span class="w">
	  </span><span class="p">{</span><span class="w">
		</span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index2"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		  </span><span class="nl">"hello"</span><span class="p">:</span><span class="w"> </span><span class="s2">"world2"</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">}</span><span class="w">
	</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>위 예시처럼 검색 대상만 지정하고 쿼리 종류와 질의어를 지정하지 않으면 지정한 대상 내 모든 문서가 hit된다.</ul><h3 id="432-쿼리-dsl-검색과-쿼리-문자열-검색"><span class="mr-2">4.3.2 쿼리 DSL 검색과 쿼리 문자열 검색</span><a href="#432-쿼리-dsl-검색과-쿼리-문자열-검색" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>ES에서는 크게 요청 본문에 쿼리 DSL을 기술하여 검색하는 방법과 요청 주소줄에 q라는 매개변수를 넣고 그곳에 루씬 쿼리 문자열을 지정하는 2가지 방법을 제공한다.</ul><h4 id="쿼리-dsl-검색"><span class="mr-2">쿼리 DSL 검색</span><a href="#쿼리-dsl-검색" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>아래와 같이 요청 본문에 query 필드를 넣어 그 안에 원하는 쿼리와 질의어를 기술한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>### 쿼리 DSL
GET /my_index2/_search
Host: localhost:9200
Content-Type: application/json

{
  "query": {
    "match": {
      "title" : "hello"
    }
  }
}
</pre></table></code></div></div><h4 id="쿼리-문자열-검색"><span class="mr-2">쿼리 문자열 검색</span><a href="#쿼리-문자열-검색" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>q 매개변수에 루씬 쿼리 문자열을 넣어서 하는 방식은 다음과 같다.<li>이 요청 방식 특성상 복잡한 쿼리르 지정하기 어렵고 긴 쿼리르 전달하는 것도 부담스럽기 때문에 보통은 간단한 요청을 이용하는 경우 사용된다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>### 쿼리 문자열
GET /my_index2/_search?q=title:hello
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><h4 id="루씬-쿼리-문자열-문법-몇가지"><span class="mr-2">루씬 쿼리 문자열 문법 몇가지</span><a href="#루씬-쿼리-문자열-문법-몇가지" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/query-dsl-query-string-query.html#query-string-syntax">ES queryStirngSyntax 공식문서</a> <a href="https://blog.naver.com/occidere/222138218943">루씬 쿼리 문자열 블로그</a></p></blockquote><h4 id="루씬-쿼리-문자열--관련-참고사항"><span class="mr-2">루씬 쿼리 문자열 관련 참고사항</span><a href="#루씬-쿼리-문자열--관련-참고사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>와일드카드 검색은 서비스환경에서는 사실상 사용하지 않는것이 좋다.<ul><li><code class="language-plaintext highlighter-rouge">*ello</code> 나 <code class="language-plaintext highlighter-rouge">?ello</code>처럼 와일드카드 문자가 앞에 오는 쿼리는 부담이 더욱 심하다.(인덱스가 들고있는 모든 term을 가지고 검색을 해야함)<li>단 한번의 쿼리로 ES 클러스터 전체를 다운시킬 수도 있다.</ul><li><code class="language-plaintext highlighter-rouge">indices.query.query_string.allowLeadingWildcard</code> 설정을 false로 지정하면 와일드카 문자가 앞에 오는 쿼리르 막을 수 있다.<li><code class="language-plaintext highlighter-rouge">search.allow_expensive_queries</code> 설정을 false로 지정하면 와일드카드 검색을 포함한 몇몇 무거원 쿼리를 사용한 검색 자체를 아예 막을 수 있다.</ul><h3 id="433-match_all-쿼리"><span class="mr-2">4.3.3 match_all 쿼리</span><a href="#433-match_all-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>match_all 쿼리는 모든 문서를 매치하는 쿼리이다.(query 부분을 비워두면 기본값으로 지정됨)</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search
{
   "query": {
      "math_all": {}
   }
}
</pre></table></code></div></div><h3 id="434-match-쿼리"><span class="mr-2">4.3.4 match 쿼리</span><a href="#434-match-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>match는 지정한 필드의 내용이 질의어와 매치되는 문서를 찾는 쿼리이다.<li>필드가 text  타입이라면 질의어도 모두 애널라이저로 분석된다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "query": {
    "match": {
      "fieldName": {
        "query": "test query sentence",
        "operator": "and"
      }
    }
  }
}
</pre></table></code></div></div><ul><li>위 예제를 기준으로 설명하면 다음과 같다.<ul><li>인덱스의 fieldName 필드가 text타입고, standard 애널라이저를 사용한다면, 검색 쿼리도 test, query, sentence 총 3개의 토큰으로 분석된다.<li>match 쿼리는 기본동작이 OR로 동작하는데 위 예시에서는 <code class="language-plaintext highlighter-rouge">"operator": "and"</code>을 추가하여 위 3개의 텀에 모두 매칭되는 경우에만 검색이 이루어진다.</ul></ul><h3 id="435--term-쿼리"><span class="mr-2">4.3.5 term 쿼리</span><a href="#435--term-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>term 쿼리는 지정한 필드의 값이 질의어와 정확히 일치하는 문서를 찾는 쿼리이다.<li>필드 타입에 지정된것과 동일하게 처리됨.<ul><li>대상 필드에 노멀라이저가 지정되어 있다면 질의어도 노멀라이저 처리를 거친다.</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "query": {
    "term": {
      "fieldName": {
        "value": "hello"
      }
    }
  }
}
</pre></table></code></div></div><h4 id="term-쿼리-주의사항"><span class="mr-2">term 쿼리 주의사항</span><a href="#term-쿼리-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>keyword 타입과 보통 잘 어울리는 쿼리이다.<li>text 타입의 필드를 대상으로 하는 경우 질의어는 노멀라이저 처리를 거치지만, 필드의 값은 애널라이저로 분석한 뒤 생성된 역색인을 이용하게 된다.</ul><h3 id="436-terms-쿼리"><span class="mr-2">4.3.6 terms 쿼리</span><a href="#436-terms-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>term 쿼리와 매우 유사한데, 질의어를 여러개 지정할 수 있고, 하나 이상의 질의어가 일치하면 검색 결과에 포함하는 쿼리이다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "query": {
    "terms": {
      "fieldName": ["hello", "world"]
    }
  }
}
</pre></table></code></div></div><h3 id="437-range-쿼리"><span class="mr-2">4.3.7 range 쿼리</span><a href="#437-range-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>range 쿼리는 지정한 필드의 값이 특정 범위 내에 있는 문서를 찾는 쿼리이다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>### ex1
GET [인덱스 이름]/_search

{
  "query": {
    "range": {
      "fieldName": {
        "gte": 100,
        "lt": 200
      }
    }
  }
}

### ex2 - date
GET [인덱스 이름]/_search

{
  "query": {
    "range": {
      "fieldName": {
        "gte": "2019-01-15T00:00:00.000Z||+36h/d",
        "lt": "now-3h/d"
      }
    }
  }
}
</pre></table></code></div></div><ul><li>gt(greater than), lt(less than), gte, lte를 지정하여 range 검색을 할 수 있다.</ul><h4 id="range-query-주의사항"><span class="mr-2">range query 주의사항</span><a href="#range-query-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES 문자열 필드 대상으로 한 range 쿼리를 부학가 큰 쿼리로 분류한다.<ul><li>사용시 데이터 양상을 파악하고 부담이 없는 상황에서만 사용해야 한다.</ul><li><code class="language-plaintext highlighter-rouge">search.allow_expensive_queries</code> 설정을 false로 지정하면 막을 수 있다.</ul><h4 id="range-query에-date를-사용하는-경우-표현식"><span class="mr-2">range query에 date를 사용하는 경우 표현식</span><a href="#range-query에-date를-사용하는-경우-표현식" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">now</code>: 현재시각을 나타낼 수 있다. -<code class="language-plaintext highlighter-rouge">||</code> : 날짜 시간 문자열의 마지막에 붙이고, 이 뒤에 붙는 문자열은 시간 계산식으로 파싱된다.<li><code class="language-plaintext highlighter-rouge">+, -</code> : 지정된 시간만큼 더하거나 빼는 연산을 수행한다.<li><code class="language-plaintext highlighter-rouge">/</code> : 버림을 수행한다. (ex. /d는 날짜 단위 이하의 시간을 버림한다.)</ul><h3 id="438-prefix-쿼리"><span class="mr-2">4.3.8 prefix 쿼리</span><a href="#438-prefix-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>prefix 쿼리는 필드의 값이 지정한 질의어로 시작하는 문서를 찾는 쿼리이다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "query": {
    "prefix": {
      "fieldName": {
        "value": "hello"
      }
    }
  }
}
</pre></table></code></div></div><h4 id="prefix-사용시-주의사항"><span class="mr-2">prefix 사용시 주의사항</span><a href="#prefix-사용시-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>preifx도 무거운 쿼리로 분류되나, 와일드카드 검색처럼 아예 사용하지 말아야 할 정도는 아니다.<li>prefix를 서비스 호출 용도로 사용하려 한다면 인덱스 필드 맵핑 설정에 <code class="language-plaintext highlighter-rouge">index_prefixes</code> 설정을 넣는 방법이 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>### index_prefixes
PUT /prefix_mapping_test
Host: localhost:9200
Content-Type: application/json

{
  "mappings": {
    "properties": {
      "prefixField": {
        "type": "text",
        "index_prefixes": {
          "min_chars": 3,
          "max_chars" : 5
        }
      }
    }
  }
}
</pre></table></code></div></div><ul><li>위처럼 index_prefixes를 지정하면 ES 문서를 색인할 때 min_chars와 max_chars 사이의 prefix를 미리 별도 색인한다.<ul><li>색인 크기와 색인 속도에서 손해를 보는 대신 prefix 쿼리의 성능을 높일 수 있다.<li>min_chars의 기본값은 2이고, max_chars의 기본값은 5이다.<li><code class="language-plaintext highlighter-rouge">search.allow_expensive_queries</code> 설정을 false로 지정하면, index_prefixes가 적용되지 않은 prefix 쿼리는 사용할 수 없다.</ul></ul><h3 id="439-exists-쿼리"><span class="mr-2">4.3.9 exists 쿼리</span><a href="#439-exists-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>exists 쿼리는 지정한 필드를 포함한 문서를 검색한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "query": {
    "exists": {
      "field": "fieldName"
    }
  }
}
</pre></table></code></div></div><h3 id="4310-bool-쿼리"><span class="mr-2">4.3.10 bool 쿼리</span><a href="#4310-bool-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>bool 쿼리는 여러 쿼리를 조합하여 검색하는 쿼리이다.<li>must, must_not, filter, shoulde의 4가지 종류의 조건절에 다른 쿼리를 조합하여 사용한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "query": {
    "bool": {
      "must" : [
        { "term" : {"field1": {"value": "hello"} } },
        { "term" : {"field2": {"value": "world"} } }
      ],
      "must_not" : [
        { "term" : {"field4": {"value": "elasticsearch-test"} } }
      ],
      "filter" : [
        { "term" : {"field3": {"value": true} } }
      ],
      "should" : [
        { "match" : {"field4": {"query": "elasticsearch"} } },
        { "match" : {"field5": {"query": "lucene"} } }
      ],
      "minimum_should_match": 1
    }
  }
}
</pre></table></code></div></div><ul><li>must 조건절과 filter 조건절에 들어간 하위 쿼리는 모두 AND 조건으로 만족해야 최종 검색 결과에 포함된다.<li>must_not 조건절에 들어간 쿼리를 만족하는 문선느 최종 검색 결과에서 제외된다.<li>should 조건절에 들어간 쿼리는 minimum_should_match에 지정한 개수 이상의 하위 쿼리를 만족하는 문서가 최종 검색 결과에 포함된다.<li>minimum_should_match의 기본값은 1이고, 이 경우 should 조건절에 들어간 쿼리는 OR조건으로 검색하는 것으로 이해할 수 있다.</ul><h4 id="쿼리-문맥과-필터-문맥"><span class="mr-2">쿼리 문맥과 필터 문맥</span><a href="#쿼리-문맥과-필터-문맥" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>must와 filter는 모두 AND 조건으로 검색을 수행하지만, 점수를 계산하느냐 여부가 다르다.<ul><li>filter 조건에 들어간 쿼리는 단순히 문서 매치 여부만을 판단하고, 랭킹에 사용할 점수를 매기지 않는다.</ul><li>must_not도 점수를 매기지 않는다.<li>점수를 매기지 않고 단순히 조건을 만족하는지 여부를 참 또는 거짓으로 따지는 검색과정을 <code class="language-plaintext highlighter-rouge">필터 문맥(filter context)</code>라고 한다.<li>조건을 얼마나 더 만족하는지 유사도 점수를 매기는 검색 과정을 <code class="language-plaintext highlighter-rouge">쿼리 문맥(query context)</code> 라고 한다.<li>유사도가 필요하지 않은 경우 필터 문맥으로 검색해야 성능상 유리하다.<li>쿼리 문맥<ul><li>상대적으로 성능이 느리고, 쿼리 캐시 활용 불가<li>bool.must, bool.should, match, term</ul><li>필터 문맥<ul><li>상대적으로 성능이 빠르고, 쿼리 캐시 활용 가능<li>bool.filter, bool.must_not, exists, range, constant_score</ul></ul><h4 id="쿼리-수행-순서"><span class="mr-2">쿼리 수행 순서</span><a href="#쿼리-수행-순서" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>bool 쿼리를 사용하여 여러 쿼리를 조합하는 경우 어떤 실행순러ㅗ 수행된다는 규칙 이없다.<li>ES 내부적으로 쿼리를 루씬의 여러 쿼리로 쪼갠 뒤 조합하여 재작성하는데, 이 각 쿼리별 비용이 얼마나 소요될지는 내부적으로 추정하고, 이 추정된 비용을 기준으로 무엇을 먼저 실행할지 내부적으로 결정된다.<li>또 하부 쿼리를 병렬 수행하기도 하고, 복잡한 과정을 거친다.<li>만약 내부적인 쿼리 실행 순서를 원하는대로 해야한다면 커스텀 플러그인에서 커스텀 쿼리를 만들어야 한다.</ul><h3 id="4311-constant_score-쿼리"><span class="mr-2">4.3.11 constant_score 쿼리</span><a href="#4311-constant_score-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>constant_score 쿼리는 하위 filter 부분에 지정한 쿼리를 필터 문맥에서 검색하는 쿼리이다.<li>유사도는 일괄적으로 1로 지정된다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>### 4.3.11 constant_score 쿼리
GET [인덱스 이름]/_search

{
  "query": {
    "constant_score": {
      "filter" : {
        "term": {
          "fieldName": "hello"
        }
      }
    }
  }
}
</pre></table></code></div></div><h3 id="4312-그-외-주요-매개변수"><span class="mr-2">4.3.12 그 외 주요 매개변수</span><a href="#4312-그-외-주요-매개변수" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>쿼리 종류와 관계 없이 검색 API에 공통적으로 적용할 수 있는 주요 매개변수 몇가지를 알아보자</ul><h4 id="라우팅-2"><span class="mr-2">라우팅</span><a href="#라우팅-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>라우팅 지정 여부가 가져오는 성능차이가 크다.<li>라우팅을 지정할 수 있는 경우라면 최대한 라우팅 이득을 볼수 있도록 설계하자(ex. 특정 사용자 기준으로 데이터를 관리하는 경우)</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>### 라우팅
GET [인덱스이름]/_search?routing=i[라우팅]

{
  "query": {
       // ...
  }
}
</pre></table></code></div></div><h4 id="explain"><span class="mr-2">explain</span><a href="#explain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>검색을 수행하는 동안 쿼리의 각 하위 부분에서 점수가 어떻게 계산됐는지 설명을 확인하기 위해 explain을 사용할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>GET [인덱스이름]/_search?explain=true

{
  "query": {
       // ...
  }
}
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>GET /my_index3/_search?explain=true
Host: localhost:9200
Content-Type: application/json

{
  "query": {
    "bool": {
      "must" : [
        { "term" : {"field1": {"value": "hello"} } },
        { "term" : {"field2": {"value": "world"} } }
      ],
      "must_not" : [
        { "term" : {"field4": {"value": "elasticsearch-test"} } }
      ],
      "filter" : [
        { "term" : {"field3": {"value": true} } }
      ],
      "should" : [
        { "match" : {"field4": {"query": "elasticsearch"} } },
        { "match" : {"field5": {"query": "lucene"} } }
      ],
      "minimum_should_match": 1
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1507283</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	  </span><span class="p">{</span><span class="w">
		</span><span class="nl">"_shard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[my_index3][0]"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_node"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b_fDpGOqSWOciib82ngCTA"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index3"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1507283</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		  </span><span class="nl">"field1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"world"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field3"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field4"</span><span class="p">:</span><span class="w"> </span><span class="s2">"elasticsearch"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field5"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lucene"</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="nl">"_explanation"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1507283</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sum of:"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
			</span><span class="p">{</span><span class="w">
			  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"weight(field1:hello in 0) [PerFieldSimilarity], result of:"</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
				</span><span class="p">{</span><span class="w">
				  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"score(freq=1.0), computed as boost * idf * tf from:"</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.2</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boost"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"n, number of documents containing term"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N, total number of documents with field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.45454544</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"freq, occurrences of term within document"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k1, term saturation parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.75</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b, length normalization parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dl, length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avgdl, average length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">}</span><span class="w">
				  </span><span class="p">]</span><span class="w">
				</span><span class="p">}</span><span class="w">
			  </span><span class="p">]</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="p">{</span><span class="w">
			  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"weight(field2:world in 0) [PerFieldSimilarity], result of:"</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
				</span><span class="p">{</span><span class="w">
				  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"score(freq=1.0), computed as boost * idf * tf from:"</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.2</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boost"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"n, number of documents containing term"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N, total number of documents with field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.45454544</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"freq, occurrences of term within document"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k1, term saturation parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.75</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b, length normalization parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dl, length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avgdl, average length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">}</span><span class="w">
				  </span><span class="p">]</span><span class="w">
				</span><span class="p">}</span><span class="w">
			  </span><span class="p">]</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="p">{</span><span class="w">
			  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"weight(field4:elasticsearch in 0) [PerFieldSimilarity], result of:"</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
				</span><span class="p">{</span><span class="w">
				  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"score(freq=1.0), computed as boost * idf * tf from:"</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.2</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boost"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"n, number of documents containing term"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N, total number of documents with field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.45454544</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"freq, occurrences of term within document"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k1, term saturation parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.75</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b, length normalization parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dl, length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avgdl, average length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">}</span><span class="w">
				  </span><span class="p">]</span><span class="w">
				</span><span class="p">}</span><span class="w">
			  </span><span class="p">]</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="p">{</span><span class="w">
			  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"weight(field5:lucene in 0) [PerFieldSimilarity], result of:"</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
				</span><span class="p">{</span><span class="w">
				  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"score(freq=1.0), computed as boost * idf * tf from:"</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.2</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boost"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2876821</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"n, number of documents containing term"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N, total number of documents with field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
					  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.45454544</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:"</span><span class="p">,</span><span class="w">
					  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"freq, occurrences of term within document"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k1, term saturation parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.75</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b, length normalization parameter"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dl, length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">},</span><span class="w">
						</span><span class="p">{</span><span class="w">
						  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avgdl, average length of field"</span><span class="p">,</span><span class="w">
						  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
						</span><span class="p">}</span><span class="w">
					  </span><span class="p">]</span><span class="w">
					</span><span class="p">}</span><span class="w">
				  </span><span class="p">]</span><span class="w">
				</span><span class="p">}</span><span class="w">
			  </span><span class="p">]</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="p">{</span><span class="w">
			  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"match on required clause, product of:"</span><span class="p">,</span><span class="w">
			  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
				</span><span class="p">{</span><span class="w">
				  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"# clause"</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
				</span><span class="p">},</span><span class="w">
				</span><span class="p">{</span><span class="w">
				  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"field3:T"</span><span class="p">,</span><span class="w">
				  </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
				</span><span class="p">}</span><span class="w">
			  </span><span class="p">]</span><span class="w">
			</span><span class="p">}</span><span class="w">
		  </span><span class="p">]</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">}</span><span class="w">
	</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">_explanation</code> 부분에서 점수 계산 과정의 상세한 설명을 확인 할 수 있다.<li><code class="language-plaintext highlighter-rouge">_explanation</code>을 만들기 위해 내부적으로 쿼리를 덜 최적화해 수행하기도 하므로, 성능이 비교적 하락할 수 있다.<ul><li>서비스 환경에서는 사용하지 않고 디버깅 용도로만 사용하는 것이 좋다.</ul><li>각 조건들을 검색할떄 나왔던 score를 합산하여 최종 score가 결정됨.</ul><h4 id="search_type"><span class="mr-2">search_type</span><a href="#search_type" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>search_type을 지정하면 유사도 점수를 계산할 때 각 샤드 레벨에서 계산을 끝낼지 여부를 선택할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search?search_type=dfs_query_then_fetch

{
  "query": {
      // ...
  }
}

</pre></table></code></div></div><ul><li>query_then_fetch(기본값)<ul><li>각 샤드 레벨에서 유사도 점수 계싼을 끝낸다.<li>점수 계산이 약간 부정확할 수 있지만, 검색 성능의 차이가 크기 때문에 특별한 경우가 아니라면 이대로 사용하는것을 권장</ul><li>dfs_query_then_fetch<ul><li>모든 샤드로부터 정보를 모아 유사도 점수를 글로벌하게 계산한다.<li>점수의 정확도는 올라가지만 검색 성능은 떨어진다.</ul></ul><h3 id="4313-검색-결과-정렬"><span class="mr-2">4.3.13. 검색 결과 정렬</span><a href="#4313-검색-결과-정렬" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>요청 본문에 <code class="language-plaintext highlighter-rouge">sort</code>를 지정하면 검색 결과를 정렬할 수 있다.<li>정렬 대상 필드를 여러개로 지정하는 경우 요청에 지정한 순서대로 정렬을 수행한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "query": {
    // ...
  },
  "sort": [
    {"field1": {"order": "desc"} },
    {"field2": {"order": "asc"} },
    "field3"
  ]
}
</pre></table></code></div></div><h4 id="정렬시-유의사항"><span class="mr-2">정렬시 유의사항</span><a href="#정렬시-유의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES에서는 필드타입에 따라서 정렬에 사용할 수 있는 타입과 불가능한 타입이 있다.<ul><li>숫자, date, boolean, keyword 타입은 정렬 대상이 될수 있다.<li>text 타입은 정렬 불가능하다.<li>fielddata를 true로 지정하면 text 타입도 정렬에 사용할수 있으나, 성능문제가 있으므로 사용을 지양해야 한다.</ul><li>정렬에서 _score, _doc을 지정해서 정렬을 수행할 수도 있다.<li>sort 기본값은 _score 내림차순으로 조회된다.<li>정렬 수행을 위해서는 필드의 값이 메모리에 올라가야하는데 운영환경 서비스 사용시 정렬 대상 필드를 integer, short, float 등 타입으로 설계하는 것도 좋은 방법이다.</ul><h3 id="4314-페이지네이션"><span class="mr-2">4.3.14. 페이지네이션</span><a href="#4314-페이지네이션" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>검색 결과를 페이지네이션하는 방법을 알아보자.</ul><h4 id="from과-size"><span class="mr-2">from과 size</span><a href="#from과-size" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>size는 검색 API의 결과로 몇 개의 문서를 반환할것인지를 지정한다.(기본값 : 10)<li>from은 몇 번쨰 문서부터 결과를 반환할지에 대한 오프셋을 지정한다.(기본값 : 0)</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search

{
  "from": 0,
  "size": 10,
  "query": {
    // ...
  }
}
</pre></table></code></div></div><h4 id="from과-size-방식의-한계점"><span class="mr-2">from과 size 방식의 한계점</span><a href="#from과-size-방식의-한계점" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>실제로 페이지네이션을 구현할때 from, size는 제한적으로 사용해야 한다.<li>내부적으로 MySQL의 limit-offset 방식의 쿼리처럼 동작하여 페이지 후반부로 갈수록 성능 이슈가 있을수 있음.<ul><li>예를 들어 from:15, size:5로 지정한 검색을 하는 경우 상위 20개 문서를 가져온 뒤에 하위 5개만 잘라서 반환하는 방식으로 동작한다.</ul><li>이전 페이지를 검색할 떄의 상태와 페이지를 넘기고 다음 검색을 수행할 때 인덱스 상태가 동일하지 않을수 있다는 문제가 있다.<ul><li>페이징 검색 요청 사이에 새로운 문서가 색인되거나 삭제될 경우 의도한 페이지의 신규 데이터를 조회하는것이 아니라 데이터가 겹칠수 있다.</ul><li>엄격한 페이지네이션을 제공해야 할 경우 from, size는 사용하지 않아야 한다.<li>ES에서 from + size 합이 10,000을 넘어서는 검색은 수행을 제한하고 있다.<ul><li><code class="language-plaintext highlighter-rouge">index.max_result_window</code> 값을 조정해 변경할 수 있지만 비권장</ul></ul><h4 id="scroll"><span class="mr-2">scroll</span><a href="#scroll" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>scroll은 검색 조건에 매칭되는 전체 문서를 모두 순회해야 할 때 적합한 방법이다.<li>scroll은 순회하는 동안에는 최초 검색시 문맥(search_context)가 유지되어, 중복이나 누락이 발생하지 않는다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search?scroll=1m

{
  "size": 1000,
  "query": {
    "bool": {
      "must" : [
        { "term" : {"field1": {"value": "hello"} } },
        { "term" : {"field2": {"value": "world"} } }
      ]
    }
  }
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_scroll_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFnA3S3pUN1JnU1dpYzdVU2tPSEltVGcAAAAAAAACDhZiX2ZEcEdPcVNXT2NpaWI4Mm5nQ1RB"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	</span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
	</span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
	  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
	  </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5753642</span><span class="p">,</span><span class="w">
	</span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	  </span><span class="p">{</span><span class="w">
		</span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_index3"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5753642</span><span class="p">,</span><span class="w">
		</span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		  </span><span class="nl">"field1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"world"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field3"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field4"</span><span class="p">:</span><span class="w"> </span><span class="s2">"elasticsearch"</span><span class="p">,</span><span class="w">
		  </span><span class="nl">"field5"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lucene"</span><span class="w">
		</span><span class="p">}</span><span class="w">
	  </span><span class="p">}</span><span class="w">
	</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>첫번쨰 scroll 검색을 할떄 scroll_id가 반환되는데, 이 값을 기준으로 scroll 검색을 수행하면 되고, 빈 hits 응답이 올때까지 scroll 검색을 반복하면 된다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>GET /_search/scroll
Host: localhost:9200
Content-Type: application/json

{
  "scroll_id": "FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFnA3S3pUN1JnU1dpYzdVU2tPSEltVGcAAAAAAAACSBZiX2ZEcEdPcVNXT2NpaWI4Mm5nQ1RB",
  "scroll": "1m"
}
</pre></table></code></div></div><h4 id="수동-검색-문맥-삭제"><span class="mr-2">수동 검색 문맥 삭제</span><a href="#수동-검색-문맥-삭제" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>빠른 자원 반납을 위해 아래와 같이 명시적으로 검색 문맥을 삭제할수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>DELETE /_search/scroll
Host: localhost:9200
Content-Type: application/json

{
  "scroll_id": "FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFnA3S3pUN1JnU1dpYzdVU2tPSEltVGcAAAAAAAACSBZiX2ZEcEdPcVNXT2NpaWI4Mm5nQ1RB"
}
</pre></table></code></div></div><h4 id="scroll-검색시-성능-향상"><span class="mr-2">scroll 검색시 성능 향상</span><a href="#scroll-검색시-성능-향상" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>scroll 검색은 검색 결과의 정렬 여부가 상관없는 작업에 주로 사용하는 경우가 많은데, 이 경우 <code class="language-plaintext highlighter-rouge">_doc</code>으로 정렬을 지정하면 유사도 점수를 계산하지 않으며, 정렬을 위한 별도의 자원도 사용하지 않아서 성능을 끌어올릴 수 있다.<ul><li>sort의 기본값이 _score desc임을 기억하자</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>GET [인덱스 이름]/_search?scroll=1m

{
  "size": 1000,
  "query": {
    // ...
  },
  "sort": ["_doc"]
}
</pre></table></code></div></div><h4 id="scroll의-사용-목적"><span class="mr-2">scroll의 사용 목적</span><a href="#scroll의-사용-목적" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>scroll API는 사실 서비스에서 지속적으로 호출하는 용도로는 적합하지 않다.<li>주로 대량의 데이터를 다른 스토리지로 이전하거나 덤프하는 용도로 사용된다.</ul><h4 id="search_after"><span class="mr-2">search_after</span><a href="#search_after" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>서비스에서 사용자에게 검색 결과를 페이지네이션으로 제공하는 경우 <code class="language-plaintext highlighter-rouge">search_after</code>을 사용하는 것이 가장 적합하다.<li>search_after는 기본적으로 search의 sort을 활용하여 처리한다.<li>이 떄 정렬조건이 동점이 나오지 않도록 정렬 필드를 지정해야 한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 20,
  "query": {
    "term": {
      "currency" : {
        "value": "EUR"
      }
    }
  },
  "sort": [
    {
      "order_date": "desc"
    },
    {
      "order_id": "asc"
    }
  ]
}
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nl">"sort"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
   </span><span class="mi">1704573590000</span><span class="p">,</span><span class="w">
   </span><span class="s2">"591924"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></table></code></div></div><ul><li>첫 번쨰 검색이 끝나면 검색 결과 sort 값을 가져와 search_after 부분에 넣어 그 다음 검색을 요청할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>### search_after next
GET /kibana_sample_data_ecommerce/_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 20,
  "search_after" : [ 1704573590000, "591924" ],
  "query": {
    "term": {
      "currency" : {
        "value": "EUR"
      }
    }
  },
  "sort": [
    {
      "order_date": "desc"
    },
    {
      "order_id": "asc"
    }
  ]
}
</pre></table></code></div></div><h4 id="search_after의-동점-제거용-필드-지정시-주의사항"><span class="mr-2">search_after의 동점 제거용 필드 지정시 주의사항</span><a href="#search_after의-동점-제거용-필드-지정시-주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">_id</code> 값을 동점 제거용 기준 필드로는 사용을 지양해야 한다.<ul><li><code class="language-plaintext highlighter-rouge">_id</code> 필드는 doc_values가 꺼져 있기 때문에 이를 기준으로 정렬하게 되면 많은 메모리를 사용하게 된다.</ul><li>동점 제거용 필드를 제대로 지정했다 하더라도, 인덱스 상태가 변하는 도중이라면 페이지네이션 과정에서 누락되는 문서가 발생할수 있다.<li>인덱스의 상태를 특정 시점으로 고려하려면 point in time API를 함께 조합해서 사용해야 한다.</ul><h4 id="point-in-time-api"><span class="mr-2">point in time API</span><a href="#point-in-time-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>point in time API는 검색 대상의 상태를 고정할 때 사용한다. keep_live 매개변수에 상태를 유지할 시간을 지정한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>POST /kibana_sample_data_ecommerce/_pit?keep_alive=1m
Host: localhost:9200
Content-Type: application/json
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gcSHBAEca2liYW5hX3NhbXBsZV9kYXRhX2Vjb21tZXJjZRZsMFQydEtZeVRuZWdHQmhxRjh0STV3ABZmOEFhOXNqLVJiYU9lYnIzYWNEY3hRAAAAAAAAAAueFkdhdW1CUXBtUmFLdURtam1SdFhiVVEAARZsMFQydEtZeVRuZWdHQmhxRjh0STV3AAA="</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>이렇게 얻은 pit id를 search_after와 같은곳에서 활용할 수 있다.<li>pit id가 있는 상태에서는 대상 인덱스를 지정하지 않고 search한다.<ul><li>pit를 지정하는 것 자체가 검색 대상을 지정하는것이기 떄문이다.<li>pit을 지정하면 동점 제거용 필드도 별도로 지정할 필요가 없다.</ul><li>search_after를 사용하는것은 이 search api 응답에 전달받은 sort 값을 기준으로 동일하게 사용하면 된다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>GET /_search
Host: localhost:9200
Content-Type: application/json

{
  "size": 20,
  "query": {
    "term": {
      "currency" : {
        "value": "EUR"
      }
    }
  },
  "sort": [
    {
      "order_date": "desc"
    },
    {
      "order_id": "asc"
    }
  ],
  "pit": {
    "id": "gcSHBAEca2liYW5hX3NhbXBsZV9kYXRhX2Vjb21tZXJjZRZsMFQydEtZeVRuZWdHQmhxRjh0STV3ABZmOEFhOXNqLVJiYU9lYnIzYWNEY3hRAAAAAAAAAAw1FkdhdW1CUXBtUmFLdURtam1SdFhiVVEAARZsMFQydEtZeVRuZWdHQmhxRjh0STV3AAA=",
    "keep_alive": "1m"
  }
}
</pre></table></code></div></div><h4 id="pit-명시적인-삭제"><span class="mr-2">pit 명시적인 삭제</span><a href="#pit-명시적인-삭제" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>pit을 다 사용한 뒤에는 명시적으로 삭제 할 수 있다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>DELETE /_pit
Host: localhost:9200
Content-Type: application/json

{
  "id": "gcSHBAEca2liYW5hX3NhbXBsZV9kYXRhX2Vjb21tZXJjZRZsMFQydEtZeVRuZWdHQmhxRjh0STV3ABZmOEFhOXNqLVJiYU9lYnIzYWNEY3hRAAAAAAAAAAw1FkdhdW1CUXBtUmFLdURtam1SdFhiVVEAARZsMFQydEtZeVRuZWdHQmhxRjh0STV3AAA="
}
</pre></table></code></div></div><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.11/search-your-data.html">ES 공식 Reference</a><li><a href="https://mutpp.tistory.com/10">HTTP Chunk 참고</a><li><a href="https://blog.naver.com/occidere/222138218943">루씬 쿼리 문자열 블로그</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/elasticsearch/'>Elasticsearch</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >Elasticsearch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-1%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-1%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-1%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-1%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-1%2F&text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-1%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/es-bible-1/"><div class="card-body"> <em class="small" data-ts="1700127840" data-df="ll" > Nov 16, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 1. 엘라스틱 서치 소개</h3><div class="text-muted small"><p> 1. 엘라스틱 서치 소개 Elasticsearch는 2010년 2월 샤이 베논이 아파치의 루씬 라이브러리를 기반으로 만든 분산 검색 엔진 2013년에 데이터를 손쉽게 시각화하는 Kibana와 색인 데이터 수집&amp;amp;변환을 하는 Logstash 프로젝트에 엘라스틱에 합류 엘라스틱서치는 현재 검색 엔진 분야에서 가장 각광받고 있는 시스템이다...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-2/"><div class="card-body"> <em class="small" data-ts="1700218920" data-df="ll" > Nov 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</h3><div class="text-muted small"><p> 2. 엘라스틱 서치 기본 동작과 구조 엘라스틱서치의 구조를 어느정도 먼저 이해한 상태에서 상세 내용을 학습해야 전체 학습에 깊이가 생긴다. 이번 장을 마치고 나면 엘라스틱서치가 어떻게 동작하는지 큰 그림을 머릿속에 그릴수 있을것이다. 2.1 엘라스틱서치 기본 동작 빠르게 둘러보기 실습 과정에서는 기본적으로 REST API를 호출해 진...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-3-1/"><div class="card-body"> <em class="small" data-ts="1700301000" data-df="ll" > Nov 18, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</h3><div class="text-muted small"><p> 3. 인덱스 설계 - 1 ES의 인덱스는 아주 세부적인 부분까지 설정으로 제어할 수 있다. 이 설정에 따라 동작과 특성이 매우 달라지므로 인덱스 설계에 신경써야 한다. 맵핑, 필드 타입, 애널라이저 등 핵심적인 설정을 학습해 ES 인덱스에 대한 이해도를 높여보자. 3.1 인덱스 설정 인덱스 생성시 동작에 관한 설정을 지정할 수 있...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/es-bible-3-2/" class="btn btn-outline-primary" prompt="Older"><p>[엘라스틱서치 바이블] 3. 인덱스 설계 -2</p></a> <a href="/posts/es-bible-4-2/" class="btn btn-outline-primary" prompt="Newer"><p>[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/es-bible-4-1/'; this.page.identifier = '/posts/es-bible-4-1/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>

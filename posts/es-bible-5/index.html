<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성 5.1 운영 환경을 위한 설정과 클러스터 구성 5.1.1 노드 설정과 노드 역할 ES 클러스터 내에서 각 노드가 수행하는 역할의 종류에 대해 알아보자" /><meta property="og:description" content="[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성 5.1 운영 환경을 위한 설정과 클러스터 구성 5.1.1 노드 설정과 노드 역할 ES 클러스터 내에서 각 노드가 수행하는 역할의 종류에 대해 알아보자" /><link rel="canonical" href="https://sungsu9022.github.io/posts/es-bible-5/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/es-bible-5/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-01-06T19:53:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2024-01-06T19:53:00+09:00","datePublished":"2024-01-06T19:53:00+09:00","description":"[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성 5.1 운영 환경을 위한 설정과 클러스터 구성 5.1.1 노드 설정과 노드 역할 ES 클러스터 내에서 각 노드가 수행하는 역할의 종류에 대해 알아보자","headline":"[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/es-bible-5/"},"url":"https://sungsu9022.github.io/posts/es-bible-5/"}</script><title>[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성 | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1704538380" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 6, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="7443 words"> <em>41 min</em> read</span></div></div></div><div class="post-content"><h1 id="엘라스틱서치-바이블-5-서비스-환경에-클러스터-구성">[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성</h1><h2 id="51-운영-환경을-위한-설정과-클러스터-구성"><span class="mr-2">5.1 운영 환경을 위한 설정과 클러스터 구성</span><a href="#51-운영-환경을-위한-설정과-클러스터-구성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="511-노드-설정과-노드-역할"><span class="mr-2">5.1.1 노드 설정과 노드 역할</span><a href="#511-노드-설정과-노드-역할" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>ES 클러스터 내에서 각 노드가 수행하는 역할의 종류에 대해 알아보자</ul><h4 id="노드-역할"><span class="mr-2">노드 역할</span><a href="#노드-역할" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>클러스터 구성시 반드시 노드에 역할을 지정해야 한다.<li>지정된 역할에 따라 노드가 클러스터 내에서 어떤 작업을 담당할지 정해진다.</ul><h5 id="마스터-후보master-eligible-노드"><span class="mr-2">마스터 후보(master-eligible) 노드</span><a href="#마스터-후보master-eligible-노드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>노드의 역할에 master를 지정하면 해당 노드는 마스터 후보 노드가 된다.<li>마스터 후보 노드 중에서 선거를 통해 마스터 노드가 선출된다.<li>마스터 노드는 클러스터를 관리하는 역할을 수행한다.<li>인덳 생성이나 삭제, 어떤 샤드를 어느 노드에 할당할 것인지 등 중요한 작업을 수행한다.</ul><h5 id="데이터-노드"><span class="mr-2">데이터 노드</span><a href="#데이터-노드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>실제 데이터를 들고 있는 노드이다.<li>CRUD, 검색, 집계와 같이 데이터와 관련된 작업을 수행한다.</ul><h5 id="인제스트ingest-노드"><span class="mr-2">인제스트(ingest) 노드</span><a href="#인제스트ingest-노드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>데이터가 색인되기 전에 전처리를 수행하는 인제스트 파이프라인을 수행하는 노드이다.<li>간략히 살펴보면 데이터(Document)가 파이프라인을 통해 들어올떄 lowercase와 같은 전처리 등을 수행한다고 보면 된다.<li>자세한 내용은 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html">ES Doc Ingest</a> 을 참고하자.</ul><h5 id="조정-노드"><span class="mr-2">조정 노드</span><a href="#조정-노드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>클라이언트의 요청을 받아서 다른 노드에 요청을 분배하고, 클라이언트에게 최종 응답을 돌려주는 노드이다.<li>기본적으로 모든 노드가 조정 노드 역할을 수행한다.<li>마스터나 데이터 등 주요 역할을 수행하지 않고, 조정 역할만 수행하는 노드는 조정 전용 노드라고 한다.</ul><h5 id="원격-클러스터-클라이언트-노드"><span class="mr-2">원격 클러스터 클라이언트 노드</span><a href="#원격-클러스터-클라이언트-노드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>다른 ES 클러스터에 클라이언트로 붙을 수 있는 노드이다.<li>노드 역할에 <code class="language-plaintext highlighter-rouge">remote_cluster_client</code>을 추가해 지정한다.<li>키바나의 스택 모니터링 기능을 활용해서 모니터링 전용 클러스ㅓ터를 구축한 뒤 얼럿 메시지를 보내도록 구성하거나 유료 기능인 클러스터간 검색 기능 등을 활용할 때 사용된다.</ul><h5 id="데이터-티어-노드"><span class="mr-2">데이터 티어 노드</span><a href="#데이터-티어-노드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>데이터 노드를 용도 및 성능별로 hot-warm-cold-frozen 티어로 구분해 저장하는 데이터 티어 구조 채택시 사용하는 역할이다.<li>data 역할 대신에 data_content, data_hot, data_warm, data_cold, data_frozen 역할을 선택한다.</ul><h4 id="configelasticsearchyml"><span class="mr-2"><code class="language-plaintext highlighter-rouge">config/elasticsearch.yml</code></span><a href="#configelasticsearchyml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>클러스터 구성시 위 confg 파일을 통해 설정을 할수 있다.</ul><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="na">node.roles</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">data</span><span class="pi">,</span> <span class="nv">master</span><span class="pi">,</span> <span class="nv">ingest</span><span class="pi">]</span>

<span class="na">cluster.name</span><span class="pi">:</span> <span class="s">test-es</span>
<span class="na">node.name</span><span class="pi">:</span> <span class="s">test-es-node01</span>

<span class="na">http.port</span><span class="pi">:</span> <span class="m">9200</span>
<span class="na">transport.port</span><span class="pi">:</span> <span class="s">9300-9400</span>
<span class="na">network.host</span><span class="pi">:</span> <span class="s">my_server_ip</span>

<span class="na">path</span><span class="pi">:</span>
    <span class="na">data</span><span class="pi">:</span> <span class="s">/var/lib/elasticsearch/logs</span>
    <span class="na">logs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/log/elasticsearch/data1</span>
      <span class="pi">-</span> <span class="s">/var/log/elasticsearch/data2</span>

<span class="na">network.host</span><span class="pi">:</span> <span class="s">10.0.0.1</span>
<span class="na">network.bind_host</span><span class="pi">:</span> <span class="s">0.0.0.0</span>

<span class="na">discovery.seed_hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">10.0.0.1"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">10.0.0.2"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">some-host-name.net"</span><span class="pi">]</span>

<span class="na">cluster.initial_master_nodes</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">node_name-1"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">node_name-2"</span> <span class="s2">"</span><span class="s">node_name-3"</span><span class="pi">]</span>
<span class="na">xpack.monitoring.enabled</span><span class="pi">:</span> <span class="kc">false</span>
</pre></table></code></div></div><h5 id="noderoles"><span class="mr-2">node.roles</span><a href="#noderoles" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>노드 역할을 지정한다. (master, data ,ingest 등)<li>0개 이상을 조합할 수 있다.<li><code class="language-plaintext highlighter-rouge">[]</code>와 같이 비워두면 조정 전용 노드가 된다.<li>하나의 노드가 여러 역할을 할수 있으나, 운영 환경에서는 마스터 후보 역할과 데이터 역할을 분리하는 것이 좋다.</ul><h5 id="discoveryseed_hosts"><span class="mr-2">discovery.seed_hosts</span><a href="#discoveryseed_hosts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>마스터 노드로 동작할 수 있는 노드 목록을 지정한다.</ul><h5 id="clusterinitial_master_nodes"><span class="mr-2">cluster.initial_master_nodes</span><a href="#clusterinitial_master_nodes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>클러스터를 처음 기동할 떄 첫 마스터 선거를 수행할 후보 노드 목록을 지정한다. (node.name에 기입한 값)</ul><h5 id="networkbind_host-networkpublish_post"><span class="mr-2">network.bind_host, network.publish_post</span><a href="#networkbind_host-networkpublish_post" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>bind_host는 ES에 바인딩할 네트워크 주소를 지정한다.<li>publish_post는 클러스터의 다른 노드에게 자신을 알릴 떄 쓰는 주소를 지정한다.<li>network.host에 지정한 값을 입력한다.</ul><h5 id="tansportport"><span class="mr-2">tansport.port</span><a href="#tansportport" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>transport 통신을 위해 사용하는 포트를 지정한다.</ul><h5 id="pathdata"><span class="mr-2">path.data</span><a href="#pathdata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>데이터 디렉터리를 지정할 수 있다.<li>여러 경로를 지정할수 있는 부분은 7.13버전부터 지원 중단되었다.</ul><h3 id="512-그-외-필요한-주요-설정"><span class="mr-2">5.1.2 그 외 필요한 주요 설정</span><a href="#512-그-외-필요한-주요-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="힙--크기"><span class="mr-2">힙 크기</span><a href="#힙--크기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>적절한 힙 크기 지정은 ES 클러스터 운영에서 아주 중요하다.<li>힙 크기는 <code class="language-plaintext highlighter-rouge">config/jvm.options</code>를 열어 다음과 같은 방식으로 지정한다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>vim config/jvm.options.d/heap-size.options

<span class="nt">-Xms32736m</span>
<span class="nt">-Xmx32736m</span>
</pre></table></code></div></div><h5 id="힙-크기-지정-관련-대원칙"><span class="mr-2">힙 크기 지정 관련 대원칙</span><a href="#힙-크기-지정-관련-대원칙" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li><ol><li>최소한 시스템 메모리의 절반 이하로 지정해야 한다. 시스템 메모리의 절반은 운영체제가 캐시로 쓰도록 놔두는것이 좋다.<ul><li>루씬이 커널 시스템 캐시를 많이 활용하기 떄문이다.</ul></ol><li><ol><li>힙 크기를 32GB 이상 지정하지 않아야 한다.<ul><li>ES는 512GB 이상의 고용량 메모리를 갖춘 서버를 사용하더라도 힙 크기는 32GB 이하로 가이드한다.<li>JVM이 힙 영역에 생성된 객체에 접근하기 위한 포인터(Ordinary Object Pointer)을 통해 처리되는데, 32비트 환경에서는 포인터 1개를 32비트로, 64비트 환경에서는 64비트로 표현하므로, 4GB를 넘어서는 힙을 사용한다면 32비트 OOP로는 불가능하고, 64비트 OOP를 사용하는 경우에도 최대 32GB까지만 가능하다.<li>다만, 32GB 이내 힙 영역에만 접근한다면 CompressedOOPs라는 기능을 적용해 포인터를 32비트로 유지할 수 있다. 하지만 정확한것은 확인을 통해 CompressedOOPs 값이 true가 되는 경계값으로 힙 크기를 지정해야 한다.</ul></ol></ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>java <span class="nt">-Xmx32736m</span> <span class="nt">-XX</span>:+PrintFlagsfinal 2&gt; /dev/null | <span class="nb">grep </span>UseCompressedOops
java <span class="nt">-Xmx32737m</span> <span class="nt">-XX</span>:+PrintFlagsfinal 2&gt; /dev/null | <span class="nb">grep </span>UseCompressedOops

java <span class="nt">-XX</span>:+UnlockDiagnosticVMOptions <span class="nt">-Xlog</span>:gc+heap+coops<span class="o">=</span>debug <span class="nt">-Xmx30721m</span> <span class="nt">-version</span>
java <span class="nt">-XX</span>:+UnlockDiagnosticVMOptions <span class="nt">-Xlog</span>:gc+heap+coops<span class="o">=</span>debug <span class="nt">-Xmx30720m</span> <span class="nt">-version</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>[0.002s][debug][gc,heap,coops] Protected page at the reserved heap base: 0x0000000280000000 / 16777216 bytes
[0.002s][debug][gc,heap,coops] Heap address: 0x0000000281000000, size: 30720 MB, Compressed Oops mode: Non-zero based: 0x0000000280000000, Oop shift amount: 3
openjdk version "17.0.6" 2023-01-17 LTS
OpenJDK Runtime Environment Zulu17.40+19-CA (build 17.0.6+10-LTS)
OpenJDK 64-Bit Server VM Zulu17.40+19-CA (build 17.0.6+10-LTS, mixed mode, sharing)
</pre></table></code></div></div><ul><li>엄밀히 테스트하기 어렵다면 <code class="language-plaintext highlighter-rouge">Compressed Oops mode</code> 가 <code class="language-plaintext highlighter-rouge">Zero based</code> 선까지 낮추는것을 권장한다.</ul><h4 id="스와핑"><span class="mr-2">스와핑</span><a href="#스와핑" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES는 스와핑을 사용하지 않도록 강력히 권고한다.<li>스와핑은 성능과 노드 안정성에 큰 영향을 미친다.<li>ms단위로 끝나야 할 GC를 분 단위 시간까지 걸리게 만들기도 한다. 스와핑을 켜는것보다 차라리 OS가 노드를 kill 시키도록 놔두는것이 낫다고 가이드한다.</ul><h5 id="스와핑을-완전히-끄기"><span class="mr-2">스와핑을 완전히 끄기</span><a href="#스와핑을-완전히-끄기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>아래 명령어를 통해 OS의 스와핑을 완전히 끌수 있다.<li>이 명령 전후에 ES 노드를 재기동하지 않아도 되나, OS 재부팅 후에도 설정을 유지하고 싶다면 <code class="language-plaintext highlighter-rouge">/etc/fstab</code> 내부의 <code class="language-plaintext highlighter-rouge">swap</code> 부분을 제거해야 한다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>swapoff <span class="nt">-a</span>

<span class="nb">sudo </span>vim /etc/fstab
</pre></table></code></div></div><h4 id="swapiness-설정"><span class="mr-2">swapiness 설정</span><a href="#swapiness-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>스와핑을 완전히 끌 수 없는 특수한 상황이라면 <code class="language-plaintext highlighter-rouge">swapiness</code> 값을 1로 설정하여 스와핑 경향성을 최소화할 수 있다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>sysctl vm.swappiness
vm.swappiness <span class="o">=</span> 30

<span class="nb">sudo </span>sysctl <span class="nt">-w</span> vm.swappiness<span class="o">=</span>1

<span class="c"># os 재부팅 후에도 유지시키고 싶다면 아래 파일 수정</span>
<span class="nb">sudo </span>vim /etc/sysctl.d/98-elasticsearch.conf
vm.swappiness <span class="o">=</span> 1
</pre></table></code></div></div><h5 id="bootstrapmemory_lock-설정"><span class="mr-2">bootstrap.memory_lock 설정</span><a href="#bootstrapmemory_lock-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li><code class="language-plaintext highlighter-rouge">bootstrap.memory_lock: true</code> 설정을 지정하여 프로세스의 주소 공간을 메모리로 제한시키고, 스와핑되는것을 막을 수 있다. -그러나 이방법은 애플리케이션 레벨에서만 의미가 있는 제한적인 기술이다.(OS 차원에서 이 설정을 무시하고 스와핑이 발생할 수 있다.)</ul><h4 id="vmmax_map_count"><span class="mr-2">vm.max_map_count</span><a href="#vmmax_map_count" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">vm.max_map_count</code> 값은 프로세스가 최대 몇 개까지 메모리 맵 영역을 가질수 있는지를 지정한다.<li>루씬은 mmap을 적극적으로 활용하기 떄문에 <code class="language-plaintext highlighter-rouge">vm.max_map_count</code> 값을 높일 필요가 있따.<li>만약 이 값이 262144보다 작은 값으로 셋팅되어 있다면 ES는 기동 자첼가 되지 않을수 있다.<li>이 값의 설정은 최대치를 규정할 뿐이며, 값을 매우 높게 하더라도 OS 메모리 사용량이나 성능상 손해는 없다고 알려져있다.<li>일반적으로 추천되는 사이즈는 <code class="language-plaintext highlighter-rouge">시스템의 메모리 / 128KB</code>의 값으로 셋팅하는것을 추천한다.<li>대부분의 경우 262144로 지정해 대규모 ES 서비스를 운영해도 별 문제는 없다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>sysctl vm.max_map_count
vm.max_map_count <span class="o">=</span> 65530

<span class="nb">sudo </span>sysctl v-w m.max_map_count<span class="o">=</span>262144

<span class="c"># 재부팅 후에도 설정을 유지하려면 아래 파일 수정</span>
<span class="nb">sudo </span>vim /etc/sysctl.d/98-elasticsearch.conf
vm.max_map_count <span class="o">=</span> 262144
</pre></table></code></div></div><h4 id="파일-기술자"><span class="mr-2">파일 기술자</span><a href="#파일-기술자" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES는 많은 파일 기술자(file descriptor)를 필요로 한다. ES는 이값을 최소 65535 이상으로 지정하도록 가이드한다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">ulimit</span> <span class="nt">-a</span> | <span class="nb">grep</span> <span class="s2">"open files"</span>

<span class="c"># OSX에서는 아래설정으로 확인</span>
<span class="nb">ulimit</span> <span class="nt">-a</span> | <span class="nb">grep</span> <span class="s1">'file descriptor'</span>

<span class="c"># 값 설정</span>
<span class="nb">sudo ulimit</span> <span class="nt">-n</span> 65535

<span class="c"># 영구 지정을 위해 파일 수정</span>
<span class="nb">sudo </span>vim /etc/security/limits.conf
username - nofile 65535
</pre></table></code></div></div><h4 id="jvm-지정과-설정"><span class="mr-2">JVM 지정과 설정</span><a href="#jvm-지정과-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>특별한 사유가 없다면 내장 JDK를 사용하는것이 좋으며, 힙 크기와 JVM 설정은 굳이 변경하지 않도록 권고한다.<li>7.12 버전 미만을 사용한다면 의도치 않은 JAVA_HOME 환경 변수가 설정됐는지 사전에 확인해야 하는 점도 동일하다.</ul><h2 id="52-클러스터-구성-전략"><span class="mr-2">5.2 클러스터 구성 전략</span><a href="#52-클러스터-구성-전략" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="521-마스터-후보-노드와-데이터-노드를-분리"><span class="mr-2">5.2.1 마스터 후보 노드와 데이터 노드를 분리</span><a href="#521-마스터-후보-노드와-데이터-노드를-분리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>어느 정도 규모가 있는 서비스를 위해 클러스터를 운영한다면 마스터 후보 노드를 데이터 노드와 분리시켜야 한다.<li>마스터 노드는 클러스터를 관리하는 중요한 역할을 하는데 운영 중 발생하는 문제를 보면 상대적으로 데이터 노드가 죽을 확률이 높으므로 마스터 후보와 데이터 노드 역할을 동시에 수행한다면 문제가 생길 가능성이 높다.<li>또 장애 대응을 위해 특정 노드를 rolling restart 할때에도 장애 원인에 따라 마스터 노드를 재시작하거나 데이터 노드를 재시작해야 하는 상황이 다른데 이러한 fail-over 과정도 복잡해질 수 있다.<li>데이터 노드가 하나 죽은 경우라면 마스터 노드가 주 샤드가 사라진 샤드의 복제본 샤드를 새로운 주 샤드로 변경 시키고, 복제본 개수를 새로 채우는 과정을 수행하며 자연스럽게 fail-over를 할 수 있다.<li>마스터 후보 노드는 데이터 노드보다 상대적으로 성능이 많이 낮은 서버를 사용해도 무방하다.<ul><li>데이터 노드처럼 디스크나 메모리를 많이 필요로 하지 않다.</ul></ul><h3 id="522-마스터-후보-노드와-투표-구성원"><span class="mr-2">5.2.2 마스터 후보 노드와 투표 구성원</span><a href="#522-마스터-후보-노드와-투표-구성원" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>클러스터가 운영되는 동안 항상 마스터 노드가 선출되어 있어야 한다. 이러한 마스터 노드를 선출하는 집단이 바로 투표 구성원이다.<li>투표 구성원은 마스터 후보 노드 중 일부 혹은 전체로 구성된 마스터 후보 노드의 부분 집합으로 마스터 선출이나 클러스터 상태 저장 등의 이사결정에 참여하는 노드의모임이다.<li>마스터 후보 노드가 클러스터에 참여하거나 떠나면 ES에서 안정성을 추가하는 방향으로 투표 구성원을 자동 조정한다.<ul><li>이 조정 동작에는 어느정도 시간이 필요하므로, 조정이 필요한 경우 1대씩 천천히 진행하는것이 좋다.<li>동시에 절반 이상이 멈추면 클러스터는 의사결정을 내릴 수 없는 상황에 빠질 수 있다.</ul><li>마스터 후보 노드는 홀수대를 준비하는 것이 비용 대비 효용성이 좋다.<li>ES 7 버전 이상부터는 투표 구성원을 홀수로 유지하고, 후보 노드를 뺴놓는 방식으로 처리된다.<ul><li>2K + 2대가 운영되더라도 투표 구성원은 2K + 1대만 유지하고, 1대가 죽거나 할 경우 대기중이던 1대를 투입시켜서 홀수를 유지시킨다.</ul></ul><h3 id="523-서버-자원이-많지-않은-경우"><span class="mr-2">5.2.3 서버 자원이 많지 않은 경우</span><a href="#523-서버-자원이-많지-않은-경우" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>적어도 3대가 확보돼야 클러스터를 구성하는 의미가 있다.<li>마스터 후보 노드 최소 3대, 데이터 노드 최소 3대가 확보돼야 기본적인 고가용성이 제공되기 떄문이다.</ul><h4 id="최소-구성-장비-3대"><span class="mr-2">최소 구성, 장비 3대</span><a href="#최소-구성-장비-3대" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>최소의 서버 자원으로 ES 클러스터를 구성한다면 3대의 노드가 모두 마스터 후보 역할과 데이터 역할을 겸임하는 구성이 된다.</ul><h4 id="사양이-낮은-장비-45대가-있는-경우"><span class="mr-2">사양이 낮은 장비 4~5대가 있는 경우</span><a href="#사양이-낮은-장비-45대가-있는-경우" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>3대는 마스터 후보 역할과 데이터 역항을 겸임하게 지정하고, 나머지 1~2대를 데이터 노드 전용으로 지정한다.</ul><h4 id="사양이-높은-장비-45대가-있는-경우"><span class="mr-2">사양이 높은 장비 4~5대가 있는 경우</span><a href="#사양이-높은-장비-45대가-있는-경우" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>같은 비용을 지불해서 사양이 낮은 장비 3대와 사양이 높은 장비 3~4대 구성이 가능한지 확인한다.<li>변경할 수 있다면 사양이 낮은 장비 3대에 마스터 후보 역할을 주고, 사양이 높은 나머지 장비에 데이터 노드 역할을 준다.</ul><h4 id="장비-67대"><span class="mr-2">장비 6~7대</span><a href="#장비-67대" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>마스터 후보 노드와 데이터 노드를 완전히 분리할 수 있다.<li>서비스 안정성 면에서 훨씬 이득이다.</ul><h3 id="524-서버-자원이-굉장히-많이-필요한-경우"><span class="mr-2">5.2.4 서버 자원이 굉장히 많이 필요한 경우</span><a href="#524-서버-자원이-굉장히-많이-필요한-경우" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>한 클러스터에 동원해야 하는 물리 서버가 200대 이상인 경우 서비스 요건이 빠듯하고, 동원할 수 있는 서버 자원이 굉장히 많은 상황이 있다.<li>이런 상황에서는 먼저 용도나 중요도별로 클러스터를 더 잘게 쪼갤 수 있는지 검토해야 한다.<li>ES가 선형적 확장을 잘 지원하는 구조로 설계됐다 하더라도 선출하는 마스터 노드의 수 자체를 늘릴 수는 없기 떄문에 한계가 있다.<li>클러스터를 나눌수 없다면 마스터 노드도 높은 사양의 서버로 준비하는 것이 좋다.<li>그럼에도 결국 한계가 있기 떄문에 클러스터를 쪼개고, 클러스터간 검색(cross-cluster search) 도입을 고려해보는것이 좋다.</ul><h3 id="525-사양이-크게-차이나는-서버-자원을-활용해야-하는-경우"><span class="mr-2">5.2.5 사양이 크게 차이나는 서버 자원을 활용해야 하는 경우</span><a href="#525-사양이-크게-차이나는-서버-자원을-활용해야-하는-경우" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>가용한 서버 자원 사이의 사양 차이가 크다면 같은 운영 비용으로 성능 차이가 적은 서버로 일원화해서 교체 운영할 수 있는지 먼저 검토하자.<li>만약 그것이 어려운 상황이고 성능 차이가 좀 나더라도 남은 서버 자원을 긁어모아 활용해야 한다면 데이터 티어 구조의 도입을 고려할 수 있다.<li>성능이 높은 서버를 data_content와 data_hot 역할로, 성능이 낮은 서버를 data_warm, data_cold, data_frozen 역할로 지정한다.<li>이후 인덱스 생명 주기 관리 정책을 도입해 오래된 시계열 데이터 인덱스를 낮은 티어의 노드로 이동시키며 운영할 수 있다.<li>다만, 이때 데이터 티어 노드를 이동하는 것 역시 작업이며, 클러스터에 부하를 줄수 있으므로 상황을 잘 판단하여 신중하게 설계해야 한다.</ul><h3 id="526-조정-전용-노드"><span class="mr-2">5.2.6 조정 전용 노드</span><a href="#526-조정-전용-노드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>안정적인 클러스터 운영을 위해서는 조정 전용 노드를 두는 것이 좋다.(<code class="language-plaintext highlighter-rouge">node.roles: []</code>로 지정해 조정 역할만 수행하는 노드)<li>각 데이터 노드에서 작업한 결과물을 모아서 돌려주는 작업은 생각보다 큰 부하를 줄 수 있다.<li>특히, 운영환경에서 키바나를 통해 큰 부하를 주는 경우가 발생할 수 있는데, 이떄 키바나를 조정 전용 노드만을 바라보도록 설정할 수 있다.<li>서버 자원에 여유가 있다면 읽기 작업을 담당하는 조정 전용 노드와 쓰기 작업을 담당하는 조정 전용 노드를 분리하는 것도 좋은 방법이다.<li>조정 전용 노드는 데이터 노드보다 사양이 낮은 장비로 구성해도 문제 없다.<li><h2 id="es7버전-이상부터-도입된-실제-메모리-서킷-브레이커가-조정-전용-노드와-궁합이-좋은데-조정-전용-노드의-메모리-사용량이-높아지면-서킷-브레이커가-해당-요청을-차단한다"><span class="mr-2">ES7버전 이상부터 도입된 실제 메모리 서킷 브레이커가 조정 전용 노드와 궁합이 좋은데, 조정 전용 노드의 메모리 사용량이 높아지면 서킷 브레이커가 해당 요청을 차단한다.</span><a href="#es7버전-이상부터-도입된-실제-메모리-서킷-브레이커가-조정-전용-노드와-궁합이-좋은데-조정-전용-노드의-메모리-사용량이-높아지면-서킷-브레이커가-해당-요청을-차단한다" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></ul><h3 id="527-한-서버에-여러-프로세스-띄우기"><span class="mr-2">5.2.7 한 서버에 여러 프로세스 띄우기</span><a href="#527-한-서버에-여러-프로세스-띄우기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>128G 이상의 메모리를 사용하는 고스펙 서버에서 32GB 정도의 힙을 설정한 ES 프로세스를 여러 개 띄우는 방법이 있는데, 이 방법으로 성능을 최대한 끌어내고자 한다면 반드시 실제와 비슷한 환경으로 테스트를 하고 방향을 결정해야 한다.<li>한 서버에서 여러 프로세스를 띄우는 방법과 유의사항을 좀 더 알아보자</ul><h4 id="유의사항"><span class="mr-2">유의사항</span><a href="#유의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>마스터 후보 역항을 하는 프로세스는 다중 프로세스 대상으로 고려하지 말아야 한다.(클러스터 안정성이 매우 떨어짐)<li>다중 프로세스 기동을 위해서는 cluster.name은 같게, node.name은 다르게 설정해야 하고, http, transport, path.logs, path.data같은 설정은 독립적인 설정을 가져야 한다.<li>프로세스 기동을 위해서는 <code class="language-plaintext highlighter-rouge">cluster.routing.allocation.same_shard.host: true</code> 설정을 지정해야 한다.(기본값 : false)<li>또 OS의 file descriptor, mmap max_map_count, 네트워크 대역폭 등 자원도 공유한다는 사실과 서버에 하드웨어적인 문제가 발생하면 영향도가 N배가 될수 있다는 리스크를 염두해두어야 한다.</ul><h2 id="53-보안-기능-적용"><span class="mr-2">5.3 보안 기능 적용</span><a href="#53-보안-기능-적용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>운영환경에서는 보안이 굉장히 중요한 이슈이다.<li>기본적으로 특별한 설정을 하지 않으면 통신 암호화를 하지 않는다.<li>ES나 키바나가 인터넷 환경에 노출되어 있다면 인증과 권한 부여, 분리와 관련된 기능도 중요하고, 보안 기능을 적용 해야 한다.<li>기본적으로는 <code class="language-plaintext highlighter-rouge">xpack.security.enabled: true</code> 설정을 바꿔주면 보안 기능을 클러스터에 적용할 수 있다.</ul><h3 id="531-모든-보안-기능을-적용하지-않은-상태"><span class="mr-2">5.3.1 모든 보안 기능을 적용하지 않은 상태</span><a href="#531-모든-보안-기능을-적용하지-않은-상태" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>접근하는 사용자와 클라이언트 전수를 명확하게 제어할 수 있는 상황이라면 <code class="language-plaintext highlighter-rouge">xpack.security.enabled: false</code>로 두고 운영하는 선택도 가능하다.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">cluster.initial_master_nodes</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">test-es-node-01"</span><span class="pi">,</span><span class="s2">"</span><span class="s">test-es-node-02"</span><span class="pi">,</span><span class="s2">"</span><span class="s">test-es-node-03"</span><span class="pi">]</span>
<span class="na">xpack.security.enabled</span><span class="pi">:</span> <span class="kc">false</span>
</pre></table></code></div></div><h3 id="532-tls-부트스트랩-체크"><span class="mr-2">5.3.2 TLS 부트스트랩 체크</span><a href="#532-tls-부트스트랩-체크" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>본격적인 보안 설정을 진행하기 전에 먼저 TLS 부트스트랩 체크를 알아야 한다.<li><code class="language-plaintext highlighter-rouge">xpack.security.enabled: false</code> 으로 구동할 경우 TLS 부트스트랩 체크를 건너뛴다.<li>클러스터 기동 과정에서 노드간 transport 통신에 TLS를 적용하지 않았다면 기동을 거부한다.<li>노드간 TLS 통신을 먼저 적용해 클러스터를 기동하고, 그 이후에 내부 계정 초기화 작업을 수행해야 한다.</ul><h3 id="533-클러스터-최초-기동-시-자동-보안-설정-이용"><span class="mr-2">5.3.3 클러스터 최초 기동 시 자동 보안 설정 이용</span><a href="#533-클러스터-최초-기동-시-자동-보안-설정-이용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>자동 보안 설정 기능은 ES8 버전부터 추가된 기능이다. 8버전 미만을 사용하면 수동 설정으로 진행해야 한다.<li>전용 CA(Certificate Authority)를 생성하고, 그 CA로 서명된 인증서를 자동 발급한다.<li>노드간 transport 레이어와 REST API에 사용하는 HTTP 레이어에 TLS 통신을 적용한다.</ul><h4 id="tls-부트스트랩-체크를-피해-최초-기동"><span class="mr-2">TLS 부트스트랩 체크를 피해 최초 기동</span><a href="#tls-부트스트랩-체크를-피해-최초-기동" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="na">node.roles</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">master</span><span class="pi">,</span> <span class="nv">data</span> <span class="pi">]</span>

<span class="na">cluster.name</span><span class="pi">:</span> <span class="s">test-es</span>
<span class="na">node.name </span><span class="pi">:</span> <span class="s">test-es-node01</span>

<span class="na">path</span><span class="pi">:</span>
   <span class="na">logs</span><span class="pi">:</span> <span class="s">/my/path/to/elasticsearch/logs</span>
   <span class="na">datas</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/my/path/to/elasticsearch/data1</span>
      <span class="pi">-</span> <span class="s">/my/path/to/elasticsearch/data2</span>

<span class="na">network.host</span><span class="pi">:</span> <span class="s">10.0.0.1</span>
<span class="na">network.bind_host</span><span class="pi">:</span> <span class="s">0.0.0.0</span>

<span class="na">discovery.seed_hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">10.0.0.1"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">10.0.0.2"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">10.0.0.3"</span><span class="pi">]</span>
<span class="na">discovery.type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">single-node"</span>
</pre></table></code></div></div><ul><li>먼저 클러스터 중 한 대의 노드를 띄우고 아래 설정으로 실행한다.<li>단일 노드로 클러스터가 기동되고 나면 자동 설정이 수행되는데, 이떄 elasti usre password나 enrollment token 등이 sdtout으로 출력된다.<li>또 프로세스를 종료한 후 config 디렉토리 하위에 certs라는 디렉토리가 생겼고, 그 아래에 CA와 인증서 파일이 자동 생성됨을 확인할 수 있다.<li>이 메시지를 적당한 곳에 복사해두고, 이를 이용해서 클러스터 노드 추가, 키바나를 붙이는 작업 등을 수행할 수 있다.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">xapck.security.enrollment.enabled</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">xapck.security.http.ssl</span><span class="pi">:</span>
   <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
   <span class="na">keystore.path</span><span class="pi">:</span> <span class="s">certs/http.p12</span>

<span class="na">xapck.security.transport.ssl</span><span class="pi">:</span>
   <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
   <span class="na">verification_mode</span><span class="pi">:</span> <span class="s">certificate</span>
   <span class="na">keystore.path</span><span class="pi">:</span> <span class="s">certs/http.p12</span>
   <span class="na">truststore.path</span><span class="pi">:</span> <span class="s">certs/http.p12</span>
</pre></table></code></div></div><h4 id="enrollment-토큰으로-클러스터에-노드-추가"><span class="mr-2">enrollment 토큰으로 클러스터에 노드 추가</span><a href="#enrollment-토큰으로-클러스터에-노드-추가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>단일 노드 클러스터로 띄웠던 노드의 <code class="language-plaintext highlighter-rouge">config/elasticsearh.yml</code>의 discovery.type 설정을 제거해주고 다시 기동한다.<li>만약 단일 노드 최초 기동시 발급했던 enrollment 토큰을 분실했다면 다음과 같이 새로운 enrollment 토큰을 발급할 수 있다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bin/elastisearch-create-enrollment-token <span class="nt">-s</span> node
</pre></table></code></div></div><ul><li>새롭게 투입할 노드는 아래와 같은 설정으로 기동할 수 있다.<li>이때 <code class="language-plaintext highlighter-rouge">cluster.initial_master_nodes</code>, <code class="language-plaintext highlighter-rouge">xpack.security.enabled</code> 설정과 discovery도 기입하지 않는다.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">node.roles</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">master</span><span class="pi">,</span> <span class="nv">data</span> <span class="pi">]</span>

<span class="na">cluster.name</span><span class="pi">:</span> <span class="s">test-es</span>
<span class="na">node.name </span><span class="pi">:</span> <span class="s">test-es-node02</span>

<span class="na">path</span><span class="pi">:</span>
   <span class="na">logs</span><span class="pi">:</span> <span class="s">/my/path/to/elasticsearch/logs</span>
   <span class="na">datas</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/my/path/to/elasticsearch/data1</span>
      <span class="pi">-</span> <span class="s">/my/path/to/elasticsearch/data2</span>

<span class="na">network.host</span><span class="pi">:</span> <span class="s">10.0.0.1</span>
<span class="na">network.bind_host</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
</pre></table></code></div></div><ul><li>설정 확인 후 발급한 enrollment 토큰을 지정해 노드를 기동한다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bin/elasticsearch <span class="nt">-d</span> <span class="nt">--enrollment-token</span> 
</pre></table></code></div></div><ul><li>노드 기동이 완료되면 클러스터에 새 노드가 합류하고, 이후 추가된 노드의 <code class="language-plaintext highlighter-rouge">config/certs</code>에도 인증서가 복사되고, 자동으로 보안 설정이 지정된것을 확인 할 수 있다.</ul><h4 id="초기-비밀번호-변경"><span class="mr-2">초기 비밀번호 변경</span><a href="#초기-비밀번호-변경" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># 합류 노드 아무곳에서나 한번 수행해서 최고 관리자 계정의 초기 비밀번호를 설정할 수 있다.</span>
bin/elasticsearch-reest-password <span class="nt">--interactive</span> <span class="nt">-u</span> elastic
</pre></table></code></div></div><h4 id="enrollment-토큰으로-키바나-기동"><span class="mr-2">enrollment 토큰으로 키바나 기동</span><a href="#enrollment-토큰으로-키바나-기동" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bin/elasticsearch-create-enrollment-token <span class="nt">-s</span> kibana
</pre></table></code></div></div><ul><li>키바나를 기동하기 전에 <code class="language-plaintext highlighter-rouge">config/kibana.yml</code>의 설정을 검토한다.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="na">server.port</span><span class="pi">:</span> <span class="m">5601</span>
<span class="na">server.host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.0.0.3"</span>
<span class="na">server.publicBaseUrl</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://10.0.0.3:5601"</span>
</pre></table></code></div></div><ul><li>enrollment를 이용한 최초 기동을 위해서는 <code class="language-plaintext highlighter-rouge">elasticsearch.hosts</code>를 지정하지 않아야 한다.<li>그리고 키바나를 기동하면 웹에서 enrollment 토큰을 입력하는 창이 나타나고, 여기에 토큰을 입력하면 키바나 설정이 진행된다.<li>버전(상황)에 따라 키바나에서 발급하는 추가 인증 코드를 입력하라는 안내가 나올 수 있는데 그런 경우 키바나에서 인증 코드를 발급받아 이를 키바나 웹 UI에 입력하면 초기 설정이 재개된다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>bin/kibana-verification-code

Your verification code is : 856 595
</pre></table></code></div></div><h4 id="추가-작업"><span class="mr-2">추가 작업</span><a href="#추가-작업" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>보안 설정을 끝낸 후에는 설정을 의도한 상황에 맞게 조금 정리해줄 필요가 있다.<li>ES 노드의 c<code class="language-plaintext highlighter-rouge">onfig/elasticsearch.yml</code>을 보면 <code class="language-plaintext highlighter-rouge">discovery.seed_hosts</code> 설정이 원하는 형태가 아닌데, 이런 부분을 마스터 후보 노드를 정확히 가리키도록 변경해야 한다.<li>또 <code class="language-plaintext highlighter-rouge">node.role</code> 설정도 의도와 다르게 설정된 노드가 있다면 변경해주어야 한다.<li><code class="language-plaintext highlighter-rouge">config/kibana.yml</code>의 <code class="language-plaintext highlighter-rouge">elasticsearch.hosts</code> 설정도 원하는 리스트로 수정한다.<li>최종적으로 아래와 같은 구조가 자동 구성된다.</ul><p><a href="https://github.com/sungsu9022/study/assets/6982740/78b3dde2-e3d5-42f1-9c26-102edec96d17" class="popup img-link "><img data-src="https://github.com/sungsu9022/study/assets/6982740/78b3dde2-e3d5-42f1-9c26-102edec96d17" alt="IMG_8013" class="lazyload" data-proofer-ignore></a></p><h3 id="534-키바나와-브라우저-사이에-tls-적용"><span class="mr-2">5.3.4 키바나와 브라우저 사이에 TLS 적용</span><a href="#534-키바나와-브라우저-사이에-tls-적용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>위 구성을 하더라도 아직 키바나와 브라우저 사이에는 TLS가 적용되지 않았다.<li>여기에는 신뢰할 수 있는 공인된 CA가 서명한 인증서를 발급받고 이를 이용해 CSR과 개인키를 생성하고 TLS를 적용하는게 필요하다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bin/elasticsearch-certutil csr <span class="nt">-name</span> kibana-server <span class="nt">-dns</span> example.com,www.example.com
</pre></table></code></div></div><ul><li>위에서 생성된 파일의 압축을 풀면 <code class="language-plaintext highlighter-rouge">.csr</code> 파일과 <code class="language-plaintext highlighter-rouge">.key</code> 파일이 나오는데 이를 설정에 추가할 수 있따.<ul><li><code class="language-plaintext highlighter-rouge">.csr</code> 파일은 인증서 발급 기관으로 보내 인증서를 발급받도록 한다.<li>인증서가 발급되면 <code class="language-plaintext highlighter-rouge">kibana/config</code> 디렉토리 하위에 파일을 위치 시키고 설정을 해주면 된다.</ul></ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="na">server.publicBaseUrl</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://example.com:5601"</span>

<span class="na">server.ssl.enabled</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">server.ssl.certificate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/path/to/kibana/config/certificate.pem"</span>
<span class="na">server.ssl.key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/path/to/kibana/config/privkey/kibana-server-privkey.key"</span>
</pre></table></code></div></div><h3 id="535-수동으로-엘라스틱-서치-노드-간의-통신에-tls-적용"><span class="mr-2">5.3.5 수동으로 엘라스틱 서치 노드 간의 통신에 TLS 적용</span><a href="#535-수동으로-엘라스틱-서치-노드-간의-통신에-tls-적용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>수동으로 ES 노드간의 통신에 TLS를 적용할 수 있지만, 이 과정은 매우 길고 복잡하며 실수하기 쉽다. 따라서 일반적으로 자동 보안 설정을 이용하는 편이 낫다.</ul><h4 id="절차"><span class="mr-2">절차</span><a href="#절차" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>CA와 self-signed 인증서 생성<li>인증서 파일 복사<li>ES 설정 변경</ul><h3 id="536-수동으로-기본-인증-설정"><span class="mr-2">5.3.6 수동으로 기본 인증 설정</span><a href="#536-수동으로-기본-인증-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>ES는 계정과 역할 기반으로 인증, 권한 부여와 분리 기능을 제공한다.<ul><li>역할에는 읽기, 쓰기, 모니터링, 스냅샷 등 ES에서 수행할 수 있는 여러 작업의 권한이 매우 세부적으로 나뉘어져 있다.</ul><li>이 외에는 키바나에 스페이스(space)라는 개념을 통해 데이터 뷰, 비주어라이즈, 대시보드 등을 스페이스마다 독립적으로 운영할 수 있다.</ul><h4 id="최소-보안"><span class="mr-2">최소 보안</span><a href="#최소-보안" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>노드간의 통신에 TLS를 적용하지 않았다면 ES는 애초에 기동되지 않으므로 내부 계정을 활성화시키는 단계로 진입할 수가 없다.<li>하지만 단일 노드로 구성한 개발 모드는 TLS 부트스트랩 체크를 건너뛰므로 노드간 TLS 적용 없이 기본 인증만 설정해 사용하는것이 가능하다. 기본 인증만 있는 경우 최소 보안만 설정된 상태라고 볼수 있다.</ul><h4 id="내부-계정의-초기-비밀번호-설정"><span class="mr-2">내부 계정의 초기 비밀번호 설정</span><a href="#내부-계정의-초기-비밀번호-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>bin/elasticsearch-reset-password <span class="nt">--interactive</span> <span class="nt">-u</span> elastic
bin/elasticsearch-reset-password <span class="nt">--interactive</span> <span class="nt">-u</span> kibana_system

<span class="c"># es에 자동으로 password 생성하도록 지시</span>
bin/elasticsearch-reset-password <span class="nt">--auto</span> <span class="nt">-u</span> kibana_system
</pre></table></code></div></div><p>-위 비밀번호 설정을 통해 계정의 비밀번호를 얻어낸다면 이를 이용하여 ES 기본인증을 사용할 수 있다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>crul <span class="nt">-H</span> <span class="s2">"Authorization: Basic </span><span class="k">${</span><span class="nv">accessKoten</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200?pertty=true"</span>
</pre></table></code></div></div><h4 id="키바나-설정-변경"><span class="mr-2">키바나 설정 변경</span><a href="#키바나-설정-변경" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>키바나에서 kibana_system 계정을 사용하기 위해 <code class="language-plaintext highlighter-rouge">config/kibana.yml</code> 설정을 변경한다.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">elasticsearch.username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kibana_system"</span>
<span class="na">elasticsearch.password</span><span class="pi">:</span> 
</pre></table></code></div></div><ul><li>계정의 비밀번호를 키바나에게 알려주기 위해 <code class="language-plaintext highlighter-rouge">elasticsearch.password</code>를 설정할수도 있지만, 키스토어를 이용하는것이 안전하다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>bin/kibana-keystore create

bin/kibana-keystore add elasticsearch.password
</pre></table></code></div></div><ul><li>위 설정을 추가하고 키바나를 기동하면 접속시 로그인을 요구하는 창이 등장하게 된다.</ul><h3 id="537-수동으로-rest-api-호출에-tls-적용"><span class="mr-2">5.3.7 수동으로 REST API 호출에 TLS 적용</span><a href="#537-수동으로-rest-api-호출에-tls-적용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>완벽히 격리된 인트라넷 안에서만 사용하는것이 아니라면 결국 transport 레이어가 아니라 HTTP 레이어에도 TLS를 적용해야 한다.<li>ES의 http 레이어, 키바나에서 ES를 호출할떄 TLS 적용, 키바나와 브라우저 사이에 TLS를 수동으로 적용하는 절차를 알아보자</ul><h4 id="인증서-선택"><span class="mr-2">인증서 선택</span><a href="#인증서-선택" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>기본적으로 인증서 발급, 갱신, 관리에는 비용이 들어간다.<li>노드마다 도메인이 모두 발급되어있고, 모든 클라이언트가 이 도메인을 통해 REST 요청을 한다면 이들을 묶을수 있는 와일드카드 인증서를 하나 발급받아 모든 노드에서 사용할 수 있다.</ul><h4 id="es의-http-레이어에-tls-적용"><span class="mr-2">ES의 HTTP 레이어에 TLS 적용</span><a href="#es의-http-레이어에-tls-적용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>예시에서는 직접 발급한 CA를 신뢰할 수 있도록 추가하고 작업한다.<li><code class="language-plaintext highlighter-rouge">bin/elasticsearch-certutil http</code>을 통해 인증서를 생성한다.<li>생성된 zip 파일의 압축을 풀어 설정을 추가한다.<ul><li>파일은 지정한 노드별로 생성된다.</ul></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>kibana/elasticsearch-ca.pem
elasticsearch/es01/http.p12
elasticsearch/es02/http.p12
elasticsearch/es03/http.p12
</pre></table></code></div></div><ul><li>위에 서 생성된 파일을 기준으로 다음과 같이 TLS 수동 적용을 할 수 있다.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">xpack.security.http.ssl.enabled</span><span class="pi">:</span> <span class="kc">true</span>
<span class="pi">[</span><span class="nv">xpack.sec</span><span class="pi">]</span><span class="na">(xpack.security.http.ssl.keystore.path</span><span class="pi">:</span> <span class="s">http.p12</span>
</pre></table></code></div></div><ul><li>그리고 다음을 실행해서 안내에 따라 ES 키스토어에 http.p12 파일의 암호를 추가한다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password
</pre></table></code></div></div><h4 id="키바나가-es를-호출할-떄-tls-적용"><span class="mr-2">키바나가 ES를 호출할 떄 TLS 적용</span><a href="#키바나가-es를-호출할-떄-tls-적용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="na">server.publicBaseUrl</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://10.0.0.3:5601"</span>
<span class="na">elasticsearch.hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">https://10.0.0.3:9200"</span><span class="pi">]</span>
<span class="na">elasticsearch.ssl.certificateAuthorities</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/path/to/kibana/config/elasticsearch-ca.pem"</span><span class="pi">]</span>
</pre></table></code></div></div><ul><li>위 설정을 보면 elasticsearch.hosts에도 https 로 명시했는데, 이 후 키바나를 기동하면 키바나와 ES 사이에도 TLS로 통신함을 알 수 있다.</ul><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>.</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/elasticsearch/'>Elasticsearch</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >Elasticsearch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%205.%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%ED%99%98%EA%B2%BD%EC%97%90%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EA%B5%AC%EC%84%B1%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-5%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%205.%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%ED%99%98%EA%B2%BD%EC%97%90%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EA%B5%AC%EC%84%B1%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-5%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-5%2F&text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%205.%20%EC%84%9C%EB%B9%84%EC%8A%A4%20%ED%99%98%EA%B2%BD%EC%97%90%20%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%20%EA%B5%AC%EC%84%B1%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/es-bible-1/"><div class="card-body"> <em class="small" data-ts="1700127840" data-df="ll" > Nov 16, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 1. 엘라스틱 서치 소개</h3><div class="text-muted small"><p> 1. 엘라스틱 서치 소개 Elasticsearch는 2010년 2월 샤이 베논이 아파치의 루씬 라이브러리를 기반으로 만든 분산 검색 엔진 2013년에 데이터를 손쉽게 시각화하는 Kibana와 색인 데이터 수집&amp;amp;변환을 하는 Logstash 프로젝트에 엘라스틱에 합류 엘라스틱서치는 현재 검색 엔진 분야에서 가장 각광받고 있는 시스템이다...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-2/"><div class="card-body"> <em class="small" data-ts="1700218920" data-df="ll" > Nov 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</h3><div class="text-muted small"><p> 2. 엘라스틱 서치 기본 동작과 구조 엘라스틱서치의 구조를 어느정도 먼저 이해한 상태에서 상세 내용을 학습해야 전체 학습에 깊이가 생긴다. 이번 장을 마치고 나면 엘라스틱서치가 어떻게 동작하는지 큰 그림을 머릿속에 그릴수 있을것이다. 2.1 엘라스틱서치 기본 동작 빠르게 둘러보기 실습 과정에서는 기본적으로 REST API를 호출해 진...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-3-1/"><div class="card-body"> <em class="small" data-ts="1700301000" data-df="ll" > Nov 18, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</h3><div class="text-muted small"><p> 3. 인덱스 설계 - 1 ES의 인덱스는 아주 세부적인 부분까지 설정으로 제어할 수 있다. 이 설정에 따라 동작과 특성이 매우 달라지므로 인덱스 설계에 신경써야 한다. 맵핑, 필드 타입, 애널라이저 등 핵심적인 설정을 학습해 ES 인덱스에 대한 이해도를 높여보자. 3.1 인덱스 설정 인덱스 생성시 동작에 관한 설정을 지정할 수 있...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/es-bible-4-3/" class="btn btn-outline-primary" prompt="Older"><p>[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</p></a> <a href="/posts/es-bible-8/" class="btn btn-outline-primary" prompt="Newer"><p>[엘라스틱서치 바이블] 8. 엘라스틱서치의 내부 동작 상세</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/es-bible-5/'; this.page.identifier = '/posts/es-bible-5/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>

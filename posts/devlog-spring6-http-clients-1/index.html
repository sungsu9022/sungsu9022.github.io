<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="[Spring] Spring6 Http Interface Client - 1" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="1. 어떤 HttpClient을 사용할것인가? Spring을 이용한 Application을 개발할 때, 다른 서버와의 HTTP 통신이 필요할 경우가 많다. 이때 어떤 HttpClient를 사용할지 결정하는 것은 중요한 선택입니다. 다양한 HttpClient 옵션이 있지만, 각 방식마다 장단점이 있다. 여기서는 대표적인 HttpClient들을 비교하여 어떤 선택이 가장 적합할지 살펴보자." /><meta property="og:description" content="1. 어떤 HttpClient을 사용할것인가? Spring을 이용한 Application을 개발할 때, 다른 서버와의 HTTP 통신이 필요할 경우가 많다. 이때 어떤 HttpClient를 사용할지 결정하는 것은 중요한 선택입니다. 다양한 HttpClient 옵션이 있지만, 각 방식마다 장단점이 있다. 여기서는 대표적인 HttpClient들을 비교하여 어떤 선택이 가장 적합할지 살펴보자." /><link rel="canonical" href="https://sungsu9022.github.io/posts/devlog-spring6-http-clients-1/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/devlog-spring6-http-clients-1/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-09-13T21:47:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Spring] Spring6 Http Interface Client - 1" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2024-09-13T21:47:00+09:00","datePublished":"2024-09-13T21:47:00+09:00","description":"1. 어떤 HttpClient을 사용할것인가? Spring을 이용한 Application을 개발할 때, 다른 서버와의 HTTP 통신이 필요할 경우가 많다. 이때 어떤 HttpClient를 사용할지 결정하는 것은 중요한 선택입니다. 다양한 HttpClient 옵션이 있지만, 각 방식마다 장단점이 있다. 여기서는 대표적인 HttpClient들을 비교하여 어떤 선택이 가장 적합할지 살펴보자.","headline":"[Spring] Spring6 Http Interface Client - 1","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/devlog-spring6-http-clients-1/"},"url":"https://sungsu9022.github.io/posts/devlog-spring6-http-clients-1/"}</script><title>[Spring] Spring6 Http Interface Client - 1 | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[Spring] Spring6 Http Interface Client - 1</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>[Spring] Spring6 Http Interface Client - 1</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1726231620" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 13, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4329 words"> <em>24 min</em> read</span></div></div></div><div class="post-content"><h2 id="1-어떤-httpclient을-사용할것인가"><span class="mr-2">1. 어떤 HttpClient을 사용할것인가?</span><a href="#1-어떤-httpclient을-사용할것인가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Spring을 이용한 Application을 개발할 때, 다른 서버와의 HTTP 통신이 필요할 경우가 많다.<li>이때 어떤 HttpClient를 사용할지 결정하는 것은 중요한 선택입니다. 다양한 HttpClient 옵션이 있지만, 각 방식마다 장단점이 있다.<li>여기서는 대표적인 HttpClient들을 비교하여 어떤 선택이 가장 적합할지 살펴보자.</ul><h3 id="11-순수-httpclient-라이브러리를-사용하는-방법"><span class="mr-2">1.1 순수 HttpClient 라이브러리를 사용하는 방법</span><a href="#11-순수-httpclient-라이브러리를-사용하는-방법" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>순수 HttpClient 라이브러리는 Java 11부터 제공되는 java.net.http.HttpClient를 사용하는 방법이다.<li>이 라이브러리는 Java 표준 라이브러리로, 외부 라이브러리 의존성 없이 HTTP 요청을 보낼 수 있다.<li>HttpClient는 동기 및 비동기 방식 모두를 지원하며, 간단한 HTTP 통신부터 복잡한 요청까지 다양한 기능을 제공한다.</ul><h4 id="장점"><span class="mr-2">장점</span><a href="#장점" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>외부 라이브러리 없이 사용 가능<li>Java 표준 라이브러리의 일환으로 간편한 유지보수<li>비동기 및 동기 요청 모두 지원</ul><h4 id="단점"><span class="mr-2">단점</span><a href="#단점" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Spring과의 통합이 부족<li>코드가 상대적으로 장황할 수 있음</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">java.net.URI</span>
<span class="k">import</span> <span class="nn">java.net.http.HttpClient</span>
<span class="k">import</span> <span class="nn">java.net.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">java.net.http.HttpResponse</span>

<span class="k">fun</span> <span class="nf">httpClientTest</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">client</span> <span class="p">=</span> <span class="nc">HttpClient</span><span class="p">.</span><span class="nf">newBuilder</span><span class="p">().</span><span class="nf">build</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="nc">HttpRequest</span><span class="p">.</span><span class="nf">newBuilder</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">uri</span><span class="p">(</span><span class="nc">URI</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="s">"https://www.naver.com"</span><span class="p">))</span>
        <span class="p">.</span><span class="nc">GET</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">build</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">response</span><span class="p">:</span> <span class="nc">HttpResponse</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nc">HttpResponse</span><span class="p">.</span><span class="nc">BodyHandlers</span><span class="p">.</span><span class="nf">ofString</span><span class="p">())</span>
    <span class="c1">// 추가적으로 Response Model에 대한 Deserialize 필요</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="p">{</span> <span class="s">"response : ${response.body()}"</span> <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="12-resttemplate"><span class="mr-2">1.2 RestTemplate</span><a href="#12-resttemplate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>RestTemplate는 Spring 3.0에서 처음 도입된 전통적인 HttpClient입니다. 많은 개발자들이 익숙하게 사용해왔으며, 간단한 HTTP 요청을 쉽게 처리할 수 있다.<li>그러나 RestTemplate는 Spring 5부터는 더 이상 새로운 기능이 추가되지 않고, 유지보수 모드로 전환되었다. 이는 Spring에서 비동기 처리와 반응형 프로그래밍의 중요성이 커지면서, 이를 더 잘 지원하는 클라이언트로의 전환을 권장하고 있기 때문이다.</ul><h4 id="장점-1"><span class="mr-2">장점</span><a href="#장점-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>간편한 사용법과 널리 사용된 예제<li>Spring과의 깊은 통합<li>동기식 요청에 적합</ul><h4 id="단점-1"><span class="mr-2">단점</span><a href="#단점-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>비동기 처리 지원 부족<li>향후 기능 업데이트 없음</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">fun</span> <span class="nf">restTemplateTest</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">restTemplate</span> <span class="p">=</span> <span class="nc">RestTemplate</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">url</span> <span class="p">=</span> <span class="s">"https://www.naver.com"</span>
    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">restTemplate</span><span class="p">.</span><span class="nf">getForEntity</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">statusCode</span> <span class="p">===</span> <span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">responseBody</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="p">{</span> <span class="s">"response : $responseBody"</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="13-spring-webclient"><span class="mr-2">1.3 Spring WebClient</span><a href="#13-spring-webclient" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>WebClient는 Spring 5에서 등장한 비동기 및 반응형 HTTP 클라이언트입니다. RestTemplate의 대체로 제안되며, 더 나은 성능과 확장성을 제공한다.<li>WebClient는 비동기 및 블로킹 둘 다 지원하며, 반응형 스트림을 사용해 대용량 데이터를 처리하는데 유리하다.</ul><h4 id="장점-2"><span class="mr-2">장점</span><a href="#장점-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>비동기 및 반응형 프로그래밍 지원<li>다양한 커스터마이징 옵션</ul><h4 id="단점-2"><span class="mr-2">단점</span><a href="#단점-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>RestTemplate에 비해 다소 복잡한 설정과 사용법<li>다른 방식 대비 러닝커브가 존재함.</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">fun</span> <span class="nf">webClientTest</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">webClient</span> <span class="p">=</span> <span class="nc">WebClient</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="s">"https://www.naver.com"</span><span class="p">)</span>

    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">webClient</span><span class="p">.</span><span class="k">get</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">uri</span><span class="p">(</span><span class="s">"/data"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">retrieve</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">bodyToMono</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

    <span class="n">response</span><span class="p">.</span><span class="nf">subscribe</span> <span class="p">{</span> <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="p">{</span> <span class="n">it</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="14-spring-cloud-openfeign"><span class="mr-2">1.4 Spring Cloud OpenFeign</span><a href="#14-spring-cloud-openfeign" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Spring Cloud OpenFeign은 Spring Cloud 프로젝트에서 제공하는 Feign의 확장판이다.<li>Feign은 인터페이스 기반의 선언적 HTTP 클라이언트로, HTTP API 클라이언트를 쉽게 정의할 수 있다.</ul><h4 id="장점-3"><span class="mr-2">장점:</span><a href="#장점-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>간결하고 선언적인 HTTP 클라이언트 정의<li>Spring Cloud와의 통합으로 강력한 기능 제공<li>Srping MVC의 annotation을 활용 가능</ul><h4 id="단점-3"><span class="mr-2">단점:</span><a href="#단점-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Spring Cloud 의존성으로 인해 독립적인 사용은 제한적이다.<li>Spring Cloud OpenFeign은 유지 관리 모드에 있으며 더 이상 적극적으로 개발되지 않으므로 사용을 지양하는 편이 좋다.</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">org.springframework.cloud.openfeign.FeignClient</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span>
<span class="k">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span>

<span class="nd">@FeignClient</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"exampleClient"</span><span class="p">,</span> <span class="n">url</span> <span class="p">=</span> <span class="s">"https://api.example.com"</span><span class="p">)</span>
<span class="kd">interface</span> <span class="nc">ExampleClient</span> <span class="p">{</span>
  <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/data"</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">getData</span><span class="p">():</span> <span class="nc">String</span>
<span class="p">}</span>

<span class="nd">@RestController</span>
<span class="kd">class</span> <span class="nc">ExampleController</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">exampleClient</span><span class="p">:</span> <span class="nc">ExampleClient</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/fetch"</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">fetchData</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">exampleClient</span><span class="p">.</span><span class="nf">getData</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="15-openfeign"><span class="mr-2">1.5 Openfeign</span><a href="#15-openfeign" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>OpenFeign은 Netflix에서 처음 개발한 인터페이스 기반의 선언적 HTTP 클라이언트 라이브러리이다.<li>OpenFeign은 Java의 인터페이스에 메서드 정의만으로 HTTP 요청을 간결하게 수행할 수 있다.<li>Openfeign은 Spring과는 완벽히 독립적인 라이브러리이다.<li>과거에는 Non-Blocking 방식을 지원하지 않았는데, 현재는 Reactive Streams Wrapper을 통해 지원한다.</ul><h4 id="장점-4"><span class="mr-2">장점:</span><a href="#장점-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>간결하고 선언적인 API 클라이언트 작성<li>Spring Cloud와의 결합 없이 독립적으로 사용 가능<li>플러그인 시스템을 통해 다양한 기능 추가 가능</ul><h4 id="단점-4"><span class="mr-2">단점</span><a href="#단점-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Spring Cloud의 부가 기능이 필요할 경우 직접 구현해야 함<li>Spring Cloud와의 통합 기능은 사용 불가</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">feign.Feign</span>
<span class="k">import</span> <span class="nn">feign.RequestLine</span>

<span class="kd">interface</span> <span class="nc">ExampleClient</span> <span class="p">{</span>
    <span class="nd">@RequestLine</span><span class="p">(</span><span class="s">"GET /data"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getData</span><span class="p">():</span> <span class="nc">String</span>
<span class="p">}</span>

<span class="kd">val</span> <span class="py">exampleClient</span> <span class="p">=</span> <span class="nc">Feign</span><span class="p">.</span><span class="nf">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">target</span><span class="p">(</span><span class="nc">ExampleClient</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="s">"https://api.example.com"</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">exampleClient</span><span class="p">.</span><span class="nf">getData</span><span class="p">()</span>
<span class="nf">println</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="16-요약"><span class="mr-2">1.6 요약</span><a href="#16-요약" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Spring 기반 Server App에서 다른 서버와 통신하기 위한 다양한 방법을 알아보았다.<li>위 방법 중 사실 개인적으로 가장 맘에 드는 라이브러리는 <code class="language-plaintext highlighter-rouge">1.4 Spring Cloud OpenFeign</code>이다.<li>하지만 Spring Cloud OpenFeign에는 치명적인 단점이 있다.<ul><li>첫째, Non-blocking 방식을 지원하지 않는다.<li>둘쨰, 유지보수 모드에 돌입하여 더이상 유의미한 기능 수정이 이루어지지 않는다는 점이다.</ul><li>이로 인해 혼동이 가중되었으나, Spring 6가 나오면서 이 부분에 대해 고민이 줄게 되었다. 이제 본격적으로 Spring6 Http Interface Client에 대해 알아보자.</ul><h2 id="2-spring6-http-interface-client"><span class="mr-2">2. Spring6 Http Interface Client</span><a href="#2-spring6-http-interface-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Spring 6에서 도입된 HTTP Interface는 REST API와의 상호작용을 간소화하기 위한 새로운 기능이다.<li>이 기능은 REST API를 호출하기 위한 인터페이스 기반의 선언적 방법을 제공한다.<li>이 기능을 통해 기존의 RestTemplate이나 WebClient보다 간편하게 API 호출을 할 수 있다.</ul><h3 id="21-왜-spring6-http-interface-client인가"><span class="mr-2">2.1 왜 Spring6 Http Interface Client인가?</span><a href="#21-왜-spring6-http-interface-client인가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Feign과 같은 선언적 인터페이스 방식으로 관리할 수 있음.<li>ReactorHttpExchangeAdapter 이용해서 구현하는 경우 reactive variants를 지원한다.<li>Spring Framework에서 공식지원 하는 방식이므로, 사용하지 않을 이유가 없다.<li>아직 초기 단계이므로 그럼에도 미흡한 부분이 있고, 이는 장기적으로 업데이트되거나 Customized를 통해 커버할수 있다.<li>그럼 본격적으로 사용방법을 알아보도록 하자.</ul><h3 id="22-spring6-http-interface-client-내부-구조"><span class="mr-2">2.2 Spring6 Http Interface Client 내부 구조</span><a href="#22-spring6-http-interface-client-내부-구조" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="httpexchangeadapter"><span class="mr-2">HttpExchangeAdapter</span><a href="#httpexchangeadapter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">spring-web:6.1.11</code> 기준으로 다음과 같은 Adaptor을 제공함.<li>기존에 사용하던 RestClient, RestTemplate, WebClient와 같은 설정을 토대로 사용이 가능하다.</ul><p><a href="https://github.com/user-attachments/assets/641b00ba-d501-469d-bd0c-ba3b0bbdf6cf" class="popup img-link "><img width="693" alt="" data-src="https://github.com/user-attachments/assets/641b00ba-d501-469d-bd0c-ba3b0bbdf6cf" class="lazyload" data-proofer-ignore></a></p><h4 id="proxy-객체-생성-방식"><span class="mr-2">Proxy 객체 생성 방식</span><a href="#proxy-객체-생성-방식" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>개발자는 Spring6 Http Interface의 선언형 방식으로 코드를 정의<li>내부적으로는 HttpServiceProxyFactory &gt; ProxyFactory &gt; DefaultAopProxyFactory 를 통해 JdkDynamicAopProxy 객체를 생성하여 처리한다.<li>위 내용을 볼떄 현재는 인터페이스로 정의된 방식만 지원 가능한것으로 보인다.<ul><li>추후 interface뿐만 아니라 class로써, 특정 API들은 본문을 직접 작성하는 방식을 지원한다거나 하면 그에 맞게 Proxy 방식도 ObjenesisCglibAopProxy 같은 방식을 통해 처리하는것도 가능하지 않을까 예상된다.</ul></ul><h2 id="3-spring-6-http-interface-client-개발하기"><span class="mr-2">3 Spring 6 Http Interface Client 개발하기</span><a href="#3-spring-6-http-interface-client-개발하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Spring6부터는 @HttpExchange 메서드를 사용하여 HTTP 서비스를 인터페이스로 정의할 수 있다.<li>인퍼테이스를 HttpServiceProxyFactory로 전달하여 RestClient나 WebClient와 같은 HTTP 클라이언트를 통해 요청을 수행하는 프록시를 생성한다.</ul><h3 id="31-https-client-requestresponse"><span class="mr-2">3.1 Https Client Request/Response</span><a href="#31-https-client-requestresponse" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>spring-web에서 제공하는 Annotation을 조합해서 간결하게 ApiClient를 정의할수 있다.</ul><h5 id="exchange-annotations"><span class="mr-2">Exchange Annotations</span><a href="#exchange-annotations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>Exchange 애노테이션은 대체적으로 spring-web과 1:1 맵핑되는 Exchange Annotation을 제공한다.</ul><div class="table-wrapper"><table><thead><tr><th>SpringWeb<th>HttpInterface<tbody><tr><td>@RequestMapping<td>@HttpExchange<tr><td>@GetMapping<td>@GetExchange<tr><td>@PostMapping<td>@PostExchange<tr><td>@PutMapping<td>@PutExchange<tr><td>@PatchMapping<td>@PatchExchange<tr><td>@DeleteMapping<td>@DeleteExchange</table></div><h5 id="method-parameters"><span class="mr-2">Method Parameters</span><a href="#method-parameters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>대부분의 spring-web에서 지원하는 annotation을 지원한다.<li>하나의 Spring Web Controller와 완전히 동일한 방식으로 HttpInterface를 정의할수는 없다.<ul><li>하지만, 이런부분을 직접 구현함으로써 어느정도 문제를 해결할수는 있다.</ul></ul><div class="table-wrapper"><table><thead><tr><th>SpringWeb<th>HttpInterface<th>Description<tbody><tr><td>@RequestParam<td>@RequestParam<td>동일하게 지원<tr><td>@RequestHeader<td>@RequestHeader<td>동일하게 지원<tr><td>@PathVariable<td>@PathVariable<td>동일하게 지원<tr><td>@RequestBody<td>@RequestBody<td>동일하게 지원<tr><td>@CookieValue<td>@CookieValue<td>동일하게 지원<tr><td>@RequestAttribute<td>@RequestAttribute<td>webClient httpService에서만 지원<tr><td>@RequestPart<td>@RequestPart<td>동일하게 지원<tr><td>MultipartFile<td>MultipartFile<td>@RequestPart로 전달하여 동일하게 사용 가능.<tr><td>@ModelAttribute<td>-<td>지원하지 않음.</table></div><h5 id="return-values"><span class="mr-2">Return Values</span><a href="#return-values" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>일반적인 Blocking I/O에 대한 응답을 지원한다.<li>HttpHeader를 받는다거나 HttpStatus 및 Header를 포함한 ResponseEntity로 반환받는것을 지원한다.<li>webClient 기반인 경우 Webflux의 Mono나 Flux 도 함께 지원한다.</ul><div class="table-wrapper"><table><thead><tr><th>ReturnType<tbody><tr><td><code class="language-plaintext highlighter-rouge">Void / Unit</code><tr><td><code class="language-plaintext highlighter-rouge">HttpHeaders</code><tr><td><code class="language-plaintext highlighter-rouge">&lt;T&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">ResponseEntity&lt;Unit&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">ResponseEntity&lt;T&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">ResponseEntity&lt;T&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">Mono&lt;Unit&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">Mono&lt;HttpHeaders&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">Mono&lt;T&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">Flux&lt;T&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">Mono&lt;ResponseEntity&lt;Unit&gt;&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">Mono&lt;ResponseEntity&lt;T&gt;&gt;</code><tr><td><code class="language-plaintext highlighter-rouge">Mono&lt;ResponseEntity&lt;Flux&lt;T&gt;&gt;</code></table></div><h3 id="32-http-interface-client-정의"><span class="mr-2">3.2 Http Interface Client 정의</span><a href="#32-http-interface-client-정의" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>HttpInterfaceClient의 Request/Response를 어떻게 정의할지 알았으니 이제 샘플 코드를 살펴보자.<li>User(사용자) Resource 에 대한 REST API가 있다고 하고, 이를 호출하기 위한 HttpClient 코드를 정의하면 다음과 같이 정의할수 있다.</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.starter.core.clients.internal.admin.api</span>

<span class="k">import</span> <span class="nn">com.starter.core.models.user.UserCreateRequest</span>
<span class="k">import</span> <span class="nn">com.starter.core.models.user.UserPatchRequest</span>
<span class="k">import</span> <span class="nn">com.starter.core.models.user.UserResponse</span>
<span class="k">import</span> <span class="nn">com.starter.core.models.user.UserSearchRequest</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.annotation.DeleteExchange</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.annotation.GetExchange</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.annotation.HttpExchange</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.annotation.PatchExchange</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.annotation.PostExchange</span>

<span class="nd">@HttpExchange</span><span class="p">(</span><span class="s">"/api/v1/users"</span><span class="p">)</span>
<span class="kd">interface</span> <span class="nc">UserApiClient</span> <span class="p">:</span> <span class="nc">UserApi</span> <span class="p">{</span>

    <span class="nd">@PostExchange</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">create</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="n">request</span><span class="p">:</span> <span class="nc">UserCreateRequest</span><span class="p">):</span> <span class="nc">UserResponse</span>

    <span class="nd">@GetExchange</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getUsers</span><span class="p">(</span><span class="nd">@ModelAttribute</span> <span class="n">request</span><span class="p">:</span> <span class="nc">UserSearchRequest</span><span class="p">)</span> <span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">UserResponse</span><span class="p">&gt;</span>

    <span class="nd">@GetExchange</span><span class="p">(</span><span class="s">"/{uuid}"</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">uuid</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">UserResponse</span>

    <span class="nd">@PatchExchange</span><span class="p">(</span><span class="s">"/{uuid}"</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">patchUser</span><span class="p">(</span>
        <span class="nd">@PathVariable</span> <span class="n">uuid</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="nd">@RequestBody</span> <span class="n">request</span><span class="p">:</span> <span class="nc">UserPatchRequest</span>
    <span class="p">)</span>

    <span class="nd">@DeleteExchange</span><span class="p">(</span><span class="s">"/{uuid}"</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">deleteUser</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">uuid</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>구현코드를 보면 feign과 유사한 형태로 간결하게 작성이 가능한것을 알 수 있다.<li>다만, 위에서 말한것처럼 webClient 기반으로 정의할 경우 webflux 스펙도 모두 지원하므로 훨씬 더 좋다고 볼수 있다.<ul><li>사실 글을 작성하는 현재 시점에는 Spring Cloud OpenFeign 말고, 순수 Openfeign을 사용할 경우 reactiveClient로 정의할수 있는 feature가 추가된것으로 보이기는 하나, 나라면 spring 공식지원되는 spring6HttpInterface를 쓸것 같다.</ul></ul><h3 id="33-http-interface-client-configuration"><span class="mr-2">3.3 Http Interface Client Configuration</span><a href="#33-http-interface-client-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="httpserviceproxyfactory"><span class="mr-2">HttpServiceProxyFactory</span><a href="#httpserviceproxyfactory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>2.3.2에서 HttpInterface를 정의했다면 httpServiceProxyFactory를 통해 Proxy 객체를 만들어 주어야 한다.<li>공통적으로 사용할수 있도록 Util method를 정의하면 아래와 같이 만들수 있다.<li>HttpServiceProxyFactory Builder에는 더 많은 옵션이 있지만, 내가 필요했던건 customArgumentResolver를 등록하는것뿐이라 아래와 같이 구성했다.<ul><li>위 Request 정의시 ModelAttribute를 지원하지 않으므로 이를 처리할수 있도록 직접 구현한것으로 보면 된다.</ul></ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">com.starter.core.clients.common.resolver.ModelAttributeArgumentResolver</span>
<span class="k">import</span> <span class="nn">org.springframework.web.reactive.function.client.WebClient</span>
<span class="k">import</span> <span class="nn">org.springframework.web.reactive.function.client.support.WebClientAdapter</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.invoker.HttpServiceProxyFactory</span>

<span class="kd">object</span> <span class="nc">HttpInterfaceProxyFactory</span> <span class="p">{</span>

    <span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="k">reified</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="nf">create</span><span class="p">(</span>
        <span class="n">webClient</span><span class="p">:</span> <span class="nc">WebClient</span><span class="p">,</span>
        <span class="n">resolvers</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">ModelAttributeArgumentResolver</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="nc">ModelAttributeArgumentResolver</span><span class="p">.</span><span class="nc">DEFAULT_INSTANCE</span><span class="p">),</span>
    <span class="p">):</span> <span class="nc">T</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">builder</span> <span class="p">=</span> <span class="nc">HttpServiceProxyFactory</span>
            <span class="p">.</span><span class="nf">builderFor</span><span class="p">(</span><span class="nc">WebClientAdapter</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">webClient</span><span class="p">))</span>

        <span class="n">resolvers</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">builder</span><span class="p">.</span><span class="nf">customArgumentResolver</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>

        <span class="kd">val</span> <span class="py">httpServiceProxyFactory</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">httpServiceProxyFactory</span><span class="p">.</span><span class="nf">createClient</span><span class="p">(</span><span class="nc">T</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><h4 id="bean-configuration"><span class="mr-2">Bean Configuration</span><a href="#bean-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Config Class를 별도로 정의하고, 이를 필요한 곳에서 Import해서 쓸수 있는 방식으로 정의해보았다.<li>HttpInterfaceProxyFactory Util 메소드를 통해 Instance를 만들고 이를 Bean으로 등록해서 사용한다.<li>webClient는 하나의 API서버군을 바라보고 할수 있도록 정의하고, 이를 HttpClient들이 주입받아 Bean을 등록하도록 정의한다.<ul><li>이렇게 하면 Controller와 HttpClient를 1:1로 관리할수 있어서 코드를 깔끔하게 유지할수 있다.</ul></ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">com.starter.core.clients.common.HttpInterfaceProxyFactory</span>
<span class="k">import</span> <span class="nn">com.starter.core.clients.common.WebClientFactory</span>
<span class="k">import</span> <span class="nn">com.starter.core.clients.internal.InternalClientsProperties</span>
<span class="k">import</span> <span class="nn">com.starter.core.clients.internal.file.api.FileDownloadApiClient</span>
<span class="k">import</span> <span class="nn">com.starter.core.clients.internal.file.api.FileUploadApiClient</span>
<span class="k">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span>
<span class="k">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationPropertiesScan</span>
<span class="k">import</span> <span class="nn">org.springframework.context.annotation.Bean</span>
<span class="k">import</span> <span class="nn">org.springframework.context.annotation.ComponentScan</span>
<span class="k">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span>
<span class="k">import</span> <span class="nn">org.springframework.web.reactive.function.client.WebClient</span>

<span class="nd">@Configuration</span>
<span class="nd">@ConfigurationPropertiesScan</span><span class="p">(</span><span class="s">"com.starter.core.clients.internal.file"</span><span class="p">)</span>
<span class="nd">@ComponentScan</span><span class="p">(</span><span class="s">"com.starter.core.clients.internal.file"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">FileClientConfig</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">internalClientsProperties</span><span class="p">:</span> <span class="nc">InternalClientsProperties</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">FILE_WEB_CLIENT</span> <span class="p">=</span> <span class="s">"fileWebClient"</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="nc">FILE_WEB_CLIENT</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">fileWebClient</span><span class="p">():</span> <span class="nc">WebClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">WebClientFactory</span>
            <span class="p">.</span><span class="nf">createNettyClient</span><span class="p">(</span><span class="n">baseUrl</span> <span class="p">=</span> <span class="n">internalClientsProperties</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="k">fun</span> <span class="nf">fileDownloadApiClient</span><span class="p">(</span><span class="nd">@Qualifier</span><span class="p">(</span><span class="nc">FILE_WEB_CLIENT</span><span class="p">)</span> <span class="n">webClient</span><span class="p">:</span> <span class="nc">WebClient</span><span class="p">):</span> <span class="nc">FileDownloadApiClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">HttpInterfaceProxyFactory</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="nc">FileDownloadApiClient</span><span class="p">&gt;(</span><span class="n">webClient</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="k">fun</span> <span class="nf">fileUploadApiClient</span><span class="p">(</span><span class="nd">@Qualifier</span><span class="p">(</span><span class="nc">FILE_WEB_CLIENT</span><span class="p">)</span> <span class="n">webClient</span><span class="p">:</span> <span class="nc">WebClient</span><span class="p">):</span> <span class="nc">FileUploadApiClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">HttpInterfaceProxyFactory</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="nc">FileUploadApiClient</span><span class="p">&gt;(</span><span class="n">webClient</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="34-http-interface-customize"><span class="mr-2">3.4 Http Interface Customize</span><a href="#34-http-interface-customize" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="api-interface로-controller와-11로-관리하기"><span class="mr-2">Api Interface로 Controller와 1:1로 관리하기</span><a href="#api-interface로-controller와-11로-관리하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>내가 만들어둔 프로젝트 아키텍쳐에서는 특정 Client의 API를 담당하는 BFF 모듈을 별도로 만드는것을 목표로 하고 있는데, 이 경우 BFF에서 내부 모듈들의 API를 호출하고, 이를 aggregation하는등의 관리가 필요하다.<li>이때 Controller와 HttpInterface가 동일한 API임을 나타내기 위해 Api Interface를 정의하고 이를 Controller와 HttpInterface가 구현하도록 구성했다.</ul><p><a href="https://github.com/user-attachments/assets/790f67ae-a9a2-49ad-9197-b452dd320b0c" class="popup img-link "><img width="700" alt="" data-src="https://github.com/user-attachments/assets/790f67ae-a9a2-49ad-9197-b452dd320b0c" class="lazyload" data-proofer-ignore></a></p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">// FileUploadApi.kt</span>
<span class="kd">interface</span> <span class="nc">FileUploadApi</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">uploadFile</span><span class="p">(</span><span class="n">fileUploadRequest</span><span class="p">:</span> <span class="nc">FileUploadRequest</span><span class="p">):</span> <span class="nc">FileResponse</span>
<span class="p">}</span>

<span class="c1">// FileUploadRequest.kt</span>
<span class="kd">data class</span> <span class="nc">FileUploadRequest</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">fileName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">file</span><span class="p">:</span> <span class="nc">MultipartFile</span><span class="p">,</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">fileType</span><span class="p">:</span> <span class="nc">FileType</span><span class="p">,</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">description</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">uploadDirectoryType</span><span class="p">:</span> <span class="nc">UploadDirectoryType</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">FileUploadRequestInterface</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1">// FileUploadController.kt</span>
<span class="k">package</span> <span class="nn">com.starter.file.app.file.controller</span>

<span class="k">import</span> <span class="nn">com.starter.core.clients.internal.file.api.FileUploadApi</span>
<span class="k">import</span> <span class="nn">com.starter.core.models.file.FileResponse</span>
<span class="k">import</span> <span class="nn">com.starter.core.models.file.FileUploadRequest</span>
<span class="k">import</span> <span class="nn">com.starter.file.app.file.facade.FileUploadFacade</span>
<span class="k">import</span> <span class="nn">io.swagger.v3.oas.annotations.Operation</span>
<span class="k">import</span> <span class="nn">io.swagger.v3.oas.annotations.Parameter</span>
<span class="k">import</span> <span class="nn">org.springframework.http.MediaType</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"/api/v1/files/upload"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">FileUploadController</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">fileUploadFacade</span><span class="p">:</span> <span class="nc">FileUploadFacade</span><span class="p">,</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">FileUploadApi</span> <span class="p">{</span>

    <span class="nd">@PostMapping</span><span class="p">(</span><span class="n">consumes</span> <span class="p">=</span> <span class="p">[</span><span class="nc">MediaType</span><span class="p">.</span><span class="nc">MULTIPART_FORM_DATA_VALUE</span><span class="p">]</span> <span class="p">)</span>
    <span class="nd">@Operation</span><span class="p">(</span><span class="n">description</span> <span class="p">=</span> <span class="s">"파일 업로드 API"</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">uploadFile</span><span class="p">(</span><span class="nd">@Parameter</span> <span class="n">fileUploadRequest</span><span class="p">:</span> <span class="nc">FileUploadRequest</span><span class="p">):</span> <span class="nc">FileResponse</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">fileResponse</span> <span class="p">=</span> <span class="n">fileUploadFacade</span><span class="p">.</span><span class="nf">uploadFile</span><span class="p">(</span><span class="n">fileUploadRequest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fileResponse</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// FileUploadApiClient.kt</span>
<span class="nd">@HttpExchange</span><span class="p">(</span><span class="s">"/api/v1/files/upload"</span><span class="p">)</span>
<span class="kd">interface</span> <span class="nc">FileUploadApiClient</span> <span class="p">:</span> <span class="nc">FileUploadApi</span> <span class="p">{</span>

    <span class="nd">@PostExchange</span><span class="p">(</span><span class="n">contentType</span> <span class="p">=</span> <span class="nc">MediaType</span><span class="p">.</span><span class="nc">MULTIPART_FORM_DATA_VALUE</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">uploadFile</span><span class="p">(</span><span class="nd">@ModelAttribute</span> <span class="n">fileUploadRequest</span><span class="p">:</span> <span class="nc">FileUploadRequest</span><span class="p">):</span> <span class="nc">FileResponse</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>이런식으로 관리하면 code trace시에도 좀 더 편하게 코드를 추적할 수 있다.<li>하지만, HttpInterface에서 지원하는 스펙의 한계로 별도의 customize 없이는 모든 케이스를 이렇게 관리할 수 없다.</ul><h4 id="modelattributeargumentresolver"><span class="mr-2">ModelAttributeArgumentResolver</span><a href="#modelattributeargumentresolver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>위 코드를 보면 Controller에서는 파일 업로드를 위해 MultipartFile를 포함한 Model를 받고 있다.<ul><li>별도의 구현이 없다면 HttpInterface에서는 <code class="language-plaintext highlighter-rouge">@RequestPart</code> 를 통해 파일을 전달해주어야 한다.<li><code class="language-plaintext highlighter-rouge">multipart/form-data</code> 외에도 RequestParamter가 많은 경우 <code class="language-plaintext highlighter-rouge">@RequestParam</code> 을 나열하는 경우를 방지하기 위해 하나의 Request Model Class를 선언하기도 하는데, 이부분에서도 지원하지 않는다.</ul><li>위의 문제 해결을 위해 Custom ArgumentResolver를 구현해보자.</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.starter.core.clients.common.resolver</span>

<span class="k">import</span> <span class="nn">com.starter.core.common.utils.JsonUtil</span>
<span class="k">import</span> <span class="nn">com.starter.core.common.utils.ReflectionUtils</span>
<span class="k">import</span> <span class="nn">mu.KLogging</span>
<span class="k">import</span> <span class="nn">org.springframework.core.MethodParameter</span>
<span class="k">import</span> <span class="nn">org.springframework.core.io.Resource</span>
<span class="k">import</span> <span class="nn">org.springframework.http.HttpEntity</span>
<span class="k">import</span> <span class="nn">org.springframework.http.HttpHeaders</span>
<span class="k">import</span> <span class="nn">org.springframework.lang.Nullable</span>
<span class="k">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span>
<span class="k">import</span> <span class="nn">org.springframework.web.multipart.MultipartFile</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.invoker.HttpRequestValues</span>
<span class="k">import</span> <span class="nn">org.springframework.web.service.invoker.HttpServiceArgumentResolver</span>
<span class="k">import</span> <span class="nn">kotlin.reflect.KFunction1</span>

<span class="kd">class</span> <span class="nc">ModelAttributeArgumentResolver</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">argumentToMapFunc</span><span class="p">:</span> <span class="nc">KFunction1</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">,</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Any</span><span class="p">?&gt;&gt;</span> <span class="p">=</span> <span class="nc">ReflectionUtils</span><span class="o">::</span><span class="n">objectToMap</span><span class="p">,</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">HttpServiceArgumentResolver</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">:</span> <span class="nc">KLogging</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">DEFAULT_INSTANCE</span> <span class="p">=</span> <span class="nc">ModelAttributeArgumentResolver</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">INSTANCE_WITH_JSON</span> <span class="p">=</span> <span class="nc">ModelAttributeArgumentResolver</span><span class="p">(</span>
            <span class="nc">JsonUtil</span><span class="o">::</span><span class="n">toMap</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">resolve</span><span class="p">(</span>
        <span class="n">argument</span><span class="p">:</span> <span class="nc">Any</span><span class="p">?,</span>
        <span class="n">parameter</span><span class="p">:</span> <span class="nc">MethodParameter</span><span class="p">,</span>
        <span class="n">requestValues</span><span class="p">:</span> <span class="nc">HttpRequestValues</span><span class="p">.</span><span class="nc">Builder</span>
    <span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">getParameterAnnotation</span><span class="p">(</span><span class="nc">ModelAttribute</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
            <span class="o">?:</span> <span class="k">return</span> <span class="k">false</span>

        <span class="k">if</span><span class="p">(</span><span class="n">argument</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span>
        <span class="p">}</span>

        <span class="kd">val</span> <span class="py">argumentMap</span> <span class="p">=</span> <span class="nf">argumentToMapFunc</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">isPartRequest</span> <span class="p">=</span> <span class="nf">isPartRequest</span><span class="p">(</span><span class="n">argumentMap</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"argumentMap: $argumentMap,  isPartRequest: $isPartRequest"</span> <span class="p">}</span>
        <span class="n">argumentMap</span>
            <span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">value</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">}</span>
            <span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">isPartRequest</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nf">addRequestPartValues</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">value</span><span class="o">!!</span><span class="p">,</span> <span class="n">requestValues</span> <span class="p">=</span> <span class="n">requestValues</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nf">addRequestParamValues</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">value</span><span class="o">!!</span><span class="p">,</span> <span class="n">requestValues</span> <span class="p">=</span> <span class="n">requestValues</span><span class="p">)</span>
                <span class="p">}</span>

            <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span>
    <span class="p">}</span>

    <span class="nd">@Nullable</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">isPartRequest</span><span class="p">(</span><span class="n">argumentMap</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span><span class="nc">Any</span><span class="p">?&gt;):</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">argumentMap</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span> <span class="n">it</span> <span class="k">is</span> <span class="nc">MultipartFile</span> <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">private</span> <span class="k">fun</span> <span class="nf">addRequestParamValues</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nc">Any</span><span class="p">,</span> <span class="n">requestValues</span><span class="p">:</span> <span class="nc">HttpRequestValues</span><span class="p">.</span><span class="nc">Builder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="nc">Collection</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;)</span> <span class="p">{</span>
            <span class="n">requestValues</span><span class="p">.</span><span class="nf">addRequestParameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="nf">joinToString</span><span class="p">())</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">requestValues</span><span class="p">.</span><span class="nf">addRequestParameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="nf">toString</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">addRequestPartValues</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nc">Any</span><span class="p">,</span> <span class="n">requestValues</span><span class="p">:</span> <span class="nc">HttpRequestValues</span><span class="p">.</span><span class="nc">Builder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="nc">Collection</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;)</span> <span class="p">{</span>
            <span class="n">requestValues</span><span class="p">.</span><span class="nf">addRequestPart</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="nf">joinToString</span><span class="p">())</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="nc">MultipartFile</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">value</span> <span class="p">=</span> <span class="nf">toMultipartFileHttpEntity</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">requestValues</span><span class="p">.</span><span class="nf">addRequestPart</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">requestValues</span><span class="p">.</span><span class="nf">addRequestPart</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="nf">toString</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">toMultipartFileHttpEntity</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">multipartFile</span><span class="p">:</span> <span class="nc">MultipartFile</span><span class="p">):</span> <span class="nc">HttpEntity</span><span class="p">&lt;</span><span class="nc">Resource</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">headers</span> <span class="p">=</span> <span class="nc">HttpHeaders</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">multipartFile</span><span class="p">.</span><span class="n">originalFilename</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">headers</span><span class="p">.</span><span class="nf">setContentDispositionFormData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">multipartFile</span><span class="p">.</span><span class="n">originalFilename</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">multipartFile</span><span class="p">.</span><span class="n">contentType</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">headers</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">HttpHeaders</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">,</span> <span class="n">multipartFile</span><span class="p">.</span><span class="n">contentType</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nc">HttpEntity</span><span class="p">&lt;</span><span class="nc">Resource</span><span class="p">&gt;(</span><span class="n">multipartFile</span><span class="p">.</span><span class="n">resource</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><ul><li>위 구현코드는 @ModelAttribute 애노테이션이 달린 class에 대해서 Controller와 동일하게 동작할수 있도록 직접 구현한 코드이다.<ul><li>현재는 이에 대한 공식적인 ArgumentResolver가 없기 떄문이 이를 등록해서 사용할수 있다.<li>만약 공식 지원이 된다면 그때 삭제하거나 ModelAttribute에 대해 지원을 하지만, 의도와 다른 게 있다면 별도의 annotaiton으로 정의해서 사용할수 있을것이다.<li>argument을 request에 넣어주기 위해 map으로 변환한 뒤 체크를 하는데, 필요에 따라 reflection 혹은 json 방식으로 사용할 수 있다.</ul></ul><h2 id="4-결론"><span class="mr-2">4. 결론</span><a href="#4-결론" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Spring 기반 웹 애플리케이션을 개발할때 필연적으로 API를 호출하기 위한 HttpClient가 필요하다.<li>이 떄, 우리는 무엇을 어떻게 쓸지를 고민하는데 Spring 6 이후부터는 큰 고민 없이 Http Interface Client 사용을 고려할 수 있을것 같다.<li>하지만, 위에서 Customize 한 것 이외에 부가적인 문제 해결이 필요한 부분이 아직 남아있는데, 이 부분은 이후 포스팅을 통해 공유하려고 한다.<li>관련 코드는 <a href="https://github.com/sungsu9022/kotlin-spring-multi-module-starter/tree/1.240914">starter/1.240914</a> 에서 확인할수 있다.</ul><h2 id="refernece"><span class="mr-2">Refernece</span><a href="#refernece" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://docs.spring.io/spring-framework/reference/web/webflux-http-interface-client.html">Spring Http Interface Client 공식문서</a><li><a href="https://github.com/spring-cloud/spring-cloud-openfeign">Spring Cloud OpenFeign</a><li><a href="https://github.com/OpenFeign/feign">OpenFeign</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/kotlin/" class="post-tag no-text-decoration" >Kotlin</a> <a href="/tags/spring/" class="post-tag no-text-decoration" >Spring</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Spring]%20Spring6%20Http%20Interface%20Client%20-%201%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-spring6-http-clients-1%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Spring]%20Spring6%20Http%20Interface%20Client%20-%201%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-spring6-http-clients-1%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-spring6-http-clients-1%2F&text=[Spring]%20Spring6%20Http%20Interface%20Client%20-%201%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/devlog-spring-boot-application/"><div class="card-body"> <em class="small" data-ts="1588264440" data-df="ll" > May 1, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot + JPA + H2 Application 간단하게 띄우기</h3><div class="text-muted small"><p> Spring Boot + JPA + H2 Application 간단하게 띄우기 1. 프로젝트 만들기 2. 애플리케이션 기본 설정 3. Web MVC Configuration 4. JSP Configration 5. JPA Configration 1. 프로젝트 만들기 1.1 spring initializr을 통해 프로젝트 뼈대 만...</p></div></div></a></div><div class="card"> <a href="/posts/devlog-spring-boot-tools/"><div class="card-body"> <em class="small" data-ts="1588494840" data-df="ll" > May 3, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot JSP 자동 reload 되지 않는 문제 해결 방법</h3><div class="text-muted small"><p> Spring Boot JSP 자동 reload 되지 않는 문제 해결 방법 내용 legacy Spring Project에서 Spring boot로 전환되었을때 즉시 발견할수 있는 문제중 하나는 IDE에서 jsp파일을 수정해도 auto reload되지 않는 문제입니다. 이 경우 JSP에 수정사항을 반영하기 위해서는 Application을 재시작해야...</p></div></div></a></div><div class="card"> <a href="/posts/devlog-spring-aop/"><div class="card-body"> <em class="small" data-ts="1592814840" data-df="ll" > Jun 22, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring AOP 이야기 - AOP는 언제 써야할까?</h3><div class="text-muted small"><p> Spring AOP Spring을 공부하다보면 필연적으로 AOP를 만나게 되는데, 개발자들은 이걸 언제 쓰는게 좋을지 고민하곤 하는데요. 관련해서 사용방법과 언제 써야할지를 한번 알아보겠습니다. 1. AOP란? 부가기능 모듈을 객체지향 기술에서 주로 사용하는 오브젝트와는 다르게 특별한 이름으로 부르기 시작한 것 그 자체로 애플리케이션...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/es-bible-8/" class="btn btn-outline-primary" prompt="Older"><p>[엘라스틱서치 바이블] 8. 엘라스틱서치의 내부 동작 상세</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/devlog-spring6-http-clients-1/'; this.page.identifier = '/posts/devlog-spring6-http-clients-1/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>

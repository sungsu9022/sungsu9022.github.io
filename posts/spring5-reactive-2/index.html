<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="[Hands-On Reactive Programming in Spring 5] 2. 스프링을 이용한 리액티브 프로그래밍 기본 개념" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="2. 스프링을 이용한 리액티브 프로그래밍 기본 개념 관찰자 패턴 스프링 서버에서 보낸 이벤트를 구현한 발행-구독(Publish-Subscribe) 구현 RxJava 역사 및 기본 개념 마블(Marble) 다이어그램 리액티브 프로그래밍을 적용한 비즈니스 사례 리액티브 라이브러리의 현재 상황" /><meta property="og:description" content="2. 스프링을 이용한 리액티브 프로그래밍 기본 개념 관찰자 패턴 스프링 서버에서 보낸 이벤트를 구현한 발행-구독(Publish-Subscribe) 구현 RxJava 역사 및 기본 개념 마블(Marble) 다이어그램 리액티브 프로그래밍을 적용한 비즈니스 사례 리액티브 라이브러리의 현재 상황" /><link rel="canonical" href="https://sungsu9022.github.io/posts/spring5-reactive-2/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/spring5-reactive-2/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-18T13:28:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Hands-On Reactive Programming in Spring 5] 2. 스프링을 이용한 리액티브 프로그래밍 기본 개념" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2022-10-22T16:37:30+09:00","datePublished":"2022-06-18T13:28:00+09:00","description":"2. 스프링을 이용한 리액티브 프로그래밍 기본 개념 관찰자 패턴 스프링 서버에서 보낸 이벤트를 구현한 발행-구독(Publish-Subscribe) 구현 RxJava 역사 및 기본 개념 마블(Marble) 다이어그램 리액티브 프로그래밍을 적용한 비즈니스 사례 리액티브 라이브러리의 현재 상황","headline":"[Hands-On Reactive Programming in Spring 5] 2. 스프링을 이용한 리액티브 프로그래밍 기본 개념","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/spring5-reactive-2/"},"url":"https://sungsu9022.github.io/posts/spring5-reactive-2/"}</script><title>[Hands-On Reactive Programming in Spring 5] 2. 스프링을 이용한 리액티브 프로그래밍 기본 개념 | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[Hands-On Reactive Programming in Spring 5] 2. 스프링을 이용한 리액티브 프로그래밍 기본 개념</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>[Hands-On Reactive Programming in Spring 5] 2. 스프링을 이용한 리액티브 프로그래밍 기본 개념</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1655526480" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 18, 2022 </em> </span> <span> Updated <em class="" data-ts="1666424250" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 22, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5984 words"> <em>33 min</em> read</span></div></div></div><div class="post-content"><h1 id="2-스프링을-이용한-리액티브-프로그래밍-기본-개념">2. 스프링을 이용한 리액티브 프로그래밍 기본 개념</h1><blockquote><p>관찰자 패턴 스프링 서버에서 보낸 이벤트를 구현한 발행-구독(Publish-Subscribe) 구현 RxJava 역사 및 기본 개념 마블(Marble) 다이어그램 리액티브 프로그래밍을 적용한 비즈니스 사례 리액티브 라이브러리의 현재 상황</p></blockquote><h2 id="21-리액티브를-위한-스프링-프레임워크의-초기-해법"><span class="mr-2">2.1 리액티브를 위한 스프링 프레임워크의 초기 해법</span><a href="#21-리액티브를-위한-스프링-프레임워크의-초기-해법" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>콜백 및 CompletableFuture 는 메시지 기반 아키텍처를 구현하는데 널리 사용된다. 이러한 역할을 수행하는 주요 후보로 <code class="language-plaintext highlighter-rouge">리액티브 프로그래밍</code>을 이야이기할수 있다.<li>스프링 프레잌워크는 리액티브 애플리케이션을 구축하는데 유용한 기능들을 제공하고 이를 일부 살펴보도록 하자</ul><h3 id="211-관찰자observer-패턴"><span class="mr-2">2.1.1 관찰자(Observer) 패턴</span><a href="#211-관찰자observer-패턴" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>관찰자 패턴이 리액티브 프로그래밍과 관련이 없는것처럼 보일수 있으나 약간만 수정하면 그것이 리액티브 프로그래밍 기초가 된다.<li>관찰자 패턴은 관찰자라고 불리는 자손의 리스트를 가지고 있는 주체(subject)를 필요로 한다.<li>subject는 자신의 메소드 중 하나를 호출해 관찰자에게 상태변경을 알린다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/174429162-f8ea4c4a-d1ff-409c-b4e9-895b446322fe.png" class="popup img-link "><img width="529" alt="스크린샷 2022-06-18 오후 5 14 17" data-src="https://user-images.githubusercontent.com/6982740/174429162-f8ea4c4a-d1ff-409c-b4e9-895b446322fe.png" class="lazyload" data-proofer-ignore></a></p><ul><li>관찰자 패턴을 사요용하면 런타임에 객체 사이에 일대다 의존성을 등록할 수 있다.<li>보통 이런 유형의 통신은 단방향으로 이루어지고, 각 부분이 활발히 상호작용하게 하면서 각각의 결합도를 낮출수 있다.<li>이 시스템을 통해 효율적으로 이벤트를 배포할수 있다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/174429214-37e117ce-efdb-4f72-8133-ca48427fd903.png" class="popup img-link "><img width="709" alt="스크린샷 2022-06-18 오후 5 15 46" data-src="https://user-images.githubusercontent.com/6982740/174429214-37e117ce-efdb-4f72-8133-ca48427fd903.png" class="lazyload" data-proofer-ignore></a></p><ul><li>SubJect와 Observer 2개의 인터페이스로 구성되고, Observer는 usbject에 등록되고 Subject로부터 알림을 수신한다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Observer</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="kt">void</span> <span class="nf">observe</span><span class="o">(</span><span class="no">T</span> <span class="n">event</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Subject</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="kt">void</span> <span class="nf">registerObserver</span><span class="o">(</span><span class="nc">Observer</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">);</span>
   <span class="kt">void</span> <span class="nf">unregisterObserver</span><span class="o">(</span><span class="nc">Observer</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">);</span>
   <span class="kt">void</span> <span class="nf">notifyObservers</span><span class="o">(</span><span class="no">T</span> <span class="n">event</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>Observer와 Subject 모두 인터페이스에 기술된 것 이상은 서로에 대해 알지 못한다.<li>Observer 인스턴스는 Subject의 존재를 전혀 인식하지 못할수도 있음. 이 경우 Observers을 등록해주는 역할을 담당할 세번쨰 컴포넌트가 필요할 수도 있다.(Srping DI와 같은 방식이 예시가 될수 있음.)</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcreteObserverA</span> <span class="kd">implements</span> <span class="nc">Observer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">observe</span><span class="o">(</span><span class="nc">String</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Observer A: "</span> <span class="o">+</span> <span class="n">event</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcreteObserverB</span> <span class="kd">implements</span> <span class="nc">Observer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">observe</span><span class="o">(</span><span class="nc">String</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Observer B: "</span> <span class="o">+</span> <span class="n">event</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcreteSubject</span> <span class="kd">implements</span> <span class="nc">Subject</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Observer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">observers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArraySet</span><span class="o">&lt;&gt;();</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerObserver</span><span class="o">(</span><span class="nc">Observer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">observers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterObserver</span><span class="o">(</span><span class="nc">Observer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">observers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyObservers</span><span class="o">(</span><span class="nc">String</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">observers</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">observer</span> <span class="o">-&gt;</span> <span class="n">observer</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="n">event</span><span class="o">));</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>SUbject의 구현체 안에는 notify를 받는 데 관심이 있는 Observer Set이 있다.<li>registerObserver 및 unregisterObserver 메서드를 이용해 수정(구독 or 구독 취소)가 가능하다.</ul><h3 id="212-관찰자-패턴-사용-예시"><span class="mr-2">2.1.2 관찰자 패턴 사용 예시</span><a href="#212-관찰자-패턴-사용-예시" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">observersHandleEventsFromSubjectWithAssertions</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// given</span>
      <span class="nc">Subject</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcreteSubject</span><span class="o">();</span>
      <span class="nc">Observer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">observerA</span> <span class="o">=</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">spy</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConcreteObserverA</span><span class="o">());</span>
      <span class="nc">Observer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">observerB</span> <span class="o">=</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">spy</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConcreteObserverB</span><span class="o">());</span>

      <span class="c1">// when</span>
      <span class="n">subject</span><span class="o">.</span><span class="na">notifyObservers</span><span class="o">(</span><span class="s">"No listeners"</span><span class="o">);</span>

      <span class="n">subject</span><span class="o">.</span><span class="na">registerObserver</span><span class="o">(</span><span class="n">observerA</span><span class="o">);</span>
      <span class="n">subject</span><span class="o">.</span><span class="na">notifyObservers</span><span class="o">(</span><span class="s">"Message for A"</span><span class="o">);</span>

      <span class="n">subject</span><span class="o">.</span><span class="na">registerObserver</span><span class="o">(</span><span class="n">observerB</span><span class="o">);</span>
      <span class="n">subject</span><span class="o">.</span><span class="na">notifyObservers</span><span class="o">(</span><span class="s">"Message for A &amp; B"</span><span class="o">);</span>

      <span class="n">subject</span><span class="o">.</span><span class="na">unregisterObserver</span><span class="o">(</span><span class="n">observerA</span><span class="o">);</span>
      <span class="n">subject</span><span class="o">.</span><span class="na">notifyObservers</span><span class="o">(</span><span class="s">"Message for B"</span><span class="o">);</span>

      <span class="n">subject</span><span class="o">.</span><span class="na">unregisterObserver</span><span class="o">(</span><span class="n">observerB</span><span class="o">);</span>
      <span class="n">subject</span><span class="o">.</span><span class="na">notifyObservers</span><span class="o">(</span><span class="s">"No listeners"</span><span class="o">);</span>

      <span class="c1">// then</span>
      <span class="nc">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">observerA</span><span class="o">,</span> <span class="n">times</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
              <span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="s">"Message for A"</span><span class="o">);</span>
      <span class="nc">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">observerA</span><span class="o">,</span> <span class="n">times</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
              <span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="s">"Message for A &amp; B"</span><span class="o">);</span>
      <span class="nc">Mockito</span><span class="o">.</span><span class="na">verifyNoMoreInteractions</span><span class="o">(</span><span class="n">observerA</span><span class="o">);</span>

      <span class="nc">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">observerB</span><span class="o">,</span> <span class="n">times</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
              <span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="s">"Message for A &amp; B"</span><span class="o">);</span>
      <span class="nc">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">observerB</span><span class="o">,</span> <span class="n">times</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
              <span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="s">"Message for B"</span><span class="o">);</span>
      <span class="nc">Mockito</span><span class="o">.</span><span class="na">verifyNoMoreInteractions</span><span class="o">(</span><span class="n">observerB</span><span class="o">);</span>
   <span class="o">}</span>
</pre></table></code></div></div><h4 id="구독을-취소할-필요가-없는-경우-java-8-람다을-사용해서-구현할수-있다"><span class="mr-2">구독을 취소할 필요가 없는 경우 Java 8 람다을 사용해서 구현할수 있다.</span><a href="#구독을-취소할-필요가-없는-경우-java-8-람다을-사용해서-구현할수-있다" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subjectLeveragesLambdas</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Subject</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcreteSubject</span><span class="o">();</span>

      <span class="n">subject</span><span class="o">.</span><span class="na">registerObserver</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">));</span>
      <span class="n">subject</span><span class="o">.</span><span class="na">registerObserver</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"B: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">));</span>
      <span class="n">subject</span><span class="o">.</span><span class="na">notifyObservers</span><span class="o">(</span><span class="s">"This message will receive A &amp; B"</span><span class="o">);</span>
   <span class="o">}</span>
</pre></table></code></div></div><h4 id="copyonwritearrayset"><span class="mr-2">CopyOnWriteArraySet</span><a href="#copyonwritearrayset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>CopyOnWriteArraySet은 크기가 일반적으로 작고 읽기 전용 작업이 변경 작업보다 훨씬 많을 때 사용하면 좋은 자료구조인데, thread safety 가 보장되기 떄문에 멀티 스레드 환경에서 사용할 수 있습니다.<li>하지만 변경 작업 같은 경우(add, set, remove) snapshot(복제본)을 이용하여 변경작업을 하기 때문에 비용이 비싸다.<li>내부적으로 object lock, synchronized 등이 사용되기 때문에 읽기 작업이 많고 변경작업이 적은 경우에 사용하는 것이 좋다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Object</span><span class="o">[]</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">getArray</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="nc">Object</span><span class="o">[]</span> <span class="n">newElements</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elements</span><span class="o">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">newElements</span><span class="o">[</span><span class="n">len</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="n">setArray</span><span class="o">(</span><span class="n">newElements</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><h4 id="thread-pool을-활룡한-메시지-병렬-처리"><span class="mr-2">thread pool을 활룡한 메시지 병렬 처리</span><a href="#thread-pool을-활룡한-메시지-병렬-처리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>대기 시간이 긴 이벤트를 처리하는 관찰자가 많은 경우 다음과 같이 병렬 처리할 수 있다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyObservers</span><span class="o">(</span><span class="nc">String</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">observers</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">observer</span> <span class="o">-&gt;</span>
              <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span>
                      <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">observer</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>
              <span class="o">)</span>
      <span class="o">);</span>
   <span class="o">}</span>
</pre></table></code></div></div><ul><li>주의할 점은 자바에서 스레드당 약 1MB를 소비하므로 일반 JVM 응용 프로그램은 몇천개의 스레드만으로도 사용 가능한 메모리를 모두 소모할 수 있다.<ul><li>추가적으로 thread 1개가 생성될떄 1MB 메모리를 바로 소비한다는 의미는 아니고, 64bit OS 기준으로 stack size가 1MB까지만 할당된다는 의미<li>그리고 실제로 malloc은 단순히 가상 페이지 를 지정 하기만 할뿐 실제로 사용될 때까지 물리적 페이지 가 할당되지는 않는다. 아마도 추측하기에는 JVM애플리케이션의 <code class="language-plaintext highlighter-rouge">스레드 개수 * 1MB</code> &gt; <code class="language-plaintext highlighter-rouge">Max Heap Size</code> 더라도 애플리케이션 구동 자체에 문제가 없는 이뉴는 이런 이유가 아닐까 싶음.</ul></ul><blockquote><div class="table-wrapper"><table><tbody><tr><td>JVM Thread stack size 확인 : java -XX : + PrintFlagFinal -version<td>grep ThreadStackSize</table></div></blockquote><h4 id="javautil-패키지-observer-및-observable"><span class="mr-2">java.util 패키지 Observer 및 Observable</span><a href="#javautil-패키지-observer-및-observable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>JDK 1.0에서 릴리즈되어 제네릭 적용이 안되어 있음. 컴파일 타임에 타입 안정성을 보장하지 않기 떄문에 사용을 지양 해야 함.<li>직접 구현해서 사용할수 도있지만 오류 처리, 비동기 실행, 스레드 안정성, 성능 등 직접적인 관리 비용이 크므로 성숙한 구현체 라이브러리를 사용하도록 하자!</ul><h3 id="213-eventlistener을-사용한-발행-구독-패턴"><span class="mr-2">2.1.3 <code class="language-plaintext highlighter-rouge">@EventListener</code>을 사용한 발행-구독 패턴</span><a href="#213-eventlistener을-사용한-발행-구독-패턴" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Spring에서는 <code class="language-plaintext highlighter-rouge">@EventListener</code> 애토네이션과 이벤트 발행을 위한 <code class="language-plaintext highlighter-rouge">ApplicationEventPublisher</code> 클래스를 제공한다.<li>이는 관찰자 패턴과 달리 게시자와 구독자는 다음 그림과 같이 서로를 알 필요가 없다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/174430439-7d1d83d1-a7ca-411d-80b6-86c7bb594c11.png" class="popup img-link "><img width="541" alt="스크린샷 2022-06-18 오후 5 53 27" data-src="https://user-images.githubusercontent.com/6982740/174430439-7d1d83d1-a7ca-411d-80b6-86c7bb594c11.png" class="lazyload" data-proofer-ignore></a></p><ul><li>발행-구독 패턴은 게시자와 구독자 간에 간접적인 계층을 제공한다.<li>이벤트 채널(메시지 브로커 또는 이벤트 버스라고도 함)은 수신 메시지를 구독자에게 배포하기 전에 필터링 작업을 할수도 있음.<li>토픽 기반 시스템(topic-based-system)의 구독자는 관심 토픽에 게시된 모든 메시지를 수신하게 된다.<li><code class="language-plaintext highlighter-rouge">@EventListener</code> 애노테이션은 토픽 기반 라우팅과 내용 기반 라우팅 모두에 사용할 수 있다.<li>조건 속성(condition attribute)은 스프링 표현 언어(SPring Expression Languages, SpEL)을 사용하는 내용 기반 라우팅 이벤트 처리를 가능하게 한다.</ul><h3 id="214-eventlistener을-활용한-애플리케이션-개발"><span class="mr-2">2.1.4 <code class="language-plaintext highlighter-rouge">@EventListener</code>을 활용한 애플리케이션 개발</span><a href="#214-eventlistener을-활용한-애플리케이션-개발" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>서버에서 클라이언트로의 비동기 메시지를 전달할 수 있는 웹소켓(WebSocket) 및 SSE(Server-Sent Events) 프로토콜이 있다.<li>일반적으로 SSE는 브라우저에 메시지를 업데이트하거나 연속적인 데이터 스트림을 보내는 데 사용<li>SSE기 리액티브 시스템의 구성 요소간에 통신 요구사항을 충족시키는 최고의 후보이다.</ul><h4 id="websocket-vs-sse-간단한-차이점-비교"><span class="mr-2">WebSocket vs SSE 간단한 차이점 비교</span><a href="#websocket-vs-sse-간단한-차이점-비교" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://user-images.githubusercontent.com/6982740/174430852-543dceb6-386d-4c6e-a828-7e8a86df7a64.png" class="popup img-link "><img width="808" alt="스크린샷 2022-06-18 오후 6 05 42" data-src="https://user-images.githubusercontent.com/6982740/174430852-543dceb6-386d-4c6e-a828-7e8a86df7a64.png" class="lazyload" data-proofer-ignore></a></p><h4 id="스프링-웹-mvc를-이용한-비동기-http-통신"><span class="mr-2">스프링 웹 MVC를 이용한 비동기 HTTP 통신</span><a href="#스프링-웹-mvc를-이용한-비동기-http-통신" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>서비릇 3.0에서 추가된 비동기 지원 기능은 HTTP 요청을 처리하는 기능을 확장했고, 컨테이너 스레드를 사용하는 방식으로 구현됨.<li><code class="language-plaintext highlighter-rouge">Callable&lt;T&gt;</code>는 컨테이너 스레드 외부에서 실행될수도 있지만 블로킹 호출<li><code class="language-plaintext highlighter-rouge">DeferredResult&lt;T&gt;</code>는 <code class="language-plaintext highlighter-rouge">setResult(T result)</code> 메서드를 호출해 컨테이너 스레드 외부에서도 비동기 응답을 생성하므로 이벤트 루프 안에서 사용할 수 있음.<li>Spring 4.2부터 지원하는 <code class="language-plaintext highlighter-rouge">ResponseBodyEmitter</code>가 <code class="language-plaintext highlighter-rouge">DeferredResult</code>와 비슷하게 동작한다.<li><code class="language-plaintext highlighter-rouge">SseEmitter</code>는 <code class="language-plaintext highlighter-rouge">ResponseBodyEmitter</code>을 상속하는 구조로 되어있고, 이걸 사용하면 데이터(payload)를 비동기적으로 보낼 수 있다.<ul><li>이때 서블릿 스레드를 차단하지 않기 때문에 큰 파일을 스트리밍해야 하는 경우 매우 유용하다.</ul></ul><h4 id="sse-엔드포인트-노출"><span class="mr-2">SSE 엔드포인트 노출</span><a href="#sse-엔드포인트-노출" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>온도 센서로부터 사용자에게 랜덤한 온도를 전달하는 SSE 엔드포인트</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TemperatureController</span> <span class="o">{</span>
   <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">SSE_SESSION_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000L</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">TemperatureController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SseEmitter</span><span class="o">&gt;</span> <span class="n">clients</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArraySet</span><span class="o">&lt;&gt;();</span>

   <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/temperature-stream"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
   <span class="kd">public</span> <span class="nc">SseEmitter</span> <span class="nf">events</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"SSE stream opened for client: "</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddr</span><span class="o">());</span>
      <span class="nc">SseEmitter</span> <span class="n">emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SseEmitter</span><span class="o">(</span><span class="no">SSE_SESSION_TIMEOUT</span><span class="o">);</span>
      <span class="n">clients</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">emitter</span><span class="o">);</span>

      <span class="c1">// Remove SseEmitter from active clients on error or client disconnect</span>
      <span class="n">emitter</span><span class="o">.</span><span class="na">onTimeout</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">clients</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">emitter</span><span class="o">));</span>
      <span class="n">emitter</span><span class="o">.</span><span class="na">onCompletion</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">clients</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">emitter</span><span class="o">));</span>

      <span class="k">return</span> <span class="n">emitter</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Async</span>
   <span class="nd">@EventListener</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Temperature</span> <span class="n">temperature</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">format</span><span class="o">(</span><span class="s">"Temperature: %4.2f C, active subscribers: %d"</span><span class="o">,</span>
         <span class="n">temperature</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">clients</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>

      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SseEmitter</span><span class="o">&gt;</span> <span class="n">deadEmitters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
      <span class="n">clients</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">emitter</span> <span class="o">-&gt;</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
            <span class="n">emitter</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">temperature</span><span class="o">,</span> <span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Sent to client, took: {}"</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">()));</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">deadEmitters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">emitter</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">});</span>
      <span class="n">clients</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">deadEmitters</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>SseEmitter 클래스는 SSE 이벤트를 보내는 목적으로만 이 클래스를 사용할 수 있다.<li>Controller에서 <code class="language-plaintext highlighter-rouge">SseEmitter</code>을 반환하지만 실제로는 <code class="language-plaintext highlighter-rouge">SseEmitter.complete()</code> 메소드가 호출되거나 오류 발생 또는 시간 초과 발생할 때까지 실제 요청 처리는 계속 된다.</ul><h4 id="비동기-지원-설정"><span class="mr-2">비동기 지원 설정</span><a href="#비동기-지원-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nd">@EnableAsync</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="kd">implements</span> <span class="nc">AsyncConfigurer</span> <span class="o">{</span>

   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="nc">Executor</span> <span class="nf">getAsyncExecutor</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">setThreadNamePrefix</span><span class="o">(</span><span class="s">"sse-"</span><span class="o">);</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
      <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="nc">AsyncUncaughtExceptionHandler</span> <span class="nf">getAsyncUncaughtExceptionHandler</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleAsyncUncaughtExceptionHandler</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">@EnableAsync</code>을 통해 Async Auto Configration을 수행<li>Executor setQueueCapacity 설정을 통해 스레드풀 사이즈를 적절히 조절<li>이걸 지정하지 않으면 내부적으로는 Integer.MAX_VALUE 사이즈의 LinkedBlockingQueue를 생성해서 core 사이즈만큼의 스레드에서 task를 처리할 수 없을 경우 queue에서 대기하게 됩니다. queue가 꽉 차게 되면 그때 max 사이즈만큼 스레드를 생성해서 처리하게 됩니다.<li>이런 옵션 조절을 통해 동시성 성능을 제어한다고 이해하면 됨.</ul><h4 id="sse를-지원하는-ui-작성"><span class="mr-2">SSE를 지원하는 UI 작성</span><a href="#sse를-지원하는-ui-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"events"</span><span class="nt">&gt;&lt;/ul&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"application/javascript"</span><span class="nt">&gt;</span>
<span class="kd">function</span> <span class="nf">add</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">li</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">events</span><span class="dl">"</span><span class="p">).</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">eventSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EventSource</span><span class="p">(</span><span class="dl">"</span><span class="s2">/temperature-stream</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">eventSource</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">fixed</span> <span class="o">=</span> <span class="nc">Number</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nf">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">Temperature: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">fixed</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> C</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">eventSource</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">Connection opened</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">eventSource</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">Connection closed</span><span class="dl">'</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></table></code></div></div><ul><li>웹페이지는 EventSource를 통해 클라이언트 및 서버 접속을 유지하고 이벤트를 수신한다.<li>또 네트워크 문제 발생이나 접속 시간이 초과하는 경우 자동으로 재접속한다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/174432103-33b271d8-7d91-4a7e-bf2a-6c0de28c3a26.png" class="popup img-link "><img width="270" alt="스크린샷 2022-06-18 오후 6 41 22" data-src="https://user-images.githubusercontent.com/6982740/174432103-33b271d8-7d91-4a7e-bf2a-6c0de28c3a26.png" class="lazyload" data-proofer-ignore></a></p><h4 id="솔루션에-대한-평가"><span class="mr-2">솔루션에 대한 평가</span><a href="#솔루션에-대한-평가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>지금까지 설명한 솔루션에는 몇가지 문제가 있다.<li>Spring에서 제공하는 발행-구독 매커니즘은 애플리케이션 생명주기 이벤트를 처리하기 위해 도입되었고, 고부하 및 고성능 시나리오를 위한 것이 아니다.<li>또한 비즈니스 로직을 정의하고 구현하기 위해 스프링 내부 매커니즘을 사용해야 하므로 프레임워크의 사소한 변경으로 인해 전체 애플리케이션의 안정성을 위협할 수 있다.<li>또 많은 메서드에 <code class="language-plaintext highlighter-rouge">@EventListener</code> 애노테이션이 붙어 있고, 전체 워크플로를 설명하는 한줄의 명시적 스크립트도 없는 애플리케이션이라는 것도 단점일수 있다.<li><code class="language-plaintext highlighter-rouge">SseEmitter</code>을 사용하면 스트림의 종료와 오류 처리에 대한 구현을 추가할 수 있지만 <code class="language-plaintext highlighter-rouge">@EventListener</code>는 그렇지 않다.<li>이벤트를 비동기적으로 브로드캐스팅하기 위해 스레드풀을 사용하는데 이는 진정한 비동기적 리액티브 접근에서는 필요 없는 일.<li>이러한 문제점 해결을 위해 널리 채택된 최초의 리액티브 라이브러리인 RxJava를 알아보도록 하자.</ul><h2 id="22-리액티브-프레임워크-rxjava"><span class="mr-2">2.2 리액티브 프레임워크 RxJava</span><a href="#22-리액티브-프레임워크-rxjava" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>현재는 RxJava말고도 Akka Streams와 Reactor 프로젝트도 있으나 시작은 RxJava부터 시작됨.<li>Rxjava 라이브러니는 Reacative Extensions(ReactiveX라고도 함)의 자바 구현체이다.<li>일반적으로 ReactiveX는 관찰자 패턴, 반복자 패턴 및 함수형 프로그래밍의 조합으로 정의된다.</ul><h3 id="221-관찰자--반복자--리액티브-스트림"><span class="mr-2">2.2.1 관찰자 + 반복자 = 리액티브 스트림</span><a href="#221-관찰자--반복자--리액티브-스트림" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RxObserver</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="no">T</span> <span class="n">next</span><span class="o">);</span>
   <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">();</span>
   <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>Iterator와 매우 비슷하지만 <code class="language-plaintext highlighter-rouge">next()</code> 대신 <code class="language-plaintext highlighter-rouge">onNext()</code> 콜백에 의해 새로운 값이 통지된다.<li>그리고 <code class="language-plaintext highlighter-rouge">hasNext()</code> 대신 <code class="language-plaintext highlighter-rouge">onComplete()</code> 메소드를 통해 스트림의 끝을 알린다.<li>오류 전파를 위해 <code class="language-plaintext highlighter-rouge">onError(Exception e)</code> 콜백이 제공됨.</ul><h4 id="리액티브-observable-클래스"><span class="mr-2">리액티브 Observable 클래스</span><a href="#리액티브-observable-클래스" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>리액티브 Observable 클래스는 관찰자 패턴의 주체(Subject)와 일치<li>이벤트를 발생시킬 때 이벤트 소스 역할을 수행</ul><h4 id="subscriber-추상-클래스"><span class="mr-2">Subscriber 추상 클래스</span><a href="#subscriber-추상-클래스" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Observer 인터페이스를 구현하고 이벤트를 소비한다.(실제로 기본 구현체)<li>런타임에 Observable과 Subscriber간의 관계는 메시지 구독 상태를 확인하고 필요한 경우 이를 취소할 수도 있는 구독의 의해 제어됨.</ul><p><a href="https://user-images.githubusercontent.com/6982740/174432498-3e639cba-c407-4634-ab0d-593bb0564b9c.png" class="popup img-link "><img width="560" alt="스크린샷 2022-06-18 오후 6 51 44" data-src="https://user-images.githubusercontent.com/6982740/174432498-3e639cba-c407-4634-ab0d-593bb0564b9c.png" class="lazyload" data-proofer-ignore></a></p><h3 id="222-스트림의-생산과-소비"><span class="mr-2">2.2.2 스트림의 생산과 소비</span><a href="#222-스트림의-생산과-소비" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Observable은 구독자가 구독하는 즉시 구독자에게 이벤트를 전파하는 이벤트 생성기</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">simpleRxJavaWorkflow</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Observable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">observable</span> <span class="o">=</span> <span class="nc">Observable</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
         <span class="k">new</span> <span class="nc">Observable</span><span class="o">.</span><span class="na">OnSubscribe</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">sub</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">sub</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="s">"Hello, reactive world!"</span><span class="o">);</span>
               <span class="n">sub</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">);</span>
   <span class="o">}</span>
</pre></table></code></div></div><ul><li>자바 스트림 API와 달리 Observable은 재사용이 가능하며 모든 구독자는 구독하자마자 “Hello, reactive workld!” 이벤트를 받게 된다.<li>위 방식은 backpressure)을 지원하지 않아 현재는 사용되지 않는 방식</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">subscriber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="err">"</span><span class="nc">Done</span><span class="o">!;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
</pre></table></code></div></div><h4 id="람다-표현식-사용방식"><span class="mr-2">람다 표현식 사용방식</span><a href="#람다-표현식-사용방식" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">simpleRxJavaWorkflowWithLambdas</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Observable</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
         <span class="n">sub</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">sub</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="s">"Hello, reactive world!"</span><span class="o">);</span>
            <span class="n">sub</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
         <span class="o">}</span>
      <span class="o">).</span><span class="na">subscribe</span><span class="o">(</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">,</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">::</span><span class="n">println</span><span class="o">,</span>
         <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Done!"</span><span class="o">)</span>
      <span class="o">);</span>
   <span class="o">}</span>
</pre></table></code></div></div><ul><li>위와 같이 람다를 사용해서 간략하게 작성할 수도 있으며, 이 외에도 배열, Iterable 컬렉션, Callable, Future 등을 이용해 인스턴스를 만드는 방법도 제공한다.</ul><h4 id="observableconcat"><span class="mr-2">Observable.concat</span><a href="#observableconcat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>생성과 함께 Observable 스트림을 다른 Observable 인스턴스와 결합해 생성하여 복잡한 워크플로를 쉽게 구현할 수 있다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Observable</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">hello</span><span class="o">,</span> <span class="n">world</span><span class="o">,</span> <span class="nc">Observable</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"!"</span><span class="o">))</span>
         <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">print</span><span class="o">);</span>
</pre></table></code></div></div><h3 id="223-비동기-시퀀스-생성"><span class="mr-2">2.2.3 비동기 시퀀스 생성</span><a href="#223-비동기-시퀀스-생성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>주기적으로 비동기 이벤트 시퀀스를 생성할 수 있다.</ul><pre><code class="language-javav">public void timeBasedSequenceExample() throws InterruptedException {
      Observable.interval(1, TimeUnit.SECONDS)
         .subscribe(e -&gt; System.out.println("Received: " + e));

      Thread.sleep(5000);
   }
</code></pre><ul><li>이벤트가 생성되는 것과는 별개의 스레드를 통해 처리되기 때문에 메인스레드 실행을 지연시켜야만 동작한다.</ul><h4 id="다른-방법"><span class="mr-2">다른 방법</span><a href="#다른-방법" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">managingSubscription2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
      <span class="nc">CountDownLatch</span> <span class="n">externalSignal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

      <span class="nc">Subscription</span> <span class="n">subscription</span> <span class="o">=</span> <span class="nc">Observable</span>
              <span class="o">.</span><span class="na">interval</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="no">MILLISECONDS</span><span class="o">)</span>
              <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

      <span class="n">externalSignal</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="mi">450</span><span class="o">,</span> <span class="no">MILLISECONDS</span><span class="o">);</span>
      <span class="n">subscription</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">();</span>
   <span class="o">}</span>
</pre></table></code></div></div><ul><li>위와 같이 <code class="language-plaintext highlighter-rouge">CountDownLatch</code>가 전파될때까지 이벤트를 계속 소비하는 방식으로도 처리가 가능.</ul><h3 id="224-스트림-변환과-마블-다이어그램"><span class="mr-2">2.2.4 스트림 변환과 마블 다이어그램</span><a href="#224-스트림-변환과-마블-다이어그램" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="마블-다이어그램marble-diagram"><span class="mr-2">마블 다이어그램(marble diagram)</span><a href="#마블-다이어그램marble-diagram" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>메소드 시그니쳐만으로 이해가 어려울수 있기떄문에 발명된 스트림 변환 시각화 다이어그램</ul><h4 id="map-연산자"><span class="mr-2">Map 연산자</span><a href="#map-연산자" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="nc">Observable</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="nf">map</span><span class="o">(</span><span class="nc">Func1</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">R</span><span class="o">&gt;</span> <span class="n">func</span><span class="o">)</span>
</pre></table></code></div></div><ul><li>func 함수가 타입 <code class="language-plaintext highlighter-rouge">&lt;T&gt;</code>를 타입 <code class="language-plaintext highlighter-rouge">&lt;R&gt;</code>로 변환하고, map을 통해 <code class="language-plaintext highlighter-rouge">Observable&lt;T&gt;</code>를 <code class="language-plaintext highlighter-rouge">Observable&lt;R&gt;</code>로 변환할 수 있음을 의미</ul><p><a href="https://user-images.githubusercontent.com/6982740/174432955-0b574126-2463-489f-bd5e-281ca18ec5da.png" class="popup img-link "><img width="684" alt="스크린샷 2022-06-18 오후 7 03 57" data-src="https://user-images.githubusercontent.com/6982740/174432955-0b574126-2463-489f-bd5e-281ca18ec5da.png" class="lazyload" data-proofer-ignore></a></p><h4 id="filter-연산자"><span class="mr-2">Filter 연산자</span><a href="#filter-연산자" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://user-images.githubusercontent.com/6982740/174432968-d5053625-bfa1-4a58-b5a0-886eb3372351.png" class="popup img-link "><img width="645" alt="스크린샷 2022-06-18 오후 7 04 18" data-src="https://user-images.githubusercontent.com/6982740/174432968-d5053625-bfa1-4a58-b5a0-886eb3372351.png" class="lazyload" data-proofer-ignore></a></p><h4 id="count-연산자"><span class="mr-2">Count 연산자</span><a href="#count-연산자" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>스트림이 무한대일 때는 완료되지 않거나 아무것도 반환할 수 없음.</ul><p><a href="https://user-images.githubusercontent.com/6982740/174432988-0e31d52e-4100-420f-9122-531e51df3f9a.png" class="popup img-link "><img width="649" alt="스크린샷 2022-06-18 오후 7 04 48" data-src="https://user-images.githubusercontent.com/6982740/174432988-0e31d52e-4100-420f-9122-531e51df3f9a.png" class="lazyload" data-proofer-ignore></a></p><h4 id="zip-연산자"><span class="mr-2">Zip 연산자</span><a href="#zip-연산자" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>두 개의 병렬 스트림 값을 결합하는 연산자</ul><p><a href="https://user-images.githubusercontent.com/6982740/174433013-97958b4b-937d-443d-8572-037838b9505b.png" class="popup img-link "><img width="755" alt="스크린샷 2022-06-18 오후 7 05 31" data-src="https://user-images.githubusercontent.com/6982740/174433013-97958b4b-937d-443d-8572-037838b9505b.png" class="lazyload" data-proofer-ignore></a></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">zipOperatorExample</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Observable</span><span class="o">.</span><span class="na">zip</span><span class="o">(</span>
              <span class="nc">Observable</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"A"</span><span class="o">,</span> <span class="s">"B"</span><span class="o">,</span> <span class="s">"C"</span><span class="o">),</span>
              <span class="nc">Observable</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"1"</span><span class="o">,</span> <span class="s">"2"</span><span class="o">,</span> <span class="s">"3"</span><span class="o">),</span>
              <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
      <span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
   <span class="o">}</span>

<span class="cm">/**
*
* A1
* B2
* C3
*
**/</span>
</pre></table></code></div></div><h4 id="사용자-지정-연산자-작성"><span class="mr-2">사용자 지정 연산자 작성</span><a href="#사용자-지정-연산자-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><code class="language-plaintext highlighter-rouge">Observable.Transformer&lt;T, R&gt;</code>에서 파생된 클래스를 구현해 사용자 지정 연산자를 작성할수도 있음.<li>이는 <code class="language-plaintext highlighter-rouge">Observable.compose(transformer)</code> 연산자를 적용해 워크플로에 포함될 수 있다.</ul><h3 id="225-rxjava-사용의-전제-조건-및-이점"><span class="mr-2">2.2.5 RxJava 사용의 전제 조건 및 이점</span><a href="#225-rxjava-사용의-전제-조건-및-이점" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>서로 다른 리액티브 라이브러리는 API도 조금씩 다르고 구현 방식도 다양하다.(구독자가 관찰 가능한 스트팀에 가입한 후, 비동기적으로 이벤트를 생성해 프로세스를 시작한다는 핵심 개념은 모두 동일)<li>이런 접근방식은 매우 융통성이 있는 구조이고, 생성 및 소비되는 이벤트의 양을 제어할 수 있다. 그로 인해 데아터 작성시에만 필요하고 그 이후에는 CPU 리소스 사용량을 줄일 수 있음.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">// 페이지와 관계 없이 전체 결과를 반환 받는 구조라서 문제</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SearchEngine</span> <span class="o">{</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="nc">String</span> <span class="n">query</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 다음 데이터 반환을 기라딜때 스레드가 블로킹되는 문제가 있음.</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IterableSearchEngine</span> <span class="o">{</span>
   <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="nc">String</span> <span class="n">query</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// CompletableFuture 결과가 List라 한번에 전체를 반환하거나 아무것도 반환하지 않는 방식으로만 동작하는 문제</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">FutureSearchEngine</span> <span class="o">{</span>
   <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="nc">String</span> <span class="n">query</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RxSearchEngine</span> <span class="o">{</span>
   <span class="nc">Observable</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="nc">String</span> <span class="n">query</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>Rx의 접근방식을 사용하면 응답성을 크게 높힐 수 있음.<li>최초 데이터 수신 시간(Time To First Byte) 또는 주요 랜더링 경로(Critical Rendering Path) 메트릭으로 성능을 평가하는데 여기서 기존 방식보다 훨씬 나은 결과를 보여준다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">deferSynchronousRequest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"query"</span><span class="o">;</span>
      <span class="nc">Observable</span><span class="o">.</span><span class="na">fromCallable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">doSlowSyncRequest</span><span class="o">(</span><span class="n">query</span><span class="o">))</span>
         <span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="nc">Schedulers</span><span class="o">.</span><span class="na">io</span><span class="o">())</span>
         <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">processResult</span><span class="o">);</span>

      <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
   <span class="o">}</span>
</pre></table></code></div></div><ul><li>위 워크플로우는 한 스레드에서 시작해 소수의 다른 스레드로 이동하고, 완전히 다른 새 스레드에서 처리가 완료될 수 있음.<li>이 과정에서 객체 변형은 리스크가 있을수 있으며, 일반적으로 불변 객체를 사용한다.<li>불변 객체는 함수형 프로그래밍 핵심 원리중 하나<ul><li>Java8 Stream에서도 final Variable만 참조할수 있는 이유가 이러한 이유라고 보면 된다.<li>이 간단한 규칙으로 병렬 처리에서 발생할 수 있는 대부분의 문제를 예방할수 있다.</ul></ul><h3 id="226-rxjava를-이용해-애플리케이션-다시-만들기"><span class="mr-2">2.2.6 RxJava를 이용해 애플리케이션 다시 만들기</span><a href="#226-rxjava를-이용해-애플리케이션-다시-만들기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TemperatureSensor</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">TemperatureSensor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Random</span> <span class="n">rnd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>

  <span class="c1">// private filed로 하나만 정의해서 재사용할수 있음</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Observable</span><span class="o">&lt;</span><span class="nc">Temperature</span><span class="o">&gt;</span> <span class="n">dataStream</span> <span class="o">=</span>
      <span class="nc">Observable</span>
         <span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span>             <span class="c1">// 사실상 무한 스트림</span>
         <span class="o">.</span><span class="na">concatMap</span><span class="o">(</span><span class="n">ignore</span> <span class="o">-&gt;</span> <span class="nc">Observable</span>
            <span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
            <span class="o">.</span><span class="na">delay</span><span class="o">(</span><span class="n">rnd</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5000</span><span class="o">),</span> <span class="no">MILLISECONDS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">ignore2</span> <span class="o">-&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">probe</span><span class="o">()))</span>                   <span class="c1">// ignore2는 단일 원소 스트림을 생성하는데 필요해서 정의된 것이기에 무시해도 괜찮.</span>
         <span class="o">.</span><span class="na">publish</span><span class="o">()</span>      <span class="c1">// 각 구독자(SSE 클라이언트)는 각 센서 판독 결과를 공유하지 않는다.</span>
         <span class="o">.</span><span class="na">refCount</span><span class="o">();</span>  <span class="c1">// 하나 이상의 구독자가 있을때만 입력 공유 스트림에 대한 구독을 생성</span>

   <span class="kd">public</span> <span class="nc">Observable</span><span class="o">&lt;</span><span class="nc">Temperature</span><span class="o">&gt;</span> <span class="nf">temperatureStream</span><span class="o">()</span> <span class="o">{</span>
     <span class="k">return</span> <span class="n">dataStream</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="nc">Temperature</span> <span class="nf">probe</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">double</span> <span class="n">actualTemp</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">rnd</span><span class="o">.</span><span class="na">nextGaussian</span><span class="o">()</span> <span class="o">*</span> <span class="mi">10</span><span class="o">;</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Asking sensor, sensor value: {}"</span><span class="o">,</span> <span class="n">actualTemp</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">Temperature</span><span class="o">(</span><span class="n">actualTemp</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="custom-sse-emitter"><span class="mr-2">Custom Sse Emitter</span><a href="#custom-sse-emitter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">RxSseEmitter</span> <span class="kd">extends</span> <span class="nc">SseEmitter</span> <span class="o">{</span>
      <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">SSE_SESSION_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000L</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">AtomicInteger</span> <span class="n">sessionIdSequence</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

      <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">sessionId</span> <span class="o">=</span> <span class="n">sessionIdSequence</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">Temperature</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="o">;</span>

      <span class="nc">RxSseEmitter</span><span class="o">()</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">(</span><span class="no">SSE_SESSION_TIMEOUT</span><span class="o">);</span>

         <span class="k">this</span><span class="o">.</span><span class="na">subscriber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">Temperature</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="nc">Temperature</span> <span class="n">temperature</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">try</span> <span class="o">{</span>
                  <span class="nc">RxSseEmitter</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">temperature</span><span class="o">);</span> <span class="c1">// onNext() 신호를 수신하면 응답으로부터 SSE 클라이언트에게 신호를 보낸다.</span>
                  <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[{}] &lt;&lt; {} "</span><span class="o">,</span> <span class="n">sessionId</span><span class="o">,</span> <span class="n">temperature</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
               <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"[{}] Can not send event to SSE, closing subscription, message: {}"</span><span class="o">,</span>
                     <span class="n">sessionId</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                  <span class="n">unsubscribe</span><span class="o">();</span>
               <span class="o">}</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"[{}] Received sensor error: {}"</span><span class="o">,</span> <span class="n">sessionId</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
               <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"[{}] Stream completed"</span><span class="o">,</span> <span class="n">sessionId</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">};</span>

         <span class="n">onCompletion</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[{}] SSE completed"</span><span class="o">,</span> <span class="n">sessionId</span><span class="o">);</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">();</span>
         <span class="o">});</span>
         <span class="n">onTimeout</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[{}] SSE timeout"</span><span class="o">,</span> <span class="n">sessionId</span><span class="o">);</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">();</span>
         <span class="o">});</span>
      <span class="o">}</span>

      <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">Temperature</span><span class="o">&gt;</span> <span class="nf">getSubscriber</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">subscriber</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kt">int</span> <span class="nf">getSessionId</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">sessionId</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
</pre></table></code></div></div><h4 id="sse-엔드포인트-노출-1"><span class="mr-2">SSE 엔드포인트 노출</span><a href="#sse-엔드포인트-노출-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/temperature-stream"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
   <span class="kd">public</span> <span class="nc">SseEmitter</span> <span class="nf">events</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">RxSeeEmitter</span> <span class="n">emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RxSeeEmitter</span><span class="o">();</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[{}] Rx SSE stream opened for client: {}"</span><span class="o">,</span>
         <span class="n">emitter</span><span class="o">.</span><span class="na">getSessionId</span><span class="o">(),</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddr</span><span class="o">());</span>

      <span class="n">temperatureSensor</span><span class="o">.</span><span class="na">temperatureStream</span><span class="o">()</span>
         <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">emitter</span><span class="o">.</span><span class="na">getSubscriber</span><span class="o">());</span>

      <span class="k">return</span> <span class="n">emitter</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>SSE 세션을 온도 측정 스트림을 구독한 새로운 RxSseEmitter에만 바인딩한다.<li>이 구현은 스프링의 EventBus를 사용하지 않으므로 이식성이 더 높고 스프링 컨텍스트가 없이도 테스트가 가능하다.<li>또한 <code class="language-plaintext highlighter-rouge">@EventListener</code>, <code class="language-plaintext highlighter-rouge">@EnableAsync</code> 같은 의존성이 없어서 애플리케이션 구성도 더 간단하다.<li>RxJava Schedular를 구성한 세밀한 스레드 관리를 할수도 있지만, 이러한 구성이 스프링 프레임워크에 의존하지 않는다.<li>이는 리액티브 프로그래밍이 가지는 능동적 구독이라는 개념의 자연스러운 결과이다.</ul><h2 id="23-리액티브-라이브러리의-간략한-역사"><span class="mr-2">2.3 리액티브 라이브러리의 간략한 역사</span><a href="#23-리액티브-라이브러리의-간략한-역사" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>MS에서 Rx의 개념이 시작되었고 Rx.NET을 시작으로, 언제부턴가 외부로 퍼져나감.<li>깃헙의 저스틴 스파서머스와 폴 베츠는 2012년 objectiveC용 Rx를 구현했고, 넷플릭스에서 Rx Java로 이식하여 오픈소스로 공개했다.</ul><h2 id="24-리액티브의-전망"><span class="mr-2">2.4 리액티브의 전망</span><a href="#24-리액티브의-전망" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Ratpack에서 RxJava 채택<li>Android 유명한 http client인 Retrofit에서도 RxJava 지원<li>Vert.x에서도 정식 리액티브 스트림 제공(ReadStream, WriteStream)</ul><h3 id="주의사항"><span class="mr-2">주의사항</span><a href="#주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>하나의 자바 응용 프로그램에 다른 종류의 리액티브 라이브러리 또는 프레임워크를 동시에 사용하면 문제가 발생할 수 있다.<li>리액티브 라이브러리들의 동작은 일반적으로 비슷하지만 세부 구현은 조금씩 다를수 있어서 동시 사용시 발견 및 수정하기 어려운 숨겨진 에러를 유발할 수 있다.<li>이런 전체 리액티브 환경을 아우르며 호환성을 보장하기 위한 표준 API가 바로 <code class="language-plaintext highlighter-rouge">리액티브 스트림</code>이다. 다음에 이를 자세히 알아보도록 하자!</ul><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://coding-start.tistory.com/314">CopyOnWriteArraySet</a><li><a href="https://jsravn.com/2019/05/01/jvm-thread-actual-memory-usage/">JVM Thread Memory usage 관련</a><li><a href="https://surviveasdev.tistory.com/entry/%EC%9B%B9%EC%86%8C%EC%BC%93-%EA%B3%BC-SSEServer-Sent-Event-%EC%B0%A8%EC%9D%B4%EC%A0%90-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B3%A0-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0">웹소켓과 SSE 비교</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/spring/" class="post-tag no-text-decoration" >Spring</a> <a href="/tags/hands-on-reactive-programming-in-spring-5/" class="post-tag no-text-decoration" >Hands-On Reactive Programming in Spring 5</a> <a href="/tags/reactive/" class="post-tag no-text-decoration" >Reactive</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Hands-On%20Reactive%20Programming%20in%20Spring%205]%202.%20%EC%8A%A4%ED%94%84%EB%A7%81%EC%9D%84%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C%20%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%20%EA%B8%B0%EB%B3%B8%20%EA%B0%9C%EB%85%90%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fspring5-reactive-2%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Hands-On%20Reactive%20Programming%20in%20Spring%205]%202.%20%EC%8A%A4%ED%94%84%EB%A7%81%EC%9D%84%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C%20%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%20%EA%B8%B0%EB%B3%B8%20%EA%B0%9C%EB%85%90%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fspring5-reactive-2%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fspring5-reactive-2%2F&text=[Hands-On%20Reactive%20Programming%20in%20Spring%205]%202.%20%EC%8A%A4%ED%94%84%EB%A7%81%EC%9D%84%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C%20%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%20%EA%B8%B0%EB%B3%B8%20%EA%B0%9C%EB%85%90%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring5-reactive-programing-1/"><div class="card-body"> <em class="small" data-ts="1654914900" data-df="ll" > Jun 11, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Hands-On Reactive Programming in Spring 5] 1. 왜 리액티브 스프링인가?</h3><div class="text-muted small"><p> 1. 왜 리액티브 스프링인가? 1.1 왜 리액티브인가? 서버진영에서 reactive(반응형)이라는 말이 2019년쯤부터 굉장히 빈번하게 들려왔다. 시스템의 가용량 예시 tomcat worker thread 500으로 설정 API 응답시간이 250ms 이 기준으로 계산해보면 시스템의 최대 TPS 2,000임을 알수 있다. 특수...</p></div></div></a></div><div class="card"> <a href="/posts/spring5-reactive-9/"><div class="card-body"> <em class="small" data-ts="1658809680" data-df="ll" > Jul 26, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Hands-On Reactive Programming in Spring 5] 9. 리액티브 애플리케이션 테스트하기</h3><div class="text-muted small"><p> 9. 리액티브 애플리케이션 테스트하기 테스트 도구에 대한 요구사항 StepVerifier를 사용해 Publisher를 테스트할 때의 핵심 고급 StepVerifier 사용 시나리오 웹플럭스 테스트를 위한 툴 세트 9.1 리액티브 스트림을 테스트하기 어려운 이유 대규모 시스템에 많은 수의 클래스가 포함된 수많은 컴포넌트가 ...</p></div></div></a></div><div class="card"> <a href="/posts/devlog-spring-boot-application/"><div class="card-body"> <em class="small" data-ts="1588264440" data-df="ll" > May 1, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot + JPA + H2 Application 간단하게 띄우기</h3><div class="text-muted small"><p> Spring Boot + JPA + H2 Application 간단하게 띄우기 1. 프로젝트 만들기 2. 애플리케이션 기본 설정 3. Web MVC Configuration 4. JSP Configration 5. JPA Configration 1. 프로젝트 만들기 1.1 spring initializr을 통해 프로젝트 뼈대 만...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring5-reactive-programing-1/" class="btn btn-outline-primary" prompt="Older"><p>[Hands-On Reactive Programming in Spring 5] 1. 왜 리액티브 스프링인가?</p></a> <a href="/posts/spring5-reactive-9/" class="btn btn-outline-primary" prompt="Newer"><p>[Hands-On Reactive Programming in Spring 5] 9. 리액티브 애플리케이션 테스트하기</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/spring5-reactive-2/'; this.page.identifier = '/posts/spring5-reactive-2/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>

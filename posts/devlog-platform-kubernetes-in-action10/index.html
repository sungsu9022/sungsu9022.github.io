<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="[kubernetes-in-action] 10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기 볼륨이나 퍼시스턴트볼륨클레임에 바인딩된 퍼시스턴트볼륨을 통해서 데이터베이스를 일반 파드에 실행했었는데, 이 파드들을 스케일아웃하려면 어떻게 할수 있을지 살펴본다." /><meta property="og:description" content="10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기 볼륨이나 퍼시스턴트볼륨클레임에 바인딩된 퍼시스턴트볼륨을 통해서 데이터베이스를 일반 파드에 실행했었는데, 이 파드들을 스케일아웃하려면 어떻게 할수 있을지 살펴본다." /><link rel="canonical" href="https://sungsu9022.github.io/posts/devlog-platform-kubernetes-in-action10/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/devlog-platform-kubernetes-in-action10/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-02T17:34:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[kubernetes-in-action] 10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2020-09-02T17:34:00+09:00","datePublished":"2020-09-02T17:34:00+09:00","description":"10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기 볼륨이나 퍼시스턴트볼륨클레임에 바인딩된 퍼시스턴트볼륨을 통해서 데이터베이스를 일반 파드에 실행했었는데, 이 파드들을 스케일아웃하려면 어떻게 할수 있을지 살펴본다.","headline":"[kubernetes-in-action] 10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/devlog-platform-kubernetes-in-action10/"},"url":"https://sungsu9022.github.io/posts/devlog-platform-kubernetes-in-action10/"}</script><title>[kubernetes-in-action] 10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기 | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[kubernetes-in-action] 10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>[kubernetes-in-action] 10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1599035640" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 2, 2020 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4369 words"> <em>24 min</em> read</span></div></div></div><div class="post-content"><h1 id="10-스테이트풀셋-복제된-스테이트풀-애플리케이션-배포하기">10. 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기</h1><blockquote><p>볼륨이나 퍼시스턴트볼륨클레임에 바인딩된 퍼시스턴트볼륨을 통해서 데이터베이스를 일반 파드에 실행했었는데, 이 파드들을 스케일아웃하려면 어떻게 할수 있을지 살펴본다.</p></blockquote><h2 id="101-스테이트풀-파드-복제하기"><span class="mr-2">10.1 스테이트풀 파드 복제하기</span><a href="#101-스테이트풀-파드-복제하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>스테이트풀 파드를 복제할떄 레플리카셋을 이용한다면 어떨까?<li>레플리카셋은 하나의 파드 템플릿에서 여러 개의 파드 레플리카를 생성한다.<li>여러 개개의 파드 레플리카를 복제하는 데 사용하는 파드 템플릿에는 클레임에 관한 참조가 있으므로 각 레플리카가 별도의 퍼시스턴트볼륨클레임을 사용하도록 만들 수가 없음.</ul><p><a href="https://user-images.githubusercontent.com/6982740/91860275-70d5af80-eca6-11ea-9aaf-40f9737ac3be.png" class="popup img-link "><img width="414" alt="스크린샷 2020-09-01 오후 10 56 49" data-src="https://user-images.githubusercontent.com/6982740/91860275-70d5af80-eca6-11ea-9aaf-40f9737ac3be.png" class="lazyload" data-proofer-ignore></a></p><h3 id="1011-개별-스토리지를-갖는-레플리카-여러-개-실행하기"><span class="mr-2">10.1.1 개별 스토리지를 갖는 레플리카 여러 개 실행하기</span><a href="#1011-개별-스토리지를-갖는-레플리카-여러-개-실행하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>이에 대한 방법은 여러가지가 있겠지만 현실성이 대부분 부족하다</ul><h4 id="수동으로-파드-생성하기"><span class="mr-2">수동으로 파드 생성하기</span><a href="#수동으로-파드-생성하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>레플리카셋이 파드를 감시하지 못하므로 가능한 옵션이 아니다.</ul><h4 id="파드-인스턴스별로-하나의-레플리카셋-사용하기"><span class="mr-2">파드 인스턴스별로 하나의 레플리카셋 사용하기</span><a href="#파드-인스턴스별로-하나의-레플리카셋-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>이 경우 의도된 레플리카 수를 변경할 수 없고, 추가 레플리카셋을 생성해야 한다.(이러면 레플리카셋을 쓰는 의미가 있는가..? 없다.)</ul><p><a href="https://user-images.githubusercontent.com/6982740/91860514-bb572c00-eca6-11ea-9553-93e618d80bdb.png" class="popup img-link "><img width="397" alt="스크린샷 2020-09-01 오후 10 59 00" data-src="https://user-images.githubusercontent.com/6982740/91860514-bb572c00-eca6-11ea-9553-93e618d80bdb.png" class="lazyload" data-proofer-ignore></a></p><h4 id="동일-볼륨을-여러-개-디렉터리로-사용하기"><span class="mr-2">동일 볼륨을 여러 개 디렉터리로 사용하기</span><a href="#동일-볼륨을-여러-개-디렉터리로-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>인스턴스간 조정이 필요하고 올바르게 수행하기 쉽지 않다. 심지어 공유 스토리지 볼륨에서 병목이 발생할수도 있다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/91860644-e17ccc00-eca6-11ea-9950-104c8b541c71.png" class="popup img-link "><img width="442" alt="스크린샷 2020-09-01 오후 11 00 04" data-src="https://user-images.githubusercontent.com/6982740/91860644-e17ccc00-eca6-11ea-9950-104c8b541c71.png" class="lazyload" data-proofer-ignore></a></p><h3 id="1012-각-파드에-안정적인-아이덴티티-제공하기"><span class="mr-2">10.1.2 각 파드에 안정적인 아이덴티티 제공하기</span><a href="#1012-각-파드에-안정적인-아이덴티티-제공하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>특정 애플리케이션이 안정적인 네트워크 아이덴티티를 요구하는 이유는 무엇일까? 분산 스테이트풀 애플리케이션에서는 이러한 요구사항이 상당히 일반적이다.<ul><li>이를테면 ACL을 구성하기도 하고..</ul><li>쿠버네티스에서는 매번 파드가 재스케줄링될 수 있고, 새로운 파드는 새로운 호스트 이름과 IP주소를 할당받으므로 구성 멤버가 재스케줄링될 때마다 모든 애플리케이션 클러스터가 재구성돼야 한다.</ul><h4 id="각-파드-인스턴스별-전용-서비스-사용하기"><span class="mr-2">각 파드 인스턴스별 전용 서비스 사용하기</span><a href="#각-파드-인스턴스별-전용-서비스-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>개별 파드는 자신이 어떤 서비스를 통해 노출되는지 알수 없으므로 안정적인 IP를 알수 있는것도 아니고, 모든 문제를 해결할 수 조차 없다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/91860907-2e60a280-eca7-11ea-8cf4-21ede74df5f2.png" class="popup img-link "><img width="569" alt="스크린샷 2020-09-01 오후 11 02 13" data-src="https://user-images.githubusercontent.com/6982740/91860907-2e60a280-eca7-11ea-8cf4-21ede74df5f2.png" class="lazyload" data-proofer-ignore></a></p><h2 id="102-스테이트풀셋"><span class="mr-2">10.2 스테이트풀셋</span><a href="#102-스테이트풀셋" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>10.1에서 나열한 문제들을 해결할 수 있도록 쿠버네티스에서는 스테이트풀셋(StatefulSet)을 제공한다.<li>스테이트풀셋은 애플리케이션의 인스턴스가 각각 안정적인 이름과 상태를 가지며 개별적으로 취급돼야 하는 애플리케이션에 알맞게 만들어졌다.</ul><h3 id="1021-스테이트풀셋과-레플리카셋-비교"><span class="mr-2">10.2.1 스테이트풀셋과 레플리카셋 비교</span><a href="#1021-스테이트풀셋과-레플리카셋-비교" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="애완동물-vs-가축"><span class="mr-2">애완동물 vs 가축</span><a href="#애완동물-vs-가축" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><h5 id="스테이트풀셋---애완동물"><span class="mr-2">스테이트풀셋 - 애완동물</span><a href="#스테이트풀셋---애완동물" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>각 인스턴스에 이름을 부여하고 개별적으로 관리한다<li>스테이트풀 파드가 종료되면 새로운 파드 인스턴스는 교체되는 파드와 동일한 이름, 네트워크 아이덴티티, 상태 그대로 다른 노드에서 되살아나야 한다.</ul><h5 id="레플리카셋---가축"><span class="mr-2">레플리카셋 - 가축</span><a href="#레플리카셋---가축" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>스테이트리스 애플리케이션의 인스턴스는 이름을 정확히 알고 있을 필요가 없고 몇마리가 있는지만 중요하다.<li>언제든 완전히 새로운 파드로 교체되어도 된다.</ul><h3 id="1022-안정적인-네트워크-아이덴티티-제공하기"><span class="mr-2">10.2.2 안정적인 네트워크 아이덴티티 제공하기</span><a href="#1022-안정적인-네트워크-아이덴티티-제공하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>스테이트풀셋으로 생성된 파드는 서수 인덱스(0부터 시작)가 할당되고 파드의 이름과 호스트 이름, 안정적인 스토리지를 붙이는 데 사용된다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/91861514-dfffd380-eca7-11ea-9b1d-0a83b4ec6162.png" class="popup img-link "><img width="490" alt="스크린샷 2020-09-01 오후 11 07 09" data-src="https://user-images.githubusercontent.com/6982740/91861514-dfffd380-eca7-11ea-9b1d-0a83b4ec6162.png" class="lazyload" data-proofer-ignore></a></p><h4 id="거버닝-서비스"><span class="mr-2">거버닝 서비스</span><a href="#거버닝-서비스" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>스테이트풀 파드는 때떄로 호스트 이름을 통해 다뤄져야 할 필요가 있다.(스테이트리스는 이런 니즈가 없음)<li>스테이트풀 파드는 각각 서로 다르므로(다른 상태를 가지거나) 요구사항에 따라 특정 스테이트풀 파드에서 동작하기를 원할수도 있다.<li>위와 같은 이유로 스테이트풀셋은 거버닝 헤드리스 서비스(governing headless service)를 생성해서 각 파드에게 실제 네트워크 아이덴티티를 제공해야 한다.(헤드리스 서비스를 통해 고정된 하나의 IP가 아닌 서비스에 맵핑된 모든 파드의 IP 목록을 얻는다.)</ul><h4 id="스테이트풀셋-교체하기"><span class="mr-2">스테이트풀셋 교체하기</span><a href="#스테이트풀셋-교체하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>스테이트풀셋은 레플리카셋이 하는 것과 비슷하게 새로운 인스턴스로 교체되도록 한다. 하지만 교체되더라도 이전에 사라진 파드와 동일한 호스트 이름을 갖는다. 그렇기 떄문에 파드가 다른 노드로 재스케줄링되더라도 같은 클러스터 내에서 이전과 동일한 호스트 이름으로 접근이 가능하다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/91862353-cd39ce80-eca8-11ea-8f58-1b5c598939a7.png" class="popup img-link "><img width="596" alt="스크린샷 2020-09-01 오후 11 13 48" data-src="https://user-images.githubusercontent.com/6982740/91862353-cd39ce80-eca8-11ea-8f58-1b5c598939a7.png" class="lazyload" data-proofer-ignore></a></p><h4 id="스테이트풀셋-스케일링"><span class="mr-2">스테이트풀셋 스케일링</span><a href="#스테이트풀셋-스케일링" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>스테이트풀셋의 스케일 다운의 좋은 점은 항상 어떤 파드가 제거될지 알수 있다는 점이다.<li>스테이트풀셋의 스케일 다운은 항상 가장 높은 서수 인덱스의 파드를 먼저 제거한다.<li>스테이트풀셋은 인스턴스 하나라도 비정상인 경우 스케일 다운 작업을 허용하지 않는다. 그 이유는 여러개 노드가 동시에 다운되는 경우 데이터를 잃을수도 있기 떄문이다.)</ul><p><a href="https://user-images.githubusercontent.com/6982740/91862484-fa867c80-eca8-11ea-9b1c-28cd9f4053e0.png" class="popup img-link "><img width="570" alt="스크린샷 2020-09-01 오후 11 15 05" data-src="https://user-images.githubusercontent.com/6982740/91862484-fa867c80-eca8-11ea-9b1c-28cd9f4053e0.png" class="lazyload" data-proofer-ignore></a></p><h3 id="1023-각-스테이트풀-인스턴스에-안정적인-전용-스토리지-제공하기"><span class="mr-2">10.2.3 각 스테이트풀 인스턴스에 안정적인 전용 스토리지 제공하기</span><a href="#1023-각-스테이트풀-인스턴스에-안정적인-전용-스토리지-제공하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>스테이트풀 파드의 스토리지는 영구적이어야 하고 파드와는 분리되어야 한다.<li>스테이트풀셋의 각 파드는 별도의 퍼시스턴트볼륨을 갖는 다른 퍼시스턴트볼륨클레임을 참조해야 한다.(이를 스테이트풀셋에서 제공함.)</ul><h4 id="볼륨-클레임-템플릿과-파드-템플릿을-같이-구성"><span class="mr-2">볼륨 클레임 템플릿과 파드 템플릿을 같이 구성</span><a href="#볼륨-클레임-템플릿과-파드-템플릿을-같이-구성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>스테이트풀셋이 파드를 생성하는 것과 같은 방식으로 퍼시스턴트볼륨클레임 또한 생성할 수 있다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/91863471-1e968d80-ecaa-11ea-90d1-3bcb3da0320b.png" class="popup img-link "><img width="512" alt="스크린샷 2020-09-01 오후 11 23 14" data-src="https://user-images.githubusercontent.com/6982740/91863471-1e968d80-ecaa-11ea-90d1-3bcb3da0320b.png" class="lazyload" data-proofer-ignore></a></p><h4 id="퍼시스턴트볼륨클레임의-생성과-삭제의-이해"><span class="mr-2">퍼시스턴트볼륨클레임의 생성과 삭제의 이해</span><a href="#퍼시스턴트볼륨클레임의-생성과-삭제의-이해" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>생성할떄는 파드와 퍼시스턴트볼륨클레임 등 2개 이상의 오브젝트가 생성이 되는데..<li>스케일 다운을 할 떄는 파드만 삭제하고 클레임은 남겨둔다.(클레임이 삭제된 후 바인딩됐던 퍼시스턴트볼륨은 재활용되거나 삭제돼 콘텐츠가 손실될 수 있기 때문)<li>그래서 기반 퍼시스턴트볼륨을 해제하려면 퍼시스턴트볼륨클레임을 수동을 삭제해주어야 한다.</ul><h4 id="동일-파드의-새-인스턴스에-퍼시스턴트볼륨클레임-다시-붙이기"><span class="mr-2">동일 파드의 새 인스턴스에 퍼시스턴트볼륨클레임 다시 붙이기</span><a href="#동일-파드의-새-인스턴스에-퍼시스턴트볼륨클레임-다시-붙이기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>스테이트풀셋은 스케일 다운되었을 때 기존에 있던 퍼시스턴트볼륨클레임을 유지했다가 스케일 업될떄 다시 해당 볼륨클레임을 연결한다.</ul><p><a href="https://user-images.githubusercontent.com/6982740/91863856-8351e800-ecaa-11ea-9d0e-d38d237657d4.png" class="popup img-link "><img width="577" alt="스크린샷 2020-09-01 오후 11 26 04" data-src="https://user-images.githubusercontent.com/6982740/91863856-8351e800-ecaa-11ea-9d0e-d38d237657d4.png" class="lazyload" data-proofer-ignore></a></p><h3 id="1024-스테이트풀셋-보장guarantee"><span class="mr-2">10.2.4 스테이트풀셋 보장(guarantee)</span><a href="#1024-스테이트풀셋-보장guarantee" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="안정된-아이덴티티와-스토리지의-의미"><span class="mr-2">안정된 아이덴티티와 스토리지의 의미</span><a href="#안정된-아이덴티티와-스토리지의-의미" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>쿠버네티스상에서 보장해주지 않는다고 가정할때, 동일한 아이덴티티를 가지는 교체 파드를 생성되면 애플리케이션의 두 개 인스턴스가 동일한 아이덴티티로 시스템에서 실행하게 되면 큰 문제가 될수도 있다.</ul><h4 id="스테이트풀셋-최대-하나의-의미"><span class="mr-2">스테이트풀셋 최대 하나의 의미</span><a href="#스테이트풀셋-최대-하나의-의미" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>쿠버네티스는 두 개의 스테이트풀 파드 인스턴스가 절대 동일한 아이덴티티로 실행되지 않고, 동일한 퍼시스턴트볼륨클레임에 바인딩되지 않는것을 보장한다.<li>스테이트풀셋은 교체 파드를 생성하기 전에 파드가 더 이상 실행중이지 않는다는 점을 절대적으로 확신해야 처리가 이루어진다.</ul><h2 id="103-스테이트풀셋-사용하기"><span class="mr-2">10.3 스테이트풀셋 사용하기</span><a href="#103-스테이트풀셋-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="1031-스테이트풀셋을-위해-준비사항"><span class="mr-2">10.3.1 스테이트풀셋을 위해 준비사항</span><a href="#1031-스테이트풀셋을-위해-준비사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>데이터 파일을 저장하기 위한 퍼시스턴트볼륨(동적 프로비저닝을 해도됨)<li>스테이트풀셋에 필요한 거버닝 헤드리스 서비스<li>스테이트풀셋</ul><h3 id="1032-스테이트풀셋-배포"><span class="mr-2">10.3.2 스테이트풀셋 배포</span><a href="#1032-스테이트풀셋-배포" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="퍼시스턴트볼륨-생성"><span class="mr-2">퍼시스턴트볼륨 생성</span><a href="#퍼시스턴트볼륨-생성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="na">kind</span><span class="pi">:</span> <span class="s">List</span>                        <span class="c1"># 여러개의 리소스를 정의할때 List를  사용할 수 있다.</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">items</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">pv-a</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">capacity</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">1Mi</span>
    <span class="na">accessModes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
    <span class="na">persistentVolumeReclaimPolicy</span><span class="pi">:</span> <span class="s">Recycle</span>
    <span class="na">hostPath</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/tmp/pv-a</span>
<span class="pi">-</span> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">pv-b</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">capacity</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">1Mi</span>
    <span class="na">accessModes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
    <span class="na">persistentVolumeReclaimPolicy</span><span class="pi">:</span> <span class="s">Recycle</span>
    <span class="na">hostPath</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/tmp/pv-b</span>
<span class="pi">-</span> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">pv-c</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">capacity</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">1Mi</span>
    <span class="na">accessModes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
    <span class="na">persistentVolumeReclaimPolicy</span><span class="pi">:</span> <span class="s">Recycle</span>
    <span class="na">hostPath</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/tmp/pv-c</span>
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># 볼륨 생성</span>
kubectl create <span class="nt">-f</span> persistent-volumes-hostpath.yaml
</pre></table></code></div></div><h4 id="거버닝-서비스-생성하기"><span class="mr-2">거버닝 서비스 생성하기</span><a href="#거버닝-서비스-생성하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubia</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>          <span class="c1"># 헤드리스 서비스를 위함</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">kubia</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#  거버닝 헤드리스 서비스 생성</span>
kubectl create <span class="nt">-f</span> kubia-service-headless.yaml
</pre></table></code></div></div><h4 id="스테이트풀셋-생성하기"><span class="mr-2">스테이트풀셋 생성하기</span><a href="#스테이트풀셋-생성하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>첫번째 파드가 생성되고 준비가 완료되어야만 두 번째 파드가 생성된다.<li>두 개 이상의 멤버가 동시에 생성되면 레이스 컨디션에 빠질 가능성이 있기 떄문에 스테이트풀셋은 순차적으로 하나씩만 처리된다.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubia</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">serviceName</span><span class="pi">:</span> <span class="s">kubia</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">kubia</span> <span class="c1"># has to match .spec.template.metadata.labels</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">kubia</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">kubia</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">luksa/kubia-pet</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
          <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>                 <span class="c1"># 볼륨 마운트</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/data</span>
  <span class="na">volumeClaimTemplates</span><span class="pi">:</span>          <span class="c1"># 볼륨클레임 템플릿</span>
  <span class="pi">-</span> <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">storage</span><span class="pi">:</span> <span class="s">1Mi</span>
      <span class="na">accessModes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c"># 스테이트풀셋 생성</span>
kubectl create <span class="nt">-f</span> kubia-statefulset.yaml

<span class="c"># statefulset 조회</span>
kubectl get statefulset

<span class="c"># pod 조회</span>
kubectl get po | <span class="nb">grep </span>kubia-

<span class="c"># 생성된 statefulset pod 조회</span>
kubectl get po kubia-0 <span class="nt">-o</span> yaml
</pre></table></code></div></div><h3 id="1033-생성된-파드-확인"><span class="mr-2">10.3.3 생성된 파드 확인</span><a href="#1033-생성된-파드-확인" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>파드에 피기백(exec를 통해 파드 내부로 진입해서 처리하는 방식)하거나 API 서버를 통해 데이터를 확인해본다.</ul><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># api server local 프록시</span>
kubectl proxy

<span class="c"># 파드 엔드포인트 조회</span>
curl localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/
curl localhost:8001/api/v1/namespaces/default/pods/kubia-1/proxy/
</pre></table></code></div></div><p><a href="https://user-images.githubusercontent.com/6982740/91866247-42a79e00-ecad-11ea-9406-8e8a5199047f.png" class="popup img-link "><img width="600" alt="스크린샷 2020-09-01 오후 11 45 43" data-src="https://user-images.githubusercontent.com/6982740/91866247-42a79e00-ecad-11ea-9406-8e8a5199047f.png" class="lazyload" data-proofer-ignore></a></p><h4 id="스테이트풀셋-파드를-삭제해-재스케줄링된-파드가-동일한-스토리지에-연결되는지-확인"><span class="mr-2">스테이트풀셋 파드를 삭제해 재스케줄링된 파드가 동일한 스토리지에 연결되는지 확인</span><a href="#스테이트풀셋-파드를-삭제해-재스케줄링된-파드가-동일한-스토리지에-연결되는지-확인" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>새 파드는 클러스터의 어느 노드에서나 스케줄링될 수 있으며 이전 파드가 스케줄링 됐던 동일한 노드일 필요가 없다.<li>이전 파드의 모든 아이덴티티(이름, 호스트 이름, 스토리지)는 새 노드로 효과적으로 이동된다.</ul><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c"># 스테이트풀셋 파드 데이터 수정</span>
curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"Hey three! This greeting was submitted to kubia-0."</span> localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/

<span class="c"># 변경한 파드 삭제(삭제하면 직후 스테이트풀셋이 새로운 파드를 생성한다.)</span>
kubectl delete po kubia-0

<span class="c"># 재확인(수정한 데이터가 그대로 남아있음.)</span>
curl localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/
</pre></table></code></div></div><h4 id="스테이트풀셋-스케일링-1"><span class="mr-2">스테이트풀셋 스케일링</span><a href="#스테이트풀셋-스케일링-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>가장 중요한 점은 스케일 업/다운이 점진적으로 수행되며 스테이트풀셋이 초기에 생성됐을 때 개별 파드가 생성되는 방식과 유사하다는 점이다.<li>또한 스케일 다운시 가장 높은 서수의 파드가 먼저 삭제되고, 파드가 완전히 종료된 이후부터 다음 스케일다운이 수행된다.</ul><h4 id="스테이트풀-파드를-헤드리스가-아닌-일반적인-서비스로-노출하기"><span class="mr-2">스테이트풀 파드를 헤드리스가 아닌 일반적인 서비스로 노출하기</span><a href="#스테이트풀-파드를-헤드리스가-아닌-일반적인-서비스로-노출하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubia-public</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">kubia</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
</pre></table></code></div></div><h4 id="api-서버를-통해-클러스터-내부-서비스에-연결"><span class="mr-2">API 서버를 통해 클러스터 내부 서비스에 연결</span><a href="#api-서버를-통해-클러스터-내부-서비스에-연결" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c"># cluster ip service 호출</span>
curl localhost:8001/api/v1/namespaces/default/services/kubia-public/proxy/
<span class="sb">``</span>

<span class="c">## 10.4 스테이트풀셋의 피어 디스커버리</span>
 - 클러스터된 애플리케이션의 중요한 요구사항은 피어 디스커버리<span class="o">(</span>클러스터의 다른 멤버를 찾는 기능<span class="o">)</span>이다.
 - API서버와 통신해서 찾을수 있지만, 쿠버네티스의 목표 중 하나는 애플리케이션을 완전히 쿠버네티스에 독립적으로 유지하며 기능을 노출하는 것이다.

<span class="c">### SRV 레코드</span>
 - srvlookup이라 부르는 일회용 파드<span class="o">(</span><span class="nt">--restart</span><span class="o">=</span>Never<span class="o">)</span>를 실행하고 콘솔에 연결하며<span class="o">(</span><span class="nt">-it</span><span class="o">)</span> 명령어를 수행하고 종료되며, 바로 삭제된다.<span class="o">(</span><span class="nt">--rm</span><span class="o">)</span>
 - ANSWER SECTION에는 헤드리스 서비스를 뒷받침하는 두 개의 파드를 가리키는 두 개의 SRV 레코드를 확인할 수 있다.
 - 파드가 스테이트풀셋의 다른 모든 파드의 목록을 가져오려면 SRC DNS 룩업을 수행해서 얻을수 있다는 것이다.

<span class="sb">```</span> sh
<span class="c"># srvlookup을 할수 있는 dnsutils pod을 하나 수행시켜서 명령어를 수행하고 파드 종료</span>
kubectl run <span class="nt">-it</span> srvlookup <span class="nt">--image</span><span class="o">=</span>tutum/dnsutils <span class="nt">--rm</span> <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--</span> dig SRV kubia.default.svc.cluster.local


<span class="p">;;</span> ANSWER SECTION:
kubia.default.svc.cluster.local. 30 IN	SRV	0 50 80 kubia-0.kubia.default.svc.cluster.local.
kubia.default.svc.cluster.local. 30 IN	SRV	0 50 80 kubia-1.kubia.default.svc.cluster.local.

<span class="p">;;</span> ADDITIONAL SECTION:
kubia-1.kubia.default.svc.cluster.local. 30 IN A 172.17.0.8
kubia-0.kubia.default.svc.cluster.local. 30 IN A 172.17.0.3
</pre></table></code></div></div><h3 id="1041-dns를-통한-피어-디스커버리"><span class="mr-2">10.4.1 DNS를 통한 피어 디스커버리</span><a href="#1041-dns를-통한-피어-디스커버리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>스테이트풀셋과 SRV 레코드를 사용하여 헤드리스 서비스의 모든 파드를 직접 찾는다.</ul><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">dns</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">dns</span><span class="dl">'</span>

<span class="nx">dns</span><span class="p">.</span><span class="nf">resolveSrv</span><span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">addresses</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO 무언가 처리</span>
<span class="p">})</span>
</pre></table></code></div></div><p><a href="https://user-images.githubusercontent.com/6982740/91987026-7267ac00-ed68-11ea-811f-d0dc7228d03f.png" class="popup img-link "><img width="592" alt="스크린샷 2020-09-02 오후 10 05 36" data-src="https://user-images.githubusercontent.com/6982740/91987026-7267ac00-ed68-11ea-811f-d0dc7228d03f.png" class="lazyload" data-proofer-ignore></a></p><h3 id="1042-스테이트풀셋-업데이트"><span class="mr-2">10.4.2 스테이트풀셋 업데이트</span><a href="#1042-스테이트풀셋-업데이트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>편집기로 statefulset 정의 내에서 레플리카 수를 수정한다면 수정 직후 파드가 생성되는걸 확인할 수 있다.<li>만약 이미지를 변경한다면 디플로이먼트처럼 롱링 업데이트도 필요할텐데 쿠버네티스 1.7부터 이 기능도 지원한다.</ul><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># 편집기로 statefulset 정의 열어서 수정</span>
kubectl edit statefulset kubia

<span class="c"># pod 확인</span>
kubectl get po
</pre></table></code></div></div><h3 id="1043-클러스터된-데이터-저장소-사용하기"><span class="mr-2">10.4.3 클러스터된 데이터 저장소 사용하기</span><a href="#1043-클러스터된-데이터-저장소-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>SRV lookup을 통해 서비스에 포함된 모든 파드를 찾을수 있기 때문에 스테이트풀셋을 스케일 업하거나 스케일 다운하더라도 클라이언트 요청을 서비스하는 파드는 항상 그 시점에 실행중인 모든 피어를 찾을 수 있다.</ul><h2 id="105-스테이트풀셋이-노드-실패를-처리하는-과정"><span class="mr-2">10.5 스테이트풀셋이 노드 실패를 처리하는 과정</span><a href="#105-스테이트풀셋이-노드-실패를-처리하는-과정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>스테이트풀셋은 노드가 실패한 경우 동일한 아이덴티티와 스토리지를 가진 두 개의 파드가 절대 실행되지 않는 것을 보장하므로, 스테이트풀셋은 파드가 더 이상 실행되지 않는다는 것을 확실할 때까지 대체 파드를 생성할 수 없으며, 생성해서도 안된다.<li>이 경우 오직 클러스터 관리자가 알려줘야만 알 수 있고, 이를 위해 관리자는 파드를 삭제하거나 전체 노드를 삭제해야 한다.(노드 삭제시 노드에 스케줄링된 모든 파드가 삭제됨)<li>노드가 다운된 상태에서 파드를 삭제하게 되면 쿠버네티스 클러스터(마스터) 기준으로는 파드가 삭제됐으나, 다운된 노드에서는 이를 알 방법이 없기 때문에 실제 노드에 스케줄링된 파드가 삭제되지는 않는다. 이 경우 파드를 강제로 삭제해야 할 수 있다.<li>노드가 더 이상 실행중이 아니거나 연결 불가함을 아는 경우가 아니라면, 스테이트풀 파드를 강제로 삭제해서는 안된다.(영구적으로 유지되는 좀비 파드가 생성될수 있다.)</ul><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://www.manning.com/books/kubernetes-in-action">kubernetes-in-action</a><li><a href="https://kubernetes.io/ko/docs/home/">kubernetes.io</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/kubernetes/'>kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/infra/" class="post-tag no-text-decoration" >Infra</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/kubernetes-in-action/" class="post-tag no-text-decoration" >kubernetes-in-action</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[kubernetes-in-action]%2010.%20%EC%8A%A4%ED%85%8C%EC%9D%B4%ED%8A%B8%ED%92%80%EC%85%8B:%20%EB%B3%B5%EC%A0%9C%EB%90%9C%20%EC%8A%A4%ED%85%8C%EC%9D%B4%ED%8A%B8%ED%92%80%20%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98%20%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-platform-kubernetes-in-action10%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[kubernetes-in-action]%2010.%20%EC%8A%A4%ED%85%8C%EC%9D%B4%ED%8A%B8%ED%92%80%EC%85%8B:%20%EB%B3%B5%EC%A0%9C%EB%90%9C%20%EC%8A%A4%ED%85%8C%EC%9D%B4%ED%8A%B8%ED%92%80%20%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98%20%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-platform-kubernetes-in-action10%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-platform-kubernetes-in-action10%2F&text=[kubernetes-in-action]%2010.%20%EC%8A%A4%ED%85%8C%EC%9D%B4%ED%8A%B8%ED%92%80%EC%85%8B:%20%EB%B3%B5%EC%A0%9C%EB%90%9C%20%EC%8A%A4%ED%85%8C%EC%9D%B4%ED%8A%B8%ED%92%80%20%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98%20%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/devlog-platform-kubernetes-in-action1/"><div class="card-body"> <em class="small" data-ts="1596270840" data-df="ll" > Aug 1, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-in-action] 1. 쿠버네티스 소개</h3><div class="text-muted small"><p> 1. 쿠버네티스 소개 쿠버네티스 등장 배경 거대한 모놀리스 레거시 애플리케이션은 점차 마이크로 서비스라는 독립적으로 실행되는 더 작은 구성 요소로 세분화되고 있다. 마이크로 서비스는 서루 분리돼 있기 떄문에 개별적으로 개발, 배포, 업데이트, 확장할 수 있다. 이로써 오늘날 급변하는 비즈니스 요구사항을 충족시킬 만큼 신속하게 자주 구성 요소를 변...</p></div></div></a></div><div class="card"> <a href="/posts/devlog-platform-kubernetes-in-action2/"><div class="card-body"> <em class="small" data-ts="1596357240" data-df="ll" > Aug 2, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-in-action] 2. 도커와 쿠버네티스 첫걸음</h3><div class="text-muted small"><p> 2. 도커와 쿠버네티스 첫걸음 2.1 도커를 사용한 컨테이너 이미지 생성, 실행, 공유하기 2.1.1 Hello World 컨테이너 실행하기 docker run busybox echp &quot;Hello world&quot; 백그라운드에 일어난 동작 이해하기 docker run 명령을 수행했을 떄 일어나는 일들 2.1.2 간단한 node.js 애플리...</p></div></div></a></div><div class="card"> <a href="/posts/devlog-platform-kubernetes-in-action3/"><div class="card-body"> <em class="small" data-ts="1596443640" data-df="ll" > Aug 3, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-in-action] 3. 파드 : 쿠버네티스에서 컨테이너 실행</h3><div class="text-muted small"><p> 3. 파드 : 쿠버네티스에서 컨테이너 실행 3.1 파드 소개 파드는 함께 배치된 컨테이너 그룹이며, 쿠버네티스의 기본 빌딩 블록. 컨테이너를 개별적으로 배포하기보다는 컨테이너를 가진 파드를 배포하고, 운영한다. 무조건 2개 이상을 컨테이너를 포함시키라는 의미는 아니고 일반적으로는 하나의 컨테이너만 포함된다. 파드의 핵심은 파드가 여러 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/devlog-platform-kubernetes-in-action9/" class="btn btn-outline-primary" prompt="Older"><p>[kubernetes-in-action] 9. 디플로이먼트 : 선언적 애플리케이션 업데이트</p></a> <a href="/posts/devlog-platform-kubernetes-in-action11/" class="btn btn-outline-primary" prompt="Newer"><p>[kubernetes-in-action] 11. 쿠버네티스 내부 이해</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/devlog-platform-kubernetes-in-action10/'; this.page.identifier = '/posts/devlog-platform-kubernetes-in-action10/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>

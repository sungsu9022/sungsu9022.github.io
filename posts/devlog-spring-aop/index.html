<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Spring AOP 이야기 - AOP는 언제 써야할까?" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="Spring AOP Spring을 공부하다보면 필연적으로 AOP를 만나게 되는데, 개발자들은 이걸 언제 쓰는게 좋을지 고민하곤 하는데요. 관련해서 사용방법과 언제 써야할지를 한번 알아보겠습니다." /><meta property="og:description" content="Spring AOP Spring을 공부하다보면 필연적으로 AOP를 만나게 되는데, 개발자들은 이걸 언제 쓰는게 좋을지 고민하곤 하는데요. 관련해서 사용방법과 언제 써야할지를 한번 알아보겠습니다." /><link rel="canonical" href="https://sungsu9022.github.io/posts/devlog-spring-aop/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/devlog-spring-aop/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-22T17:34:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring AOP 이야기 - AOP는 언제 써야할까?" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2020-06-22T17:34:00+09:00","datePublished":"2020-06-22T17:34:00+09:00","description":"Spring AOP Spring을 공부하다보면 필연적으로 AOP를 만나게 되는데, 개발자들은 이걸 언제 쓰는게 좋을지 고민하곤 하는데요. 관련해서 사용방법과 언제 써야할지를 한번 알아보겠습니다.","headline":"Spring AOP 이야기 - AOP는 언제 써야할까?","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/devlog-spring-aop/"},"url":"https://sungsu9022.github.io/posts/devlog-spring-aop/"}</script><title>Spring AOP 이야기 - AOP는 언제 써야할까? | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Spring AOP 이야기 - AOP는 언제 써야할까?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Spring AOP 이야기 - AOP는 언제 써야할까?</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1592814840" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 22, 2020 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3602 words"> <em>20 min</em> read</span></div></div></div><div class="post-content"><h1 id="spring-aop">Spring AOP</h1><blockquote><p>Spring을 공부하다보면 필연적으로 AOP를 만나게 되는데, 개발자들은 이걸 언제 쓰는게 좋을지 고민하곤 하는데요. 관련해서 사용방법과 언제 써야할지를 한번 알아보겠습니다.</p></blockquote><h2 id="1-aop란"><span class="mr-2">1. AOP란?</span><a href="#1-aop란" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>부가기능 모듈을 객체지향 기술에서 주로 사용하는 오브젝트와는 다르게 특별한 이름으로 부르기 시작한 것<li>그 자체로 애플리케이션의 핵심 기능을 담고 있지는 않지만, 애플리케이션을 구성하는 중요한 한 가지 요소이고, 핵심 기능에 부가되어 의미를 갖는 특별한 모듈<li>어드바이저는 가장 단순한 형태의 애스팩트AOP(애스펙트 지향 프로그래밍, Aspect Oriented Programming)<li>OOP를 돕는 보조적인 기술일뿐, OOP를 대체하는 새로운 개념이 아니다.<li>부가기능이 핵심기능 안으로 침투해버리면 핵심기능 설계에 객체지향 기술의 가치를 온전히 부여하기 힘들어짐. AOP는 애스펙트를 분리함으로써 핵심기능을 설계하고 구현할 때 객체지향적인 가치를 지킬 수 있도록 돕는 것.</ul><h2 id="2-언제-aop를-사용해야-할까"><span class="mr-2">2. 언제 AOP를 사용해야 할까?</span><a href="#2-언제-aop를-사용해야-할까" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="21-매번-반복되는-개발-패턴들"><span class="mr-2">2.1 매번 반복되는 개발 패턴들</span><a href="#21-매번-반복되는-개발-패턴들" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">SomethingService</span> <span class="n">service</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">SomethingRepository</span> <span class="n">repository</span><span class="o">;</span>

	<span class="nd">@Transactional</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>

		<span class="k">if</span><span class="o">(</span><span class="n">isCondition</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// 무언가를 한다.</span>
		<span class="o">}</span>

		<span class="k">if</span><span class="o">(</span><span class="n">isCondition2</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// 무언가를 한다.</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

		<span class="o">}</span>

		<span class="k">if</span><span class="o">(</span><span class="n">isCondition3</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span><span class="o">(</span><span class="n">isCondition4</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">for</span><span class="o">(</span><span class="nc">Object</span> <span class="n">item</span> <span class="o">:</span> <span class="nc">ItemList</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// 무언가를 한다.</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="c1">// 무언가를 한다.</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</pre></table></code></div></div><ul><li>Spring에서 제공하고자 했던 그 기술의 철학과 가치에 부합되는 방식으로 개발하자.<li>객체지향적인 고민(?)을 더하다.<li>실제로 객체지향의 핵심인 SOLID 원칙 중 단일책임 원칙을 위배하면서 개발하는 경우는 상당수<ul><li>사실 이렇게 개발하게 된 이유는 현실적으로 이것 하나 떄문에 이렇게까지 해야 하나에 대한 고민도 있을것이고, if문 하나 추가하면 오히려 가독성 측면이나 유지보수 측면에서 더 좋기 떄문이다.</ul></ul><h3 id="22-그러면-언제-aop를-써야하는가"><span class="mr-2">2.2 그러면 언제 AOP를 써야하는가?</span><a href="#22-그러면-언제-aop를-써야하는가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>반복적으로 동일한 코드를 여기저기에 개발 적용해야 하는 경우(최우선)<li>자신의 설계에서 A클래스에 부여한 책임을 넘어서는 수준의 일을 처리해야 하는 경우<ul><li>이 부분은 반복적으로 동일한 코드가 계속 들어가야 하는 경우의 전제조건이 있어야 한다. 만약 하나의 영역에서만 사용되는 코드를 굳이 AOP로 만드는것은 다른사람의 코드 추적을 어렵게 만들지도 모른다.</ul><li>해당 처리 로직이 클래스에서 처리해야 하는 핵심로직이냐 아니면 부가 기능이냐를 기준으로 잘 판단해서 부가기능인 경우<ul><li>이 판단이 사실 명확한 근거는 없다. 개인과 팀이 상황에 따라 적절히 판단하는게 좋을것 같다.</ul></ul><h3 id="23-sevlet-filter-vs-interceptor-vs-aop"><span class="mr-2">2.3 Sevlet Filter vs Interceptor vs AOP</span><a href="#23-sevlet-filter-vs-interceptor-vs-aop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>AOP에 대해서 자세히 알아보기 전에 먼저 Servlet Filter, Intercpetor, AOP에 대해서 알아볼 필요가 있다.<li>Spring 웹 애플리케이션을 개발하면서 Filter, Interceptor는 심심찮게 접했을 것이다.<li>동작 방식은 사실 이 3가지 모두 비슷한 점이 있다.<li>차이가 있다면 처리되는 시점의 차이가 있다.<ul><li>Servlet Filter는 request 최앞단, 최말단에서 동작하고,<li>Interceptor는 Dispatcher Servlet 다음 단계에서 동작하고<li>AOP는 개발자가 직접 처리시점을 정할수 있다.</ul></ul><p><a href="https://user-images.githubusercontent.com/6982740/85278169-86b54000-b4bf-11ea-8590-993ea1951008.png" class="popup img-link "><img data-src="https://user-images.githubusercontent.com/6982740/85278169-86b54000-b4bf-11ea-8590-993ea1951008.png" alt="filter interceptor" class="lazyload" data-proofer-ignore></a></p><h2 id="3-aop-사용하기"><span class="mr-2">3. AOP 사용하기</span><a href="#3-aop-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="31-spring-boot-project-설정"><span class="mr-2">3.1 Spring boot Project 설정</span><a href="#31-spring-boot-project-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>aop 라이브러리 dependency를 추가한다.</ul><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-aop<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

</pre></table></code></div></div><h3 id="32-aop-configration"><span class="mr-2">3.2 AOP Configration</span><a href="#32-aop-configration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Configuration클래스 혹은 Application Class에 @EnableAspectJAutoProxy 을 추가해준다.<li>나는 별도의 Configration도 각 목적에 따라 나누어 처리하는것을 선호해서 별도의 RootConfig.class를 두었고, 그쪽에 선언하였다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableAspectJAutoProxy</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RootConfig</span> <span class="o">{</span>
<span class="o">}</span>

<span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">scanBasePackageClasses</span> <span class="o">=</span> <span class="o">{</span><span class="nc">RootConfig</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="kd">extends</span> <span class="nc">SpringBootServletInitializer</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SpringApplication</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SpringApplication</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">app</span><span class="o">.</span><span class="na">addListeners</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApplicationPidFileWriter</span><span class="o">());</span>
		<span class="n">app</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
</pre></table></code></div></div><h3 id="33-enableaspectjautoproxy"><span class="mr-2">3.3 @EnableAspectJAutoProxy</span><a href="#33-enableaspectjautoproxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>@EnableAspectJAutoProxy 는 다른 Enable류와 마찬가지로 auto configration annotation이다.<li>AOP와 관련된 @Aspect와 같은 annotation을 사용할수 있도록 해준다.<li>xml에서는 <code class="language-plaintext highlighter-rouge">&lt;aop:aspectj-autoproxy&gt;</code>와 동일한 효과라고 생각하면 된다.<li>@EnableAspectJAutoProxy의 proxyTargetClass attribute가 있는데 이 부분에 대해서도 간략히 알고 있으면 좋다.</ul><h3 id="34-enableaspectjautoproxyproxytargetclass"><span class="mr-2">3.4 EnableAspectJAutoProxy.proxyTargetClass</span><a href="#34-enableaspectjautoproxyproxytargetclass" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>이 부분은 Spring의 역사 이야기를 조금 해야 하는데 proxy 방식에는 JDK Dynamic Proxy방식과 CGLIB 방식이 있다는 것을 알아야 한다.<li>JDK Dynamic Proxy은 인터페이스를 구현해서 구현된 메소드에만 AOP를 적용할수 있는 방법이었어서 이 방식으로 proxy 처리를 하면 인터페이스에 정의된 메소드에만 proxy를 적용할 수 있다.<li>CDLIB는 대상 클래스를 상속받아서 프록시 객체를 구현하는 방식으로 클래스가 final만 아니라면 proxy를 적용할수 있다.<li>proxyTargetClass 이 옵션은 저 방식을 무엇으로 할건지에 대한 것이다.<li>proxyTargetClass의 기본값은 false인데, 그러면 기본이 JDK Dynamic Proxy인것을 알수 있다.<li>하지만 가장 최근 문서를 읽어보니면 프록시 대상 클래스가 인터페이스를 구현하지 않으면 기본적으로 CGLIB 프록시가 적용된다고 합니다.(spring 5.2 공식 문서 기준)</ul><h3 id="35-aop-aspect-클래스-정의"><span class="mr-2">3.5 AOP Aspect 클래스 정의</span><a href="#35-aop-aspect-클래스-정의" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Aspect를 정의하고 어느시점에 처리할지에 대한 부분은 @Around, @Before, @After가 있다.<ul><li>@Around는 메소드의 실행 전 / 후의 로직을 컨트롤할수 있다.<li>@Before, @After은 말 그대로 메소드 실행 전 / 후이다.</ul><li>서비스 비즈니스 로직 개발하는 입장에서는 @Around을 이용해야 하는 케이스가 제일 많았다.</ul><blockquote><p>로컬환경에서만 동작해야 하는 스펙이 있다고 가정하고 AOP를 만들어보자. 동작하는 스펙은 편의상 String을 return하는 메소드 시그니쳐에 DummyString을 return 한다고 가정한다.</p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainAspect</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">EnvConfig</span> <span class="n">envConfig</span><span class="o">;</span>

	<span class="nd">@Around</span><span class="o">(</span><span class="s">"execution(String com.sungsu.boilerplate.app.main.MainService.*(..)) &amp;&amp; @annotation(com.sungsu.boilerplate.app.main.aspect.ReturnDummy)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">returnDummy</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">isLocalEnvironment</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="c1">// local 환경인 경우 본  메소드를 수행하지 않고 dummy value를 return</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"returnDummy"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"returnDummy"</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 로컬 환경인지 확인
	 * @return
	 */</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isLocalEnvironment</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">envConfig</span><span class="o">.</span><span class="na">isLocal</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="36-aspect-동작-시점-정의"><span class="mr-2">3.6 Aspect 동작 시점 정의</span><a href="#36-aspect-동작-시점-정의" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>어느 시점에 Aspect를 동작시킬지에 대한 방법은 다양한데, 대표적으로 포인트컷 표현식이 있다.<li>하지만 위 3.5 예제에서는 보다시피 포인트컷 표현식(@execution) 과 @annotation을 and 조건으로 사용하고 있다.<li>왜 Annotation을 이용해서 AOP를 적용했을까?<li>포인트컷 표현식을 이용한 AOP를 적용했을때의 문제</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAspect</span> <span class="o">{</span>
	<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"execution(* transfer(..))"</span><span class="o">)</span><span class="c1">// 포인트컷 표현식</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">anyOldTransfer</span><span class="o">()</span> <span class="o">{}</span><span class="c1">// 포인트컷 시그니처</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>AOP 적용을 위해서 포인트컷 표현식만을 이용한다고 했을 때 AOP가 적용된 메소드에서는 이 메소드에 AOP를 걸었는지 아닌지를 한눈에 파악하기가 어렵다.<li>물론 IDE에서는 네비게이션을 제공해주기는 하지만 github을 이용해서 코드리뷰를 한다던지 했을때 이를 쉽게 파악할 수 없다.<li>대표적인 AOP 예인 @Transactional와 같은 경험을 얻기 위해서 위와 같이 처리한 것이다.<li>자세한 내용은 여기서는 다루지 않고 참조 링크에서 확인 바란다. ( <a href="https://blog.outsider.ne.kr/843">https://blog.outsider.ne.kr/843</a> )</ul><h3 id="37-annotation-정의하기"><span class="mr-2">3.7 annotation 정의하기</span><a href="#37-annotation-정의하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Meta Annotations</ul><div class="table-wrapper"><table><thead><tr><th> <th> <tbody><tr><td>@Retention<td>어노테이션이 적용되는 범위(?), 어떤 시점까지 어노테이션이 영향을 미치는지 결정(코드, 클래스로 컴파일, 런타임에 반영 등)<tr><td>@Documented<td>문서에도 어노테이션의 정보가 표현됩니다.<tr><td>@Target<td>어노테이션이 적용할 위치를 결정합니다.<tr><td>@Inherited<td>이 어노테이션을 선언하면 자식클래스가 어노테이션을 상속 받을 수 있습니다.<tr><td>@Repeatable<td>반복적으로 어노테이션을 선언할 수 있게 합니다.</table></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.lang.annotation.*</span><span class="o">;</span>

<span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="c1">// 컴파일 이후에도 JVM에 의해서 참조가 가능합니다.</span>
<span class="c1">//@Retention(RetentionPolicy.CLASS) // 컴파일러가 클래스를 참조할 때까지 유효합니다.</span>
<span class="c1">//@Retention(RetentionPolicy.SOURCE) // 어노테이션 정보는 컴파일 이후 없어집니다.</span>
<span class="nd">@Target</span><span class="o">({</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">PACKAGE</span><span class="o">,</span> <span class="c1">// 패키지 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="c1">// 타입 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">,</span> <span class="c1">// 생성자 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">,</span> <span class="c1">// 멤버 변수 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="c1">// 메소드 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">,</span> <span class="c1">// 어노테이션 타입 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">LOCAL_VARIABLE</span><span class="o">,</span> <span class="c1">// 지역 변수 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">,</span> <span class="c1">// 매개 변수 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE_PARAMETER</span><span class="o">,</span> <span class="c1">// 매개 변수 타입 선언시</span>
        <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE_USE</span> <span class="c1">// 타입 사용시</span>
<span class="o">})</span>
</pre></table></code></div></div><ul><li>추가적인 이해를 위해서 @Transactional 을 인용하자면</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Transactional</span> <span class="o">{</span>
    <span class="nd">@AliasFor</span><span class="o">(</span><span class="s">"transactionManager"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>

    <span class="nd">@AliasFor</span><span class="o">(</span><span class="s">"value"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>

    <span class="nc">Propagation</span> <span class="nf">propagation</span><span class="o">()</span> <span class="k">default</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">;</span>

    <span class="nc">Isolation</span> <span class="nf">isolation</span><span class="o">()</span> <span class="k">default</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">;</span>

    <span class="kt">int</span> <span class="nf">timeout</span><span class="o">()</span> <span class="k">default</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

    <span class="kt">boolean</span> <span class="nf">readOnly</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>

    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Throwable</span><span class="o">&gt;[]</span> <span class="nf">rollbackFor</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nc">String</span><span class="o">[]</span> <span class="nf">rollbackForClassName</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Throwable</span><span class="o">&gt;[]</span> <span class="nf">noRollbackFor</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nc">String</span><span class="o">[]</span> <span class="nf">noRollbackForClassName</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>예제코드에 사용한 annotation은 간단하다. 이정도만으로도 원하는 형태로 충분히 사용 가능하다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">ReturnDummy</span> <span class="o">{</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>annotation을 통해 특정 값을 전달할수도 있다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">ReturnDummy</span> <span class="o">{</span>
	<span class="nc">String</span> <span class="nf">data</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
<span class="o">}</span>


	<span class="nd">@ReturnDummy</span><span class="o">(</span><span class="n">data</span> <span class="o">=</span> <span class="s">"test"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">method1</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method1"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"method1"</span><span class="o">;</span>
	<span class="o">}</span>
</pre></table></code></div></div><ul><li>혹시 필요하다면 el expression으로 전달할수도 있으니 참고만 하도록 하자.</ul><h3 id="38-aop-메소드에-적용하기"><span class="mr-2">3.8 AOP 메소드에 적용하기</span><a href="#38-aop-메소드에-적용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>애노테이션과 Aspect를 정의했다면 이제 Service Layer 같은곳에 적용할 차례이다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1">// MainController.java</span>
<span class="nd">@Controller</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainController</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">MainService</span> <span class="n">mainService</span><span class="o">;</span>

	<span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"/"</span><span class="o">,</span> <span class="s">"/main"</span><span class="o">})</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">mainService</span><span class="o">.</span><span class="na">method1</span><span class="o">();</span>
		<span class="n">mainService</span><span class="o">.</span><span class="na">method2</span><span class="o">();</span>
		<span class="n">mainService</span><span class="o">.</span><span class="na">method3</span><span class="o">();</span>
		<span class="k">return</span> <span class="s">"index"</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">// MainService.java</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainService</span> <span class="o">{</span>

	<span class="nd">@ReturnDummy</span><span class="o">(</span><span class="n">data</span> <span class="o">=</span> <span class="s">"test"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">method1</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method1"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"method1"</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@ReturnDummy</span><span class="o">(</span><span class="n">data</span> <span class="o">=</span> <span class="s">"test"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">method2</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method2"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"method2"</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@ReturnDummy</span><span class="o">(</span><span class="n">data</span> <span class="o">=</span> <span class="s">"test"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">method3</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method3"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"method3"</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>이렇게 적용하면 로컬환경에서는 각 method1,2,3을 호출해도 해당 메소드는 호출되지 않고 AOP에 정의한 “dummyReturn” 값만을 return 하게 될 것이다.<li>annotation을 정의할떄 @Target을 METHOD, TYPE 2가지를 보통 정의했는데 위 예제는 메소드 각각에 정의했지만 Class에 바로 적용도 가능한다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="nd">@ReturnDummy</span><span class="o">(</span><span class="n">data</span> <span class="o">=</span> <span class="s">"test"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainService</span> <span class="o">{</span>


	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">method1</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method1"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"method1"</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">method2</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method2"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"method2"</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">method3</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method3"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"method3"</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>다만 클래스에 적용하는것보단 메소드단위로 적용하는것이 개발할때 더 편리하다.(IntelliJ IDEA 기준으로 method에 정의한 annotation에서는 trace가 가능한 마킹이 생기는것을 알수 있다.)</ul><p><a href="https://user-images.githubusercontent.com/6982740/85282236-5c1ab580-b4c6-11ea-965a-bc32945841ef.png" class="popup img-link "><img width="509" alt="스크린샷 2020-06-22 오후 8 23 46" data-src="https://user-images.githubusercontent.com/6982740/85282236-5c1ab580-b4c6-11ea-965a-bc32945841ef.png" class="lazyload" data-proofer-ignore></a></p><p><a href="https://user-images.githubusercontent.com/6982740/85282241-5de47900-b4c6-11ea-89d1-4c80301320a8.png" class="popup img-link "><img width="487" alt="스크린샷 2020-06-22 오후 8 24 00" data-src="https://user-images.githubusercontent.com/6982740/85282241-5de47900-b4c6-11ea-89d1-4c80301320a8.png" class="lazyload" data-proofer-ignore></a></p><h3 id="39-aop-테스트-코드-작성"><span class="mr-2">3.9 AOP 테스트 코드 작성</span><a href="#39-aop-테스트-코드-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>AspectJProxyFactory를 이용해서 aspect를 주입해주고 Proxy 객체로 덮어 씌워주면 된다.<li>예제는 아래를 참고하면 된다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">MockitoJUnitRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainServiceTest</span> <span class="o">{</span>

	<span class="nd">@InjectMocks</span>
	<span class="kd">private</span> <span class="nc">MainService</span> <span class="n">mainService</span><span class="o">;</span>
	<span class="nd">@InjectMocks</span>
	<span class="kd">private</span> <span class="nc">MainAspect</span> <span class="n">aspect</span><span class="o">;</span>
	<span class="nd">@Mock</span>
	<span class="kd">private</span> <span class="nc">EnvConfig</span> <span class="n">envConfig</span><span class="o">;</span>


	<span class="nd">@Before</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AspectJProxyFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AspectJProxyFactory</span><span class="o">(</span><span class="n">mainService</span><span class="o">);</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">addAspect</span><span class="o">(</span><span class="n">aspect</span><span class="o">);</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setProxyTargetClass</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">mainService</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">envConfig</span><span class="o">.</span><span class="na">isLocal</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">assertTrue</span><span class="o">(</span><span class="nc">MainAspect</span><span class="o">.</span><span class="na">DUMMY_VALUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">mainService</span><span class="o">.</span><span class="na">method1</span><span class="o">()));</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h2 id="4-aop에-대한-개인-생각"><span class="mr-2">4. AOP에 대한 개인 생각</span><a href="#4-aop에-대한-개인-생각" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>나는 실제 서비스 개발을 하면서 AOP를 꽤 자주 사용하는 편이다.<li>AOP를 써야할지 말지를 판단할떄는 위에 언급한것처럼 각각의 조건을 충족할떄 하는것이 좋다.<li>AOP가 만능은 아니며, 오히려 유지보수성을 떨어뜨릴지도 모른다. 적절한 상황을 잘 판단하여 사용하도록 하자.<li>내가 AOP를 실무에 적용한 케이스<ul><li>A/B테스트 적용을 위해 특정 유저군들에만 한시적으로 기능을 오픈하기 위한 방식으로 사용<li>성능 테스트시에 다른 서비스(서버 단위)에 영향을 주지 않기 위해 더미 처리를 하기 위해 사용<li>특정 환경에서만 노출되어야 할 부가정보를 추가해주기 위해<li>모델의 Deprecated된 필드가 있는데(DB에서 제거) 구버전 앱 지원을 위해 상위 레벨에서는 해당 데이터가 필요한 상황이 있어서 이 값을 바인딩해주는 역할로써 AOP 사용<li>Redis 기반 Lock 적용시 AOP 사용<li>이 외 임시로 특정기간동안만 추가되는 로직이 있을때 한시적으로 AOP를 적용해서 처리하고, 그 특정기간이 종료되면 Aspect와 Annotation을 제거하여 쉽게 제거하기 위한 목적 등</ul></ul><h2 id="5-예제-코드"><span class="mr-2">5. 예제 코드</span><a href="#5-예제-코드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://github.com/sungsu9022/spring-boot-boilerplate/commit/bcc91cc94b7f8fe5c233bbf9efe154fb7a00b6e7">https://github.com/sungsu9022/spring-boot-boilerplate/commit/bcc91cc94b7f8fe5c233bbf9efe154fb7a00b6e7</a><li><a href="https://github.com/sungsu9022/spring-boot-boilerplate">https://github.com/sungsu9022/spring-boot-boilerplate</a></ul><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://docs.spring.io/spring/docs/5.2.0.M1/spring-framework-reference/core.html#aop">https://docs.spring.io/spring/docs/5.2.0.M1/spring-framework-reference/core.html#aop</a><li><a href="https://blog.outsider.ne.kr/843">https://blog.outsider.ne.kr/843</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/spring/" class="post-tag no-text-decoration" >Spring</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring%20AOP%20%EC%9D%B4%EC%95%BC%EA%B8%B0%20-%20AOP%EB%8A%94%20%EC%96%B8%EC%A0%9C%20%EC%8D%A8%EC%95%BC%ED%95%A0%EA%B9%8C?%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-spring-aop%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring%20AOP%20%EC%9D%B4%EC%95%BC%EA%B8%B0%20-%20AOP%EB%8A%94%20%EC%96%B8%EC%A0%9C%20%EC%8D%A8%EC%95%BC%ED%95%A0%EA%B9%8C?%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-spring-aop%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fdevlog-spring-aop%2F&text=Spring%20AOP%20%EC%9D%B4%EC%95%BC%EA%B8%B0%20-%20AOP%EB%8A%94%20%EC%96%B8%EC%A0%9C%20%EC%8D%A8%EC%95%BC%ED%95%A0%EA%B9%8C?%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/devlog-spring-boot-application/"><div class="card-body"> <em class="small" data-ts="1588264440" data-df="ll" > May 1, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot + JPA + H2 Application 간단하게 띄우기</h3><div class="text-muted small"><p> Spring Boot + JPA + H2 Application 간단하게 띄우기 1. 프로젝트 만들기 2. 애플리케이션 기본 설정 3. Web MVC Configuration 4. JSP Configration 5. JPA Configration 1. 프로젝트 만들기 1.1 spring initializr을 통해 프로젝트 뼈대 만...</p></div></div></a></div><div class="card"> <a href="/posts/devlog-spring-boot-tools/"><div class="card-body"> <em class="small" data-ts="1588494840" data-df="ll" > May 3, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot JSP 자동 reload 되지 않는 문제 해결 방법</h3><div class="text-muted small"><p> Spring Boot JSP 자동 reload 되지 않는 문제 해결 방법 내용 legacy Spring Project에서 Spring boot로 전환되었을때 즉시 발견할수 있는 문제중 하나는 IDE에서 jsp파일을 수정해도 auto reload되지 않는 문제입니다. 이 경우 JSP에 수정사항을 반영하기 위해서는 Application을 재시작해야...</p></div></div></a></div><div class="card"> <a href="/posts/spring5-reactive-programing-1/"><div class="card-body"> <em class="small" data-ts="1654914900" data-df="ll" > Jun 11, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Hands-On Reactive Programming in Spring 5] 1. 왜 리액티브 스프링인가?</h3><div class="text-muted small"><p> 1. 왜 리액티브 스프링인가? 1.1 왜 리액티브인가? 서버진영에서 reactive(반응형)이라는 말이 2019년쯤부터 굉장히 빈번하게 들려왔다. 시스템의 가용량 예시 tomcat worker thread 500으로 설정 API 응답시간이 250ms 이 기준으로 계산해보면 시스템의 최대 TPS 2,000임을 알수 있다. 특수...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/devlog-java-algolithm2/" class="btn btn-outline-primary" prompt="Older"><p>[HackerRank] Java String Reverse</p></a> <a href="/posts/devlog-java-algolithm3/" class="btn btn-outline-primary" prompt="Newer"><p>[HackerRank] Java Anagrams</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/devlog-spring-aop/'; this.page.identifier = '/posts/devlog-spring-aop/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>

<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)" /><meta name="author" content="sungsu park" /><meta property="og:locale" content="en" /><meta name="description" content="4. 데이터 다루기 -3(ES Client 라이브러리) 4.5 서비스 코드에서 엘라스틱서치 클라이언트 이용 지금까지 배웠던 REST API를 호출해서 ES에 작업을 요청할수도 있겠으나, 이런 방식보다는 ES에서 공식적으로 제공하는 Client 라이브러리를 활용하면 좀 더 간편하게 코드를 작성할 수 있고, 유지보수도 더 쉽다. Java, Javascript, Python, Go, .NET 등 다양한 언어에서 사용할수 있는 클라이언트 라이브러리를 제공함." /><meta property="og:description" content="4. 데이터 다루기 -3(ES Client 라이브러리) 4.5 서비스 코드에서 엘라스틱서치 클라이언트 이용 지금까지 배웠던 REST API를 호출해서 ES에 작업을 요청할수도 있겠으나, 이런 방식보다는 ES에서 공식적으로 제공하는 Client 라이브러리를 활용하면 좀 더 간편하게 코드를 작성할 수 있고, 유지보수도 더 쉽다. Java, Javascript, Python, Go, .NET 등 다양한 언어에서 사용할수 있는 클라이언트 라이브러리를 제공함." /><link rel="canonical" href="https://sungsu9022.github.io/posts/es-bible-4-3/" /><meta property="og:url" content="https://sungsu9022.github.io/posts/es-bible-4-3/" /><meta property="og:site_name" content="Sungsu’s Tech Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-31T18:35:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)" /><meta name="twitter:site" content="@sungsu9022dev" /><meta name="twitter:creator" content="@sungsu park" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"sungsu park"},"dateModified":"2024-01-07T19:14:31+09:00","datePublished":"2023-12-31T18:35:00+09:00","description":"4. 데이터 다루기 -3(ES Client 라이브러리) 4.5 서비스 코드에서 엘라스틱서치 클라이언트 이용 지금까지 배웠던 REST API를 호출해서 ES에 작업을 요청할수도 있겠으나, 이런 방식보다는 ES에서 공식적으로 제공하는 Client 라이브러리를 활용하면 좀 더 간편하게 코드를 작성할 수 있고, 유지보수도 더 쉽다. Java, Javascript, Python, Go, .NET 등 다양한 언어에서 사용할수 있는 클라이언트 라이브러리를 제공함.","headline":"[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)","mainEntityOfPage":{"@type":"WebPage","@id":"https://sungsu9022.github.io/posts/es-bible-4-3/"},"url":"https://sungsu9022.github.io/posts/es-bible-4-3/"}</script><title>[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리) | Sungsu's Tech Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sungsu's Tech Blog"><meta name="application-name" content="Sungsu's Tech Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/personal/sunny.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sungsu's Tech Blog</a></div><div class="site-subtitle font-italic">Java/Kotlin Spring, Back-end</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/sungsu9022" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sungsu9022dev" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sungsu9022','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1704015300" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 31, 2023 </em> </span> <span> Updated <em class="" data-ts="1704622471" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 7, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4491 words"> <em>24 min</em> read</span></div></div></div><div class="post-content"><h1 id="4-데이터-다루기--3es-client-라이브러리">4. 데이터 다루기 -3(ES Client 라이브러리)</h1><h2 id="45-서비스-코드에서-엘라스틱서치-클라이언트-이용"><span class="mr-2">4.5 서비스 코드에서 엘라스틱서치 클라이언트 이용</span><a href="#45-서비스-코드에서-엘라스틱서치-클라이언트-이용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>지금까지 배웠던 REST API를 호출해서 ES에 작업을 요청할수도 있겠으나, 이런 방식보다는 ES에서 공식적으로 제공하는 Client 라이브러리를 활용하면 좀 더 간편하게 코드를 작성할 수 있고, 유지보수도 더 쉽다.<li>Java, Javascript, Python, Go, .NET 등 다양한 언어에서 사용할수 있는 클라이언트 라이브러리를 제공함.</ul><h3 id="jvm에서-지원하는-클라이언트"><span class="mr-2">JVM에서 지원하는 클라이언트</span><a href="#jvm에서-지원하는-클라이언트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="transport-클라이언트"><span class="mr-2">transport 클라이언트</span><a href="#transport-클라이언트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Deprecated된지 오래됨.<li>8버전부터는 완전히 제거됨.</ul><h4 id="저수준-rest-client"><span class="mr-2">저수준 Rest Client</span><a href="#저수준-rest-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>모든 버전 호환되나, 단순 httpClient 수준으로만 제공됨.</ul><h4 id="고수준-rest-client"><span class="mr-2">고수준 Rest Client</span><a href="#고수준-rest-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>7.15 버전부터 지원 중단 선언되었고, 자바 클라이언트로 전환이 예고되었다.</ul><h4 id="자바-클라이언트"><span class="mr-2">자바 클라이언트</span><a href="#자바-클라이언트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>개발 초기 단계이고, 아직 지원하지 않는 기능이 많으나 최신버전의 ES로 신규 구축한다면 사용을 권장한다.</ul><h3 id="451-저수준-rest-client"><span class="mr-2">4.5.1 저수준 Rest Client</span><a href="#451-저수준-rest-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>HttpComponents를 이용해서 HTTP로 통신한다.<li>요청을 ES API에 맞게 만들고 응답을 역직렬화하는 등의 작업은 클라이언트 사용자가 직접 해야 한다.<li>직접 만들어 호출하기 때문에 모든 ES버전과 호환된다.(실질적으로 api interface에 맞게 다 직접 만드는것이라 호환된다고 보기는 어렵다)</ul><h4 id="저수준-restclient-config"><span class="mr-2">저수준 RestClient Config</span><a href="#저수준-restclient-config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nf">dependencies</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">esVersion</span> <span class="p">=</span> <span class="s">"8.11.1"</span>

    <span class="c1">// es 저수준 rest client</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.elasticsearch.client:elasticsearch-rest-client:$esVersion"</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">EsConfig</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">ES_CONNECTION_TIMEOUT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// 5s</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">ES_SOCKET_TIMEOUT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// 5s</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"lowLevelEsRestClient"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">lowLevelEsRestClient</span><span class="p">():</span> <span class="nc">RestClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">RestClient</span>
            <span class="p">.</span><span class="nf">builder</span><span class="p">(</span>
                <span class="nc">HttpHost</span><span class="p">(</span><span class="s">"hosts01"</span><span class="p">,</span> <span class="mi">9200</span><span class="p">,</span> <span class="s">"http"</span><span class="p">),</span>
                <span class="nc">HttpHost</span><span class="p">(</span><span class="s">"hosts02"</span><span class="p">,</span> <span class="mi">9200</span><span class="p">,</span> <span class="s">"http"</span><span class="p">),</span>
                <span class="nc">HttpHost</span><span class="p">(</span><span class="s">"hosts03"</span><span class="p">,</span> <span class="mi">9200</span><span class="p">,</span> <span class="s">"http"</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">setRequestConfigCallback</span> <span class="p">{</span>
                <span class="n">it</span><span class="p">.</span><span class="nf">setConnectTimeout</span><span class="p">(</span><span class="nc">ES_CONNECTION_TIMEOUT</span><span class="p">)</span>
                <span class="n">it</span><span class="p">.</span><span class="nf">setSocketTimeout</span><span class="p">(</span><span class="nc">ES_SOCKET_TIMEOUT</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="저수준-restclient-사용"><span class="mr-2">저수준 RestClient 사용</span><a href="#저수준-restclient-사용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">LowLevelEsService</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">lowLevelEsRestClient</span><span class="p">:</span> <span class="nc">RestClient</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">:</span> <span class="nc">KLogging</span><span class="p">()</span>

    <span class="k">fun</span> <span class="nf">getClusterSettings</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">req</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"/_cluster/settings"</span><span class="p">)</span>
        <span class="n">req</span><span class="p">.</span><span class="nf">addParameters</span><span class="p">(</span>
            <span class="nf">mapOf</span><span class="p">(</span>
                <span class="s">"pretty"</span> <span class="n">to</span> <span class="s">"true"</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES TEST] start request"</span> <span class="p">}</span>
        <span class="kd">val</span> <span class="py">res</span> <span class="p">=</span> <span class="n">lowLevelEsRestClient</span><span class="p">.</span><span class="nf">performRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES TEST] response : $res"</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nf">getBody</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">asyncUpdateSetting</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">req</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">(</span><span class="s">"PUT"</span><span class="p">,</span> <span class="s">"/_cluster/settings"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">requestBody</span> <span class="p">=</span> <span class="s">"""
            {
                "transient": {
                    "cluster.routing.allocation.enable": "all"
                }
            }
        """</span><span class="p">.</span><span class="nf">trimIndent</span><span class="p">()</span>

        <span class="n">req</span><span class="p">.</span><span class="n">entity</span> <span class="p">=</span> <span class="nc">NStringEntity</span><span class="p">(</span><span class="n">requestBody</span><span class="p">,</span> <span class="nc">ContentType</span><span class="p">.</span><span class="nc">APPLICATION_JSON</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES TEST] start request"</span> <span class="p">}</span>
        <span class="kd">val</span> <span class="py">cancellable</span> <span class="p">=</span> <span class="n">lowLevelEsRestClient</span><span class="p">.</span><span class="nf">performRequestAsync</span><span class="p">(</span>
            <span class="n">req</span><span class="p">,</span>
            <span class="kd">object</span> <span class="err">: </span><span class="nc">ResponseListener</span> <span class="p">{</span>
                <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="nc">Response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES TEST] response : $response"</span> <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFailure</span><span class="p">(</span><span class="n">ex</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s">"[ES TEST] es error"</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES TEST] thread sleep"</span> <span class="p">}</span>
        <span class="nc">Thread</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1000L</span><span class="p">)</span>
        <span class="n">cancellable</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">getBody</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="nc">Response</span><span class="p">):</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">statusCode</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">statusLine</span><span class="p">.</span><span class="n">statusCode</span>
        <span class="kd">val</span> <span class="py">responseBody</span> <span class="p">=</span> <span class="nc">EntityUtils</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="nc">StandardCharsets</span><span class="p">.</span><span class="nc">UTF_8</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES TEST] statusCode : $statusCode, body : $responseBody"</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">responseBody</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>위 예제에서 동기식 / 비동기식으로 API를 호출해보는것을 테스트했다.<ul><li>비동기식인 경우 전달받은 Cancellable 객체의 cancel()을 통해 요청을 취소할수 있다.</ul><li>저수준 RestClient는 thread-safe하므로 Spring 환경에서 위처럼 bean으로 한번 등록해두고 재사용할 수 있다.<li>저수준 RestClient는 단순 httpClient을 쓰는것과 차이가 없다. 즉 ES 기능을 사용하려면 Document를 보면서 API 스펙에 맞게 직접 구현해줘야해서 불편할수 있다.</ul><h3 id="452-고수준-rest-client"><span class="mr-2">4.5.2 고수준 Rest Client</span><a href="#452-고수준-rest-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>고수준 RestClient는 ES API를 라이브러이의 API로 노출한다. 아예 클라이언트 라이브러리가 ES에 딱 맞게 설계되어있다.<li>다만, 위와 같은 특징때문에 ES 버전과 강하게 결합되어 있어 버전 호환성 이슈가 존재한다.<ul><li>사용하는 ES 클러스터의 버전과 클라이언트 라이브러리 버전을 맞춰야만 호환성 이슈로부터 안전하다.</ul></ul><h4 id="고수준-rest-client-버전-관련-정보"><span class="mr-2">고수준 Rest Client 버전 관련 정보</span><a href="#고수준-rest-client-버전-관련-정보" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES 7.15 버전부터 고수준 RestClient 지원 중단 선언됨.(JavaClient로 대체 필요)<li>ES5 ~ 7.15 사이의 버전을 사용한다면 고수준 RestClient을 사용하면 된다.<li>ES8 이상의 버전을 싸용한다면 자바클라이언트를 사용하는것이 좋다.</ul><h4 id="고수준--rest-client-config"><span class="mr-2">고수준 Rest Client Config</span><a href="#고수준--rest-client-config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nf">dependencies</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">esHighLevelClientVersion</span> <span class="p">=</span> <span class="s">"7.17.16"</span>

    <span class="c1">// es 고수준 rest client</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.elasticsearch.client:elasticsearch-rest-high-level-client:$esHighLevelClientVersion"</span><span class="p">)</span>
    <span class="c1">// 수동 jar 설치 후 적용하는 방식</span>
<span class="c1">//    implementation(fileTree(mapOf("dir" to "manual-build", "includes" to listOf("*.jar"))))</span>
<span class="c1">//    implementation("org.elasticsearch:elasticsearch:$esVersion")</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">EsConfig</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">ES_CONNECTION_TIMEOUT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// 5s</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">ES_SOCKET_TIMEOUT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// 5s</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"highLevelEsRestClient"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">highLevelEsRestClient</span><span class="p">():</span> <span class="nc">RestHighLevelClient</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">builder</span> <span class="p">=</span> <span class="nf">createBaseRestClientBuilder</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">RestHighLevelClientBuilder</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">())</span>
            <span class="c1">// NOTE es 8 이상일 경우 서버 호환을 위해 true로 설정</span>
            <span class="p">.</span><span class="nf">setApiCompatibilityMode</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="k">fun</span> <span class="nf">bulkProcessor</span><span class="p">(</span>
        <span class="nd">@Qualifier</span><span class="p">(</span><span class="s">"highLevelEsRestClient"</span><span class="p">)</span> <span class="n">highLevelEsRestClient</span><span class="p">:</span> <span class="nc">RestHighLevelClient</span><span class="p">,</span>
    <span class="p">):</span> <span class="nc">BulkProcessor</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">bulkAsync</span> <span class="p">=</span> <span class="p">{</span>
                <span class="n">request</span><span class="p">:</span> <span class="nc">BulkRequest</span><span class="p">,</span> <span class="n">listener</span><span class="p">:</span> <span class="nc">ActionListener</span><span class="p">&lt;</span><span class="nc">BulkResponse</span><span class="p">&gt;</span> <span class="p">-&gt;</span>
            <span class="n">highLevelEsRestClient</span><span class="p">.</span><span class="nf">bulkAsync</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nc">RequestOptions</span><span class="p">.</span><span class="nc">DEFAULT</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span>
            <span class="nc">Unit</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nc">BulkProcessor</span>
            <span class="p">.</span><span class="nf">builder</span><span class="p">(</span><span class="n">bulkAsync</span><span class="p">,</span> <span class="nc">MyEsBulkListener</span><span class="p">(),</span> <span class="s">"myBulkProcessor"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">setBulkActions</span><span class="p">(</span><span class="mi">50000</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">setBulkSize</span><span class="p">(</span><span class="nc">ByteSizeValue</span><span class="p">.</span><span class="nf">ofMb</span><span class="p">(</span><span class="mi">50L</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">setFlushInterval</span><span class="p">(</span><span class="nc">TimeValue</span><span class="p">.</span><span class="nf">timeValueMillis</span><span class="p">(</span><span class="mi">5000L</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">setConcurrentRequests</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">setBackoffPolicy</span><span class="p">(</span><span class="nc">BackoffPolicy</span><span class="p">.</span><span class="nf">exponentialBackoff</span><span class="p">())</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createBaseRestClientBuilder</span><span class="p">():</span> <span class="nc">RestClientBuilder</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">RestClient</span>
            <span class="p">.</span><span class="nf">builder</span><span class="p">(</span>
                <span class="nc">HttpHost</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">9200</span><span class="p">,</span> <span class="s">"http"</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">setRequestConfigCallback</span> <span class="p">{</span>
                <span class="n">it</span><span class="p">.</span><span class="nf">setConnectTimeout</span><span class="p">(</span><span class="nc">ES_CONNECTION_TIMEOUT</span><span class="p">)</span>
                <span class="n">it</span><span class="p">.</span><span class="nf">setSocketTimeout</span><span class="p">(</span><span class="nc">ES_SOCKET_TIMEOUT</span><span class="p">)</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="고수준--rest-client-사용"><span class="mr-2">고수준 Rest Client 사용</span><a href="#고수준--rest-client-사용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">HighLevelEsService</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">highLevelEsRestClient</span><span class="p">:</span> <span class="nc">RestHighLevelClient</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">bulkProcessor</span><span class="p">:</span> <span class="nc">BulkProcessor</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">:</span> <span class="nc">KLogging</span><span class="p">()</span>

    <span class="k">fun</span> <span class="nf">getSample</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">req</span> <span class="p">=</span> <span class="nc">GetRequest</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="s">"my-index-01"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"document-id-01"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"abc123"</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">res</span> <span class="p">=</span> <span class="n">highLevelEsRestClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="nc">RequestOptions</span><span class="p">.</span><span class="nc">DEFAULT</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] res : $res"</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">.</span><span class="n">sourceAsString</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">searchSample</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Any</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">queryBuilder</span> <span class="p">=</span> <span class="nc">QueryBuilders</span><span class="p">.</span><span class="nf">boolQuery</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">must</span><span class="p">(</span><span class="nc">TermQueryBuilder</span><span class="p">(</span><span class="s">"filedOne"</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">should</span><span class="p">(</span><span class="nc">MatchQueryBuilder</span><span class="p">(</span><span class="s">"filedTwo"</span><span class="p">,</span> <span class="s">"hello world"</span><span class="p">).</span><span class="k">operator</span><span class="p">(</span><span class="nc">Operator</span><span class="p">.</span><span class="nc">AND</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">should</span><span class="p">(</span><span class="nc">RangeQueryBuilder</span><span class="p">(</span><span class="s">"filedThree"</span><span class="p">).</span><span class="nf">gte</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">lt</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">minimumShouldMatch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">searchSourceBuilder</span> <span class="p">=</span> <span class="nc">SearchSourceBuilder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">from</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">queryBuilder</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">searchRequest</span> <span class="p">=</span> <span class="nc">SearchRequest</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">indices</span><span class="p">(</span><span class="s">"my-index-01"</span><span class="p">,</span> <span class="s">"my-index-02"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"abc123"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">searchSourceBuilder</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">res</span> <span class="p">=</span> <span class="n">highLevelEsRestClient</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">searchRequest</span><span class="p">,</span> <span class="nc">RequestOptions</span><span class="p">.</span><span class="nc">DEFAULT</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] res : $res"</span> <span class="p">}</span>
        <span class="kd">val</span> <span class="py">searchHits</span> <span class="p">=</span> <span class="n">res</span><span class="p">.</span><span class="n">hits</span>
        <span class="kd">val</span> <span class="py">totalHits</span> <span class="p">=</span> <span class="n">searchHits</span><span class="p">.</span><span class="n">totalHits</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] totalHits : $totalHits"</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">searchHits</span>
            <span class="p">.</span><span class="n">hits</span>
            <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">sourceAsMap</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">bulk</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">bulkRequest</span> <span class="p">=</span> <span class="nc">BulkRequest</span><span class="p">()</span>
        <span class="n">bulkRequest</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span>
            <span class="nc">UpdateRequest</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="s">"my-index-01"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"document-id-01"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"abc123"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">doc</span><span class="p">(</span><span class="nf">mapOf</span><span class="p">(</span><span class="s">"hello"</span> <span class="n">to</span> <span class="s">"elasticsearch"</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="kd">val</span> <span class="py">bulkResponse</span> <span class="p">=</span> <span class="n">highLevelEsRestClient</span><span class="p">.</span><span class="nf">bulk</span><span class="p">(</span><span class="n">bulkRequest</span><span class="p">,</span> <span class="nc">RequestOptions</span><span class="p">.</span><span class="nc">DEFAULT</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bulkResponse</span><span class="p">.</span><span class="nf">hasFailures</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s">"[ES_TEST] ${bulkResponse.buildFailureMessage()}"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">bulkResponse</span><span class="p">.</span><span class="n">items</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] bulkResponse : ${ToStringBuilder.reflectionToString(bulkResponse)} "</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">bulkProcessor</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">source</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Any</span><span class="p">&gt;(</span>
            <span class="s">"hello"</span> <span class="n">to</span> <span class="s">"world"</span><span class="p">,</span>
            <span class="s">"world"</span> <span class="n">to</span> <span class="mi">123</span><span class="p">,</span>
            <span class="s">"name"</span> <span class="n">to</span> <span class="s">"name-$id"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="kd">val</span> <span class="py">indexRequest</span> <span class="p">=</span> <span class="nc">IndexRequest</span><span class="p">(</span><span class="s">"my-index-01"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"abc123"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nc">XContentType</span><span class="p">.</span><span class="nc">JSON</span><span class="p">)</span>

        <span class="n">bulkProcessor</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">indexRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>ES Rest API를 호출할때 body로 전달했던 내용들을 Builder Pattern을 제공해준다.<li>저수준 RestClient 보다 훨씬 직관적이고, 추상화된 API를 제공하고 있다.</ul><h4 id="bulk-api-호출하기"><span class="mr-2">bulk API 호출하기</span><a href="#bulk-api-호출하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>위에 구현한 <code class="language-plaintext highlighter-rouge">HighLevelEsService</code>의 내용을 참고하면 BulkRequest 라는 클래스를 통해 bulk 처리를 하는 방법과 BulkProcessor을 통해 처리하는 2가지 방법을 제공한다.</ul><h4 id="bulkprocessor-관련"><span class="mr-2">BulkProcessor 관련</span><a href="#bulkprocessor-관련" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>BulkProcessor는 필요한 bulk 처리에 대해서 add하게 되면 BulkProssor가 지정된 기준에 맞춰 bulk 요청을 만들어서 보낸다.<ul><li>이런 과정을 BulkProcessor가 flush한다고 표현한다.</ul></ul><h4 id="bulkprocessor-thread-safety-관련"><span class="mr-2">BulkProcessor thread-safety 관련</span><a href="#bulkprocessor-thread-safety-관련" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>개발/테스트하는 과정에서 BulkProcessor을 Spring bean으로 등록하고 사용할수 있는지에 대해서 확인(thread-safety)<ul><li>핵심적인 내용은 아래 코드를 참고할수 있는데, bulk 대상을 add할때 lock을 활용하고 있는것으로 보임.<li>그래서 thread-safety를 보장할수 있을것으로 보임<li>다만, bulkProcessor 특성상 bulk 처리를 내부에서 알아서 처리하므로, 실시간으로 사용자의 응답으로 서빙하는 케이스에서는 사용을 지양하는것이 맞지 않을까 생각됨.</ul></ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="cm">/**
 * A bulk processor is a thread safe bulk processing class, allowing to easily set when to "flush" a new bulk request
 * (either based on number of actions, based on the size, or time), and to easily control the number of concurrent bulk
 * requests allowed to be executed in parallel.
 * &lt;p&gt;
 * In order to create a new bulk processor, use the {@link Builder}.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BulkProcessor</span> <span class="kd">implements</span> <span class="nc">Closeable</span> <span class="o">{</span>
<span class="c1">// ...(중략)</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">internalAdd</span><span class="o">(</span><span class="nc">DocWriteRequest</span><span class="o">&lt;?&gt;</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// bulkRequest and instance swapping is not threadsafe, so execute the mutations under a lock.</span>
        <span class="c1">// once the bulk request is ready to be shipped swap the instance reference unlock and send the local reference to the handler.</span>
        <span class="nc">Tuple</span><span class="o">&lt;</span><span class="nc">BulkRequest</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">bulkRequestToExecute</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ensureOpen</span><span class="o">();</span>
            <span class="n">bulkRequest</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="n">bulkRequestToExecute</span> <span class="o">=</span> <span class="n">newBulkRequestIfNeeded</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// execute sending the local reference outside the lock to allow handler to control the concurrency via it's configuration.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bulkRequestToExecute</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">execute</span><span class="o">(</span><span class="n">bulkRequestToExecute</span><span class="o">.</span><span class="na">v1</span><span class="o">(),</span> <span class="n">bulkRequestToExecute</span><span class="o">.</span><span class="na">v2</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="bulkprocessorlistener"><span class="mr-2">BulkProcessor.Listener</span><a href="#bulkprocessorlistener" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MyEsBulkListener</span> <span class="p">:</span> <span class="nc">BulkProcessor</span><span class="p">.</span><span class="nc">Listener</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">:</span> <span class="nc">KLogging</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">beforeBulk</span><span class="p">(</span><span class="n">executionId</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nc">BulkRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] before bulk"</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">afterBulk</span><span class="p">(</span><span class="n">executionId</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nc">BulkRequest</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nc">BulkResponse</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">response</span><span class="p">.</span><span class="nf">hasFailures</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] bulk success"</span> <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span> <span class="p">{</span> <span class="s">"[ES_TEST] bulk failures"</span> <span class="p">}</span>
            <span class="kd">val</span> <span class="py">failedItems</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">items</span>
                <span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">isFailed</span> <span class="p">}</span>

            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span> <span class="p">{</span> <span class="s">"[ES_TEST] failed items : ${ToStringBuilder.reflectionToString(failedItems)}"</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">afterBulk</span><span class="p">(</span><span class="n">executionId</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nc">BulkRequest</span><span class="p">?,</span> <span class="n">failure</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] after bulk"</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>BulkProcessor에 Listner를 등록하여 처리 과정 중에 전처리/후처리 등을 직접 구현하여 적용할 수 있다.</ul><h4 id="es-8버전에서-고수준-restclient-사용하기"><span class="mr-2">ES 8버전에서 고수준 RestClient 사용하기</span><a href="#es-8버전에서-고수준-restclient-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES에서 고수준 RestClient는 지원 중단을 선언하였고, 더이상 maven repo를 통해 신규 버전이 배포되지 않고 있다.<li>다만, 직접 es code를 checkout 받아서 수동으로 build하면 ES8 버전의 jar을 사용할수도 있다.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># checkout</span>
git clone https://github.com/elastic/elasticsearch.git
git checkout tags/v8.11.1

<span class="c"># build</span>
./gradleew clean :client:rest-high-level:build <span class="nt">-x</span> <span class="nb">test</span>
</pre></table></code></div></div><ul><li>위 빌드 결과물인 <code class="language-plaintext highlighter-rouge">build/distributions/elasticsearch-rest-high-level-client-8.11.1-SNAPSHOT.jar</code> 을 프로젝트에 포함시키면 된다.</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nf">dependencies</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">esVersion</span> <span class="p">=</span> <span class="s">"8.11.1"</span>

    <span class="c1">// 수동 jar 설치 후 적용하는 방식</span>
      <span class="nf">implementation</span><span class="p">(</span><span class="nf">fileTree</span><span class="p">(</span><span class="nf">mapOf</span><span class="p">(</span><span class="s">"dir"</span> <span class="n">to</span> <span class="s">"manual-build"</span><span class="p">,</span> <span class="s">"includes"</span> <span class="n">to</span> <span class="nf">listOf</span><span class="p">(</span><span class="s">"*.jar"</span><span class="p">))))</span>
      <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.elasticsearch:elasticsearch:$esVersion"</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>다만 , 위 방식으로 테스트해보니 elasticsearch 서버 라이브러리를 통쨰로 넣어야 동작을 하는데, IDE에서 많이 힘들어해서 이 방식은 좋은 방법이 아닌것 같다.<li>따라서, 그냥 JavaClient을 사용하는것이 현명해보인다.</ul><h3 id="453-자바-클라이언트"><span class="mr-2">4.5.3 자바 클라이언트</span><a href="#453-자바-클라이언트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>ES 7.15버전부터 출시되었고, 기존의 고수준 restClient을 대체하게 된 클라이언트이다.(2021.9월 최초 출시)<li>8 이상을 사용한다면 고수준 restClient와 혼용하더라도 점진적으로 새 자바 클라이언트를 도입하는 것이 좋다.<li>아직은 초기라서 고수준 restClient에 비해 불편함이 있을수 있는데 이 부분을 감안해서 선택하는것이 좋다.</ul><h4 id="자바-클라이언트의-초기화"><span class="mr-2">자바 클라이언트의 초기화</span><a href="#자바-클라이언트의-초기화" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nf">dependencies</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">esVersion</span> <span class="p">=</span> <span class="s">"8.11.1"</span>
    <span class="kd">val</span> <span class="py">esHighLevelClientVersion</span> <span class="p">=</span> <span class="s">"7.17.16"</span>

    <span class="c1">// es 저수준 rest client</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.elasticsearch.client:elasticsearch-rest-client:$esVersion"</span><span class="p">)</span>
    <span class="c1">// es 고수준 rest client</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.elasticsearch.client:elasticsearch-rest-high-level-client:$esHighLevelClientVersion"</span><span class="p">)</span>
    <span class="c1">// java client</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"co.elastic.clients:elasticsearch-java:$esVersion"</span><span class="p">)</span>

<span class="p">}</span>
</pre></table></code></div></div><ul><li>위와 같이 <code class="language-plaintext highlighter-rouge">java client</code> 디펜던시 설정을 추가해준다.</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">EsConfig</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">objectMapper</span><span class="p">:</span> <span class="nc">ObjectMapper</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">ES_CONNECTION_TIMEOUT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// 5s</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">ES_SOCKET_TIMEOUT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// 5s</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">CLIENT_BUFFER_SIZE</span> <span class="p">=</span> <span class="mi">500</span> <span class="p">*</span> <span class="mi">1024</span> <span class="p">*</span> <span class="mi">1024</span> <span class="c1">// 500MB</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"lowLevelEsRestClient"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">lowLevelEsRestClient</span><span class="p">():</span> <span class="nc">RestClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">createBaseRestClientBuilder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"esJavaClient"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">esJavaClient</span><span class="p">(</span>
        <span class="nd">@Qualifier</span><span class="p">(</span><span class="s">"lowLevelEsRestClient"</span><span class="p">)</span> <span class="n">lowLevelEsRestClient</span><span class="p">:</span> <span class="nc">RestClient</span><span class="p">,</span>
    <span class="p">):</span> <span class="nc">ElasticsearchClient</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">restClientOptions</span> <span class="p">=</span> <span class="nc">RestClientOptions</span><span class="p">(</span>
            <span class="nc">RequestOptions</span><span class="p">.</span><span class="nc">DEFAULT</span>
                <span class="p">.</span><span class="nf">toBuilder</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">setHttpAsyncResponseConsumerFactory</span><span class="p">(</span>
                    <span class="nc">HttpAsyncResponseConsumerFactory</span><span class="p">.</span><span class="nc">HeapBufferedResponseConsumerFactory</span><span class="p">(</span><span class="nc">CLIENT_BUFFER_SIZE</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="p">.</span><span class="nf">build</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="kd">val</span> <span class="py">transport</span> <span class="p">=</span> <span class="nc">RestClientTransport</span><span class="p">(</span><span class="n">lowLevelEsRestClient</span><span class="p">,</span> <span class="nc">JacksonJsonpMapper</span><span class="p">(</span><span class="n">objectMapper</span><span class="p">),</span> <span class="n">restClientOptions</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">ElasticsearchClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="k">fun</span> <span class="nf">bulkIngester</span><span class="p">(</span>
        <span class="nd">@Qualifier</span><span class="p">(</span><span class="s">"esJavaClient"</span><span class="p">)</span> <span class="n">esJavaClient</span><span class="p">:</span> <span class="nc">ElasticsearchClient</span><span class="p">,</span>
    <span class="p">):</span> <span class="nc">BulkIngester</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">listener</span> <span class="p">=</span> <span class="nc">StringBulkIngestListener</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;()</span>
        <span class="k">return</span> <span class="nc">BulkIngester</span><span class="p">.</span><span class="nf">of</span> <span class="p">{</span>
            <span class="n">it</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="n">esJavaClient</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">maxOperations</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">maxConcurrentRequests</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">maxSize</span><span class="p">(</span><span class="mi">5</span> <span class="p">*</span> <span class="mi">1024</span> <span class="p">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="c1">// 5MB</span>
                <span class="p">.</span><span class="nf">flushInterval</span><span class="p">(</span><span class="mi">5L</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">SECONDS</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">listener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"highLevelEsRestClient"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">highLevelEsRestClient</span><span class="p">(</span>
        <span class="nd">@Qualifier</span><span class="p">(</span><span class="s">"lowLevelEsRestClient"</span><span class="p">)</span> <span class="n">lowLevelEsRestClient</span><span class="p">:</span> <span class="nc">RestClient</span><span class="p">,</span>
    <span class="p">):</span> <span class="nc">RestHighLevelClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">RestHighLevelClientBuilder</span><span class="p">(</span><span class="n">lowLevelEsRestClient</span><span class="p">)</span>
            <span class="c1">// NOTE es 8 이상일 경우 서버 호환을 위해 true로 설정</span>
            <span class="p">.</span><span class="nf">setApiCompatibilityMode</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createBaseRestClientBuilder</span><span class="p">():</span> <span class="nc">RestClientBuilder</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">RestClient</span>
            <span class="p">.</span><span class="nf">builder</span><span class="p">(</span>
                <span class="nc">HttpHost</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">9200</span><span class="p">,</span> <span class="s">"http"</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">setRequestConfigCallback</span> <span class="p">{</span>
                <span class="n">it</span><span class="p">.</span><span class="nf">setConnectTimeout</span><span class="p">(</span><span class="nc">ES_CONNECTION_TIMEOUT</span><span class="p">)</span>
                <span class="n">it</span><span class="p">.</span><span class="nf">setSocketTimeout</span><span class="p">(</span><span class="nc">ES_SOCKET_TIMEOUT</span><span class="p">)</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>spring application configuration은 위와 같이 설정할 수 있다.<li>위 예시는 책 예제를 기반으로 작성한것으로 고수준 RestClient와 JavaClient 모두를 사용하는 방식으로 작성되어있는데 상황에 따라 적절히 선택하면 된다.</ul><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nd">@SpringBootApplication</span><span class="p">(</span>
    <span class="n">scanBasePackages</span> <span class="p">=</span> <span class="p">[</span>
        <span class="s">"com.starter.es"</span><span class="p">,</span>
        <span class="s">"com.starter.core.common"</span><span class="p">,</span>
        <span class="s">"com.starter.core.jasypt"</span><span class="p">,</span>
        <span class="s">"com.starter.core.security"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">exclude</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nc">DataSourceAutoConfiguration</span><span class="o">::</span><span class="k">class</span><span class="p">,</span>
        <span class="nc">DataSourceTransactionManagerAutoConfiguration</span><span class="o">::</span><span class="k">class</span><span class="p">,</span>
        <span class="nc">HibernateJpaAutoConfiguration</span><span class="o">::</span><span class="k">class</span><span class="p">,</span>
        <span class="nc">ElasticsearchClientAutoConfiguration</span><span class="o">::</span><span class="k">class</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="kd">class</span> <span class="nc">EsApplication</span>

<span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="n">runApplication</span><span class="p">&lt;</span><span class="nc">EsApplication</span><span class="p">&gt;(*</span><span class="n">args</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>application 설정시 <code class="language-plaintext highlighter-rouge">ElasticsearchClientAutoConfiguration::class</code>을 exclude를 해주어야 한다.<li>spring auto configuration을 사용한다면 위 설정 말고도 적절히 라이브러리 디펜던시 추가가 필요하고, bean 설정도 변경이 필요할것이다.<ul><li>개인적으로는 auto configuration보다는 직접 bean 정의를 하는것이 명확해서 좋은 것 같음.</ul></ul><h4 id="자바-클라이언트-사용하기"><span class="mr-2">자바 클라이언트 사용하기</span><a href="#자바-클라이언트-사용하기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span data-label-text="Kotlin"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">EsJavaClientService</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">elasticsearchClient</span><span class="p">:</span> <span class="nc">ElasticsearchClient</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">bulkIngester</span><span class="p">:</span> <span class="nc">BulkIngester</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">:</span> <span class="nc">KLogging</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">INDEX_NAME</span> <span class="p">=</span> <span class="s">"my-index"</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">indexExample</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">indexRequest</span> <span class="p">=</span> <span class="nc">IndexRequest</span><span class="p">.</span><span class="nc">Builder</span><span class="p">&lt;</span><span class="nc">MyIndexClass</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"my-id-1"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"my-routing-1"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">document</span><span class="p">(</span><span class="nc">MyIndexClass</span><span class="p">(</span><span class="s">"hello"</span><span class="p">,</span> <span class="mi">1L</span><span class="p">,</span> <span class="nf">createNow</span><span class="p">()))</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">elasticsearchClient</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">indexRequest</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] response : $response , resultName : ${result.name}"</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="nf">toString</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">getSample</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">MyIndexClass</span><span class="p">?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">getRequest</span> <span class="p">=</span> <span class="nc">GetRequest</span><span class="p">.</span><span class="nc">Builder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"my-routing-1"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">elasticsearchClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">getRequest</span><span class="p">,</span> <span class="nc">MyIndexClass</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">source</span><span class="p">()</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] response : $response , result : $result"</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">bulk</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">createOperation</span> <span class="p">=</span> <span class="nc">CreateOperation</span><span class="p">.</span><span class="nc">Builder</span><span class="p">&lt;</span><span class="nc">MyIndexClass</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"my-id-2"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"my-routing-2"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">document</span><span class="p">(</span><span class="nc">MyIndexClass</span><span class="p">(</span><span class="s">"world"</span><span class="p">,</span> <span class="mi">2L</span><span class="p">,</span> <span class="nf">createNow</span><span class="p">()))</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">indexOperation</span> <span class="p">=</span> <span class="nc">IndexOperation</span><span class="p">.</span><span class="nc">Builder</span><span class="p">&lt;</span><span class="nc">MyIndexClass</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"my-id-3"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"my-routing-3"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">document</span><span class="p">(</span><span class="nc">MyIndexClass</span><span class="p">(</span><span class="s">"world"</span><span class="p">,</span> <span class="mi">4L</span><span class="p">,</span> <span class="nf">createNow</span><span class="p">()))</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">updateAction</span> <span class="p">=</span> <span class="nc">UpdateAction</span><span class="p">.</span><span class="nc">Builder</span><span class="p">&lt;</span><span class="nc">MyIndexClass</span><span class="p">,</span> <span class="nc">MyPartialIndexClass</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">doc</span><span class="p">(</span><span class="nc">MyPartialIndexClass</span><span class="p">(</span><span class="s">"world updated"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">updateOperation</span> <span class="p">=</span> <span class="nc">UpdateOperation</span><span class="p">.</span><span class="nc">Builder</span><span class="p">&lt;</span><span class="nc">MyIndexClass</span><span class="p">,</span> <span class="nc">MyPartialIndexClass</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"my-id-1"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"my-routing-1"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="n">updateAction</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">bulkOpOne</span> <span class="p">=</span> <span class="nc">BulkOperation</span><span class="p">.</span><span class="nc">Builder</span><span class="p">().</span><span class="nf">create</span><span class="p">(</span><span class="n">createOperation</span><span class="p">).</span><span class="nf">build</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">bulkOpTwo</span> <span class="p">=</span> <span class="nc">BulkOperation</span><span class="p">.</span><span class="nc">Builder</span><span class="p">().</span><span class="nf">index</span><span class="p">(</span><span class="n">indexOperation</span><span class="p">).</span><span class="nf">build</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">bulkOpThree</span> <span class="p">=</span> <span class="nc">BulkOperation</span><span class="p">.</span><span class="nc">Builder</span><span class="p">().</span><span class="nf">update</span><span class="p">(</span><span class="n">updateOperation</span><span class="p">).</span><span class="nf">build</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">operations</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">&lt;</span><span class="nc">BulkOperation</span><span class="p">&gt;(</span><span class="n">bulkOpOne</span><span class="p">,</span> <span class="n">bulkOpTwo</span><span class="p">,</span> <span class="n">bulkOpThree</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">bulkResponse</span> <span class="p">=</span> <span class="n">elasticsearchClient</span><span class="p">.</span><span class="nf">bulk</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">operations</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span> <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">item</span> <span class="k">in</span> <span class="n">bulkResponse</span><span class="p">.</span><span class="nf">items</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] results : ${item.result()}, error : ${item.error()}"</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">search</span><span class="p">(</span><span class="n">fieldOneValue</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">MyIndexClass</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">searchRequest</span> <span class="p">=</span> <span class="nc">SearchRequest</span><span class="p">.</span><span class="nc">Builder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">from</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">query</span> <span class="p">{</span> <span class="n">q</span> <span class="p">-&gt;</span>
                <span class="n">q</span><span class="p">.</span><span class="nf">term</span> <span class="p">{</span> <span class="n">t</span> <span class="p">-&gt;</span>
                    <span class="n">t</span><span class="p">.</span><span class="nf">field</span><span class="p">(</span><span class="s">"fieldOne"</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">value</span> <span class="p">{</span> <span class="n">v</span> <span class="p">-&gt;</span> <span class="n">v</span><span class="p">.</span><span class="nf">stringValue</span><span class="p">(</span><span class="n">fieldOneValue</span><span class="p">)</span> <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">elasticsearchClient</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">searchRequest</span><span class="p">,</span> <span class="nc">MyIndexClass</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">hits</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">hits</span><span class="p">().</span><span class="nf">hits</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">item</span> <span class="k">in</span> <span class="n">hits</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] source : ${item.source()}"</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">hits</span><span class="p">.</span><span class="nf">mapNotNull</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">source</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">bulkWithIngester</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">startDatetime</span> <span class="p">=</span> <span class="nc">LocalDateTime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">epochSecond</span> <span class="p">=</span> <span class="n">startDatetime</span><span class="p">.</span><span class="nf">toEpochSecond</span><span class="p">(</span><span class="nc">ZoneOffset</span><span class="p">.</span><span class="nc">UTC</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] startEpochSecond : $epochSecond"</span> <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">number</span> <span class="k">in</span> <span class="mi">0L</span><span class="o">..</span><span class="mi">1000L</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">bulkOperation</span> <span class="p">=</span> <span class="nc">BulkOperation</span><span class="p">.</span><span class="nf">of</span> <span class="p">{</span> <span class="n">builder</span> <span class="p">-&gt;</span>
                <span class="n">builder</span><span class="p">.</span><span class="nf">index</span> <span class="p">{</span> <span class="n">indexOpBUilder</span> <span class="p">-&gt;</span>
                    <span class="n">indexOpBUilder</span>
                        <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"my-id-$number"</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"my-routing-$number"</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">document</span><span class="p">(</span><span class="nc">MyIndexClass</span><span class="p">(</span><span class="s">"world"</span><span class="p">,</span> <span class="nf">concatNumber</span><span class="p">(</span><span class="n">epochSecond</span><span class="p">,</span> <span class="n">number</span><span class="p">),</span> <span class="nf">createNow</span><span class="p">()))</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">bulkIngester</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">bulkOperation</span><span class="p">,</span> <span class="s">"my-context-$number"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] [${LocalDateTime.now()}] sleep 10 seconds ..."</span> <span class="p">}</span>
        <span class="nc">Thread</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10000L</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">number</span> <span class="k">in</span> <span class="mi">1001L</span><span class="o">..</span><span class="mi">1500L</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">bulkOperation</span> <span class="p">=</span> <span class="nc">BulkOperation</span><span class="p">.</span><span class="nf">of</span> <span class="p">{</span> <span class="n">builder</span> <span class="p">-&gt;</span>
                <span class="n">builder</span><span class="p">.</span><span class="nf">index</span> <span class="p">{</span> <span class="n">indexOpBUilder</span> <span class="p">-&gt;</span>
                    <span class="n">indexOpBUilder</span>
                        <span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nc">INDEX_NAME</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">id</span><span class="p">(</span><span class="s">"my-id-$number"</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">routing</span><span class="p">(</span><span class="s">"my-routing-$number"</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">document</span><span class="p">(</span><span class="nc">MyIndexClass</span><span class="p">(</span><span class="s">"world"</span><span class="p">,</span> <span class="nf">concatNumber</span><span class="p">(</span><span class="n">epochSecond</span><span class="p">,</span> <span class="n">number</span><span class="p">),</span> <span class="nf">createNow</span><span class="p">()))</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">bulkIngester</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">bulkOperation</span><span class="p">,</span> <span class="s">"my-context-$number"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] [${LocalDateTime.now()}] sleep 10 seconds ..."</span> <span class="p">}</span>
        <span class="nc">Thread</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10000L</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="p">{</span> <span class="s">"[ES_TEST] It's completed."</span> <span class="p">}</span>

        <span class="c1">// bean이므로 굳이 닫지않음.</span>
        <span class="c1">// bulkIngester.close()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createNow</span><span class="p">()</span> <span class="p">=</span> <span class="nc">ZonedDateTime</span><span class="p">.</span><span class="nf">now</span><span class="p">(</span><span class="nc">ZoneOffset</span><span class="p">.</span><span class="nc">UTC</span><span class="p">)</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">concatNumber</span><span class="p">(</span><span class="n">baseNumber</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nc">Long</span><span class="p">):</span> <span class="nc">Long</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">String</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="s">"%d%04d"</span><span class="p">,</span> <span class="n">baseNumber</span><span class="p">,</span> <span class="n">number</span><span class="p">).</span><span class="nf">toLong</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>위 예시에는 단건문서 색인, 조회, bulk API 호출, search, bulkIngester 사용하는 예제까지 모두 포함되어있다.</ul><h4 id="javaclient의-주요-특징"><span class="mr-2">JavaClient의 주요 특징</span><a href="#javaclient의-주요-특징" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>라이브러리 코드를 살펴보면 java 8부터 지원하는 Function을 잘 지원하고 있다.<ul><li>책에서는 람다의 깊이를 <code class="language-plaintext highlighter-rouge">_0, _1, _2 ...</code>와 같은 방식으로 표현하라고 되어있으나 이는 가독성에 좋은 방법이 아니라고 생각된다.<li>이때 Function도 적당히 사용해야 가독성이 좋으니 가독성을 유지할수 있는 적당한 수준으로 작성하자.<li>Function 사용 대신 실제 Builder 클래스를 build()하는 방식으로도 구현 가능하다.</ul><li>Operation을 처리할떄 Generic Type을 지원하는 것이 주된 특징이다.<ul><li>기존 고수준 restClient에서는 이런 타입 핸들링이 불가능했던것으로 보이고, 이걸 역직렬화 처리를 Map 또는 JsonString으로부터 해줬어야 했으나 이런 부분이 개선된 부분인것 같다.</ul></ul><h4 id="bulkingester-사용-관련"><span class="mr-2">BulkIngester 사용 관련</span><a href="#bulkingester-사용-관련" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>ES 8.7 버전부터 JavaClient에서 Bulk 처리를 위한 BulkIngester가 추가되었다.<li>maxOperations, maxConcurrentRequests, maxSize, flushInterval 등의 builder 메소드를 사용해서 bulk API 처리 정책을 정할 수 있다.<li>고수준 RestClient의 BulkProcessor처럼 Listener을 지정하여 전/후처리에 대한 동작을 정의할 수 있다.<li>BulkProcessor와 다르게 Generic을 지원한다.<ul><li>그래서 인덱스 클래스 타입을 지정하여 특정 인덱스에 대한 타입 안정성을 가져갈수 있겠으나, 이런 경우 범용성은 떨어질수 있을것 같다.<li>필요에 따라서 판단해야겠지만 범용적인 하나의 BulkIngester을 사용해야 한다면 Generic Type을 String으로 지정하여 사용할 수 있을것 같다.</ul></ul><h4 id="bulkingester-thread-safety"><span class="mr-2">BulkIngester thread-safety</span><a href="#bulkingester-thread-safety" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>BulkIngester도 개발/테스트 과정에서 확인해보니 thread-safety를 보장하여 spring bean으로 등록하고 사용하는것이 문제 없는것으로 확인했다.<li>코드를 확인해보니 add하기 전에 상태를 체크해서 동기화 처리를 하고 있음.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BulkIngester</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">AutoCloseable</span> <span class="o">{</span>

    <span class="c1">// ...(중략)</span>

    <span class="c1">// Synchronization objects</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">FnCondition</span> <span class="n">addCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FnCondition</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">canAddOperation</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">FnCondition</span> <span class="n">sendRequestCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FnCondition</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">canSendRequest</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">FnCondition</span> <span class="n">closeCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FnCondition</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">closedAndFlushed</span><span class="o">);</span>

    <span class="c1">// ...(중략)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="nc">BulkOperation</span> <span class="n">operation</span><span class="o">,</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isClosed</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Ingester has been closed"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">IngesterOperation</span> <span class="n">ingestOp</span> <span class="o">=</span> <span class="nc">IngesterOperation</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">operation</span><span class="o">,</span> <span class="n">client</span><span class="o">.</span><span class="na">_jsonpMapper</span><span class="o">());</span>

        <span class="n">addCondition</span><span class="o">.</span><span class="na">whenReady</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>

    <span class="c1">// ...(중략)</span>
   <span class="o">}</span>


<span class="o">}</span>

<span class="kd">class</span> <span class="nc">FnCondition</span> <span class="o">{</span>

    <span class="c1">// ...(중략)</span>

    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">whenReadyIf</span><span class="o">(</span><span class="nc">BooleanSupplier</span> <span class="n">canRun</span><span class="o">,</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">fn</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">canRun</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">canRun</span><span class="o">.</span><span class="na">getAsBoolean</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">invocations</span><span class="o">++;</span>
            <span class="kt">boolean</span> <span class="n">firstLoop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">ready</span><span class="o">.</span><span class="na">getAsBoolean</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">firstLoop</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">contentions</span><span class="o">++;</span>
                    <span class="n">firstLoop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">condition</span><span class="o">.</span><span class="na">awaitUninterruptibly</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">canRun</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">canRun</span><span class="o">.</span><span class="na">getAsBoolean</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://github.com/sungsu9022/es-study-app/tree/main/elasticsearch/src/main/kotlin/com/starter/es">Github Sample Code</a><ul><li>샘플코드는 위 Repo에서 확인할수 있다.</ul><li><a href="https://discuss.elastic.co/t/bulkprocessor-usage-is-safe/12625">BulkProcessor thread-safety 관련</a><li><a href="https://discuss.elastic.co/t/is-bulkingester-replacement-of-bulk-processor-in-elasticsearch-java-api-thread-safe/344285">BulkIngester thread-safety 관련</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devlog/'>DevLog</a>, <a href='/categories/elasticsearch/'>Elasticsearch</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >Elasticsearch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-3(ES%20Client%20%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC)%20-%20Sungsu's%20Tech%20Blog&url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-3%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-3(ES%20Client%20%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC)%20-%20Sungsu's%20Tech%20Blog&u=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-3%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsungsu9022.github.io%2Fposts%2Fes-bible-4-3%2F&text=[%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%20%EB%B0%94%EC%9D%B4%EB%B8%94]%204.%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%8B%A4%EB%A3%A8%EA%B8%B0%20-3(ES%20Client%20%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC)%20-%20Sungsu's%20Tech%20Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/es-bible-4-3/">[엘라스틱서치 바이블] 4. 데이터 다루기 -3(ES Client 라이브러리)</a><li><a href="/posts/es-bible-4-2/">[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</a><li><a href="/posts/es-bible-2/">[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</a><li><a href="/posts/es-bible-3-1/">[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</a><li><a href="/posts/spark-guide-6/">[스파크 완벽 가이드] 6. 다양한 데이터 타입 다루기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/es-bible-1/"><div class="card-body"> <em class="small" data-ts="1700127840" data-df="ll" > Nov 16, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 1. 엘라스틱 서치 소개</h3><div class="text-muted small"><p> 1. 엘라스틱 서치 소개 Elasticsearch는 2010년 2월 샤이 베논이 아파치의 루씬 라이브러리를 기반으로 만든 분산 검색 엔진 2013년에 데이터를 손쉽게 시각화하는 Kibana와 색인 데이터 수집&amp;amp;변환을 하는 Logstash 프로젝트에 엘라스틱에 합류 엘라스틱서치는 현재 검색 엔진 분야에서 가장 각광받고 있는 시스템이다...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-2/"><div class="card-body"> <em class="small" data-ts="1700218920" data-df="ll" > Nov 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 2. 엘라스틱 서치 기본 동작과 구조</h3><div class="text-muted small"><p> 2. 엘라스틱 서치 기본 동작과 구조 엘라스틱서치의 구조를 어느정도 먼저 이해한 상태에서 상세 내용을 학습해야 전체 학습에 깊이가 생긴다. 이번 장을 마치고 나면 엘라스틱서치가 어떻게 동작하는지 큰 그림을 머릿속에 그릴수 있을것이다. 2.1 엘라스틱서치 기본 동작 빠르게 둘러보기 실습 과정에서는 기본적으로 REST API를 호출해 진...</p></div></div></a></div><div class="card"> <a href="/posts/es-bible-3-1/"><div class="card-body"> <em class="small" data-ts="1700301000" data-df="ll" > Nov 18, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[엘라스틱서치 바이블] 3. 인덱스 설계 - 1</h3><div class="text-muted small"><p> 3. 인덱스 설계 - 1 ES의 인덱스는 아주 세부적인 부분까지 설정으로 제어할 수 있다. 이 설정에 따라 동작과 특성이 매우 달라지므로 인덱스 설계에 신경써야 한다. 맵핑, 필드 타입, 애널라이저 등 핵심적인 설정을 학습해 ES 인덱스에 대한 이해도를 높여보자. 3.1 인덱스 설정 인덱스 생성시 동작에 관한 설정을 지정할 수 있...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/es-bible-4-2/" class="btn btn-outline-primary" prompt="Older"><p>[엘라스틱서치 바이블] 4. 데이터 다루기 -2(집계)</p></a> <a href="/posts/es-bible-5/" class="btn btn-outline-primary" prompt="Newer"><p>[엘라스틱서치 바이블] 5. 서비스 환경에 클러스터 구성</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://sungsu9022.github.io/posts/es-bible-4-3/'; this.page.identifier = '/posts/es-bible-4-3/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://sungsu-parks-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes-in-action/">kubernetes-in-action</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/elasticsearch/">Elasticsearch</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/hands-on-reactive-programming-in-spring-5/">Hands-On Reactive Programming in Spring 5</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/sungsu9022dev">sungsu9022</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-145894105-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-145894105-1'); }); </script>
